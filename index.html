<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="theme-color" content="#1A1A1A">
<title>Brewmie | By Lazy Sous</title>

<!-- Supabase Backend -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600&display=swap" rel="stylesheet">

<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

:root {
    --black: #1A1A1A;
    --charcoal: #2C2C2C;
    --grey-dark: #4A4A4A;
    --grey-medium: #6A6A6A;
    --grey-light: #9A9A9A;
    --white: #FFFFFF;
    --off-white: #F8F9FA;
    --cream: #FAFBFC;
    
    --accent-green: #2D5016;
    --gold: #FFD700;
    --gold-dark: #D4A017;
    
    --perfect: #FFD700;
    --excellent: #2D5016;
    --good: #6A6A6A;
    --poor: #8B0000;
    
    --text-primary: #1A1A1A;
    --text-secondary: #4A4A4A;
    --text-tertiary: #6A6A6A;
    --border: #E1E5E9;
    --border-light: #F0F0F0;
    --shadow: rgba(0,0,0,0.04);
    --shadow-medium: rgba(0,0,0,0.08);
    
    --transition: all 0.2s ease;
    --subtle-shadow: 0 1px 3px rgba(0,0,0,0.06);
    --hover-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

/* Subtle animations */
@keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.brew-table, .card, .insight-card {
    animation: slideIn 0.3s ease;
    box-shadow: var(--subtle-shadow);
    transition: var(--transition);
}

.brew-table:hover, .card:hover {
    box-shadow: var(--hover-shadow);
}

/* Better focus states */
input:focus, select:focus {
    outline: 2px solid var(--accent-green);
    outline-offset: 2px;
}

/* Smoother score animations */
.score-display {
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--cream);
    color: var(--text-primary);
    height: 100vh;
    overflow: hidden;
    line-height: 1.4;
    font-weight: 400;
}

.app {
    height: 100vh;
    max-width: 428px;
    margin: 0 auto;
    background: var(--white);
    display: flex;
    flex-direction: column;
    box-shadow: 0 0 30px var(--shadow-medium);
}

/* Header */
.header {
    background: linear-gradient(135deg, var(--black) 0%, var(--charcoal) 100%);
    color: var(--white);
    padding: 16px 20px 12px;
    flex-shrink: 0;
    text-align: center;
}

.header h1 {
    font-family: 'Inter', sans-serif;
    font-weight: 800;
    font-size: 28px;
    letter-spacing: -0.5px;
    margin-bottom: 2px;
}

.brand-subtitle {
    font-size: 14px;
    color: var(--white);
    margin-top: 2px;
    font-weight: 600;
    font-family: 'Cormorant Garamond', serif;
    letter-spacing: 0.5px;
}

.brand-subtitle a {
    color: var(--white);
    text-decoration: none;
    transition: opacity 0.2s;
}

.brand-subtitle a:hover {
    opacity: 0.8;
}

/* Sub Header */
.sub-header {
    background: var(--off-white);
    color: var(--black);
    padding: 10px 20px;
    flex-shrink: 0;
    text-align: center;
    border-bottom: 1px solid var(--border);
}

.welcome-message {
    font-size: 13px;
    margin-bottom: 4px;
    font-weight: 500;
    color: var(--black);
}

.weather-strip {
    font-size: 11px;
    font-weight: 400;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.2s;
}

.weather-strip:hover {
    color: var(--text-primary);
    background: var(--cream);
    padding: 2px 6px;
    margin: -2px -6px;
    border-radius: 4px;
}

/* Tab Content */
.tab-content {
    flex: 1;
    display: none;
    overflow-y: auto;
    padding: 12px 16px 16px;
}

.tab-content.active { display: flex; flex-direction: column; }

/* Setup Reminder Enhanced */
.setup-reminder {
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    margin-bottom: 12px;
    font-size: 11px;
    color: var(--text-secondary);
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.2s;
}

.setup-reminder:hover {
    border-color: var(--accent-green);
    background: var(--off-white);
}

.dismiss-btn {
    background: var(--grey-light);
    color: var(--white);
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    margin-left: 8px;
}

.dismiss-btn:hover {
    background: var(--grey-dark);
}

/* Maintenance Alert */
.maintenance-alert {
    background: linear-gradient(135deg, #FFF3CD, #FFE8A1);
    border: 1px solid #FFD700;
    border-radius: 12px;
    padding: 12px 14px;
    margin-bottom: 10px;
    font-size: 12px;
    color: #704214;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.15);
    transition: all 0.2s;
}

.maintenance-alert:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.25);
}

.maintenance-alert-icon {
    font-size: 16px;
    margin-right: 8px;
}

/* Setup Tab - Collapsible Cards */
.setup-content {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.collapse-controls {
    display: flex;
    gap: 8px;
    margin-bottom: 12px;
}

.collapse-btn {
    flex: 1;
    padding: 8px 12px;
    background: var(--cream);
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text-secondary);
    font-family: 'Inter', sans-serif;
}

.collapse-btn:hover {
    background: var(--off-white);
    border-color: var(--accent-green);
}

.collapsible-card {
    background: var(--off-white);
    border-radius: 12px;
    border: 1px solid var(--border);
    overflow: hidden;
    margin-bottom: 4px;
}

.card-header {
    padding: 16px;
    background: var(--white);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border);
    transition: all 0.2s;
}

.card-header:hover {
    background: var(--cream);
}

.card-header .expand-icon {
    font-size: 18px;
    transition: transform 0.2s;
    color: var(--text-tertiary);
}

.card-header.expanded .expand-icon {
    transform: rotate(180deg);
}

.card-content {
    padding: 16px;
    display: none;
    background: var(--white);
}

.card-content.expanded {
    display: block;
}

.setup-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
}

.setup-grid-3 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
}

.setup-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 10px;
}

.setup-input {
    width: 100%;
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--white);
    font-size: 14px;
    font-weight: 400;
    font-family: 'Inter', sans-serif;
}

.setup-label {
    display: block;
    font-size: 11px;
    color: var(--text-secondary);
    margin-bottom: 4px;
    font-weight: 500;
}

.option-btn {
    padding: 10px 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--white);
    cursor: pointer;
    text-align: center;
    font-size: 11px;
    font-weight: 500;
    transition: all 0.2s;
    color: var(--text-primary);
    font-family: 'Inter', sans-serif;
}

.option-btn:hover {
    border-color: var(--accent-green);
    background: var(--cream);
}

.option-btn.active {
    border-color: var(--accent-green);
    background: var(--accent-green);
    color: var(--white);
    font-weight: 600;
}

.units-toggle {
    display: flex;
    background: var(--cream);
    border-radius: 6px;
    border: 1px solid var(--border);
    overflow: hidden;
}

.units-toggle button {
    flex: 1;
    padding: 6px 12px;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 11px;
    font-weight: 500;
    transition: all 0.2s;
    font-family: 'Inter', sans-serif;
}

.units-toggle button.active {
    background: var(--accent-green);
    color: var(--white);
    font-weight: 600;
}

.maintenance-row {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 8px;
    align-items: end;
    margin-bottom: 8px;
}

.maintenance-input {
    flex: 1;
}

.today-btn {
    padding: 8px 16px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 600;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--accent-green);
    color: var(--white);
    height: 36px;
    font-family: 'Inter', sans-serif;
}

.today-btn:hover {
    background: var(--black);
}

.maintenance-note {
    font-size: 10px;
    color: var(--text-tertiary);
    margin-top: 4px;
    font-style: italic;
}

.maintenance-note.due {
    color: var(--poor);
    font-weight: 600;
}

.maintenance-note.soon {
    color: var(--gold-dark);
}

/* Validation Alert */
.validation-alert {
    background: #FFF3CD;
    border: 1px solid #FFEAA7;
    border-radius: 6px;
    padding: 8px 12px;
    margin: 8px 0;
    font-size: 11px;
    color: #856404;
    display: none;
}

.validation-alert.show {
    display: block;
}

/* Brew Table - Dynamic Height */
.brew-table {
    background: var(--off-white);
    border-radius: 12px;
    border: 1px solid var(--border);
    overflow: visible;
    margin-bottom: 8px;
    /* No fixed heights - content determines height */
}

.table-header {
    display: grid;
    grid-template-columns: 70px repeat(3, minmax(0, 1fr));
    background: var(--charcoal);
    color: var(--white);
    border-radius: 12px 12px 0 0;
}

.header-cell {
    padding: 12px 8px;
    text-align: center;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    line-height: 1.2;
}

.table-row {
    display: grid;
    grid-template-columns: 70px repeat(3, minmax(0, 1fr));
    border-bottom: 1px solid var(--border-light);
    align-items: center;
    min-height: 55px;
}

.table-row:last-child { border-bottom: none; }

.row-label {
    background: var(--cream);
    color: var(--text-primary);
    font-size: 11px;
    font-weight: 600;
    padding: 10px 6px;
    text-align: center;
    border-right: 1px solid var(--border-light);
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-height: 55px;
    justify-content: center;
}

.row-label-sub {
    font-size: 9px;
    color: var(--text-tertiary);
    font-weight: 400;
}

.table-cell {
    background: var(--white);
    padding: 8px 6px;
    font-size: 13px;
    text-align: center;
    border-right: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 4px;
    min-height: 55px;
}

.table-cell:last-child { border-right: none; }

.input-controls {
    display: flex;
    align-items: center;
    gap: 6px;
    width: 100%;
    justify-content: center;
}

.micro-btn {
    background: var(--grey-dark);
    color: var(--white);
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.micro-btn:hover {
    background: var(--black);
    transform: scale(1.05);
}

.micro-btn.flash-green {
    background: var(--accent-green) !important;
    transform: scale(1.1) !important;
}

.cell-input {
    flex: 1;
    border: none;
    background: transparent;
    text-align: center;
    font-size: 14px;
    font-weight: 400;
    padding: 6px 2px;
    min-width: 35px;
    max-width: 50px;
    font-family: 'Inter', sans-serif;
}

.cell-input:focus { 
    outline: 2px solid var(--accent-green); 
    border-radius: 4px;
}

/* Bold ADJUST column values */
#grind-adjust, #dose-adjust, #volume-adjust, #time-adjust, #tamp-adjust {
    font-weight: 700;
}

/* Tamp Controls */
.tamp-control {
    display: flex;
    align-items: center;
    gap: 6px;
    width: 100%;
    justify-content: center;
}

.spring-tamp-control {
    display: flex;
    align-items: center;
    gap: 6px;
    width: 100%;
    justify-content: center;
}

.spring-tamp-control .cell-input {
    width: 50px !important;
    text-align: center !important;
}

.auto-tamp-control {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-primary);
}

.tamp-symbol {
    font-size: 12px;
    font-weight: 600;
    padding: 4px 8px;
    min-width: 30px;
    text-align: center;
}

.tamp-btn {
    background: var(--grey-dark);
    color: var(--white);
    border: none;
    width: 24px;
    height: 24px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
}

.tamp-btn:hover {
    background: var(--black);
    transform: scale(1.05);
}

/* Control Row */
.control-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    gap: 12px;
}

.session-checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 11px;
    color: var(--text-tertiary);
    padding: 6px 12px;
    background: var(--cream);
    border-radius: 16px;
    border: 1px solid var(--border-light);
    font-weight: 400;
}

.reset-btn {
    background: var(--grey-light);
    color: var(--white);
    border: none;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: 'Inter', sans-serif;
}

.reset-btn:hover {
    background: var(--grey-dark);
}

/* Hero Score - Above Table Post-Brew */
.hero-score {
    background: var(--off-white);
    border-radius: 12px;
    padding: 10px;
    text-align: center;
    margin-bottom: 8px;
    border: 2px solid var(--gold);
    display: none;
}

.hero-score.show {
    display: block;
}

.score-display {
    font-family: 'Inter', sans-serif;
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 2px;
    letter-spacing: -1px;
}

.score-display.perfect { 
    background: linear-gradient(135deg, var(--gold) 0%, #FFC700 100%);
    color: var(--black);
    padding: 6px 14px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
}
.score-display.excellent { 
    background: linear-gradient(135deg, var(--accent-green) 0%, #3D6020 100%);
    color: var(--white);
    padding: 6px 14px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(45, 80, 22, 0.3);
}
.score-display.good { 
    background: linear-gradient(135deg, #4CAF50 0%, #45A049 100%);
    color: var(--white);
    padding: 6px 14px;
    border-radius: 8px;
}
.score-display.okay { 
    background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
    color: var(--white);
    padding: 6px 14px;
    border-radius: 8px;
}
.score-display.poor { 
    background: linear-gradient(135deg, var(--poor) 0%, #660000 100%);
    color: var(--white);
    padding: 6px 14px;
    border-radius: 8px;
}

.score-label {
    font-size: 10px;
    color: var(--text-tertiary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.feedback-message {
    font-size: 12px;
    color: var(--text-secondary);
    font-weight: 500;
    margin-top: 8px;
    padding: 8px 12px;
    background: var(--cream);
    border-radius: 8px;
    line-height: 1.4;
    font-style: italic;
}

/* Taste Button */
.taste-button-section {
    margin-bottom: 8px;
    display: none;
}

.taste-trigger-btn {
    width: 100%;
    background: var(--cream);
    color: var(--text-primary);
    border: 1px solid var(--border);
    padding: 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Inter', sans-serif;
}

.taste-trigger-btn:hover {
    border-color: var(--accent-green);
    background: var(--off-white);
}

/* Apply Adjustments Button */
.apply-button-section {
    margin-bottom: 8px;
    display: none;
}

.apply-button-section[style*="flex"] {
    display: flex !important;
    gap: 8px;
}

.apply-btn, .skip-apply-btn {
    flex: 1;
    background: var(--accent-green);
    color: var(--white);
    border: none;
    padding: 14px;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Inter', sans-serif;
}

.skip-apply-btn {
    background: var(--grey-medium);
}

.skip-apply-btn:hover {
    background: var(--grey-dark);
}

.apply-btn:hover {
    background: var(--black);
    transform: translateY(-1px);
}

/* Brew Button */
.brew-button-section {
    margin-bottom: 8px;
}

.brew-btn {
    width: 100%;
    background: linear-gradient(135deg, var(--black) 0%, var(--charcoal) 100%);
    color: var(--white);
    border: 2px solid var(--gold);
    padding: 18px;
    border-radius: 16px;
    font-size: 18px;
    font-weight: 800;
    cursor: pointer;
    transition: all 0.3s;
    letter-spacing: 1px;
    position: relative;
    overflow: hidden;
    font-family: 'Inter', sans-serif;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
}

.brew-btn:hover {
    background: var(--black);
    color: var(--white);
    border-color: var(--gold);
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(255, 215, 0, 0.2);
}

.brew-btn.brewing {
    background: linear-gradient(45deg, var(--gold), var(--gold-dark), var(--gold));
    background-size: 200% 200%;
    color: var(--black);
    border-color: var(--gold);
    animation: brewingGlow 2s ease-in-out infinite;
}

@keyframes brewingGlow {
    0%, 100% { 
        background-position: 0% 50%; 
        box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
    }
    50% { 
        background-position: 100% 50%; 
        box-shadow: 0 12px 35px rgba(255, 215, 0, 0.5);
    }
}

/* Navigation - BREW tab special styling */
.bottom-nav {
    display: flex;
    background: var(--white);
    border-top: 1px solid var(--border);
    flex-shrink: 0;
    box-shadow: 0 -2px 8px var(--shadow);
}

.nav-item {
    flex: 1;
    padding: 12px 8px;
    background: var(--off-white);
    border: none;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    font-size: 12px;
    color: var(--text-tertiary);
    transition: all 0.2s;
    font-weight: 500;
    position: relative;
}

.nav-item:hover {
    color: var(--text-secondary);
}

.nav-item.active {
    color: var(--accent-green);
    background: var(--white);
    font-weight: 600;
}

/* BREW tab special styling */
.nav-item.brew-nav {
    transition: all 0.2s;
    background: linear-gradient(135deg, var(--charcoal) 0%, var(--black) 100%);
    font-weight: 700;
    color: var(--white);
    position: relative;
    box-shadow: inset 0 -2px 0 var(--gold);
}

.nav-item.brew-nav:hover {
    background: var(--black);
    box-shadow: inset 0 -3px 0 var(--gold);
    transform: translateY(-1px);
}

.nav-item.brew-nav.active {
    background: var(--black);
    color: var(--gold);
    border-bottom: 3px solid var(--gold);
    box-shadow: none;
}

.nav-item.brew-nav .nav-icon {
    color: var(--gold);
}

.nav-icon { font-size: 20px; }

/* Maintenance badge */
.nav-badge {
    position: absolute;
    top: 8px;
    right: calc(50% - 20px);
    background: var(--poor);
    color: var(--white);
    border-radius: 50%;
    width: 8px;
    height: 8px;
}

/* Insights */
.insights-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 16px;
}

.insight-card {
    background: var(--off-white);
    border-radius: 10px;
    padding: 14px;
    text-align: center;
    border: 1px solid var(--border);
}

.insight-number {
    font-family: 'Inter', sans-serif;
    font-size: 22px;
    font-weight: 800;
    color: var(--accent-green);
    margin-bottom: 4px;
}

.insight-label {
    font-size: 10px;
    color: var(--text-tertiary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.card {
    background: var(--off-white);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid var(--border);
    margin-bottom: 12px;
}

.card-title {
    font-size: 15px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: 'Inter', sans-serif;
}

/* Section Headers with Clear Buttons */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.clear-btn {
    background: var(--grey-light);
    color: var(--white);
    border: none;
    padding: 4px 12px;
    border-radius: 16px;
    font-size: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: 'Inter', sans-serif;
}

.clear-btn:hover {
    background: var(--grey-dark);
}

.data-management {
    margin-top: 12px;
}

.reset-all-btn {
    background: var(--poor);
    color: var(--white);
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Inter', sans-serif;
    width: 100%;
    margin-top: 8px;
}

.reset-all-btn:hover {
    background: #660000;
}

/* Recent Performance Fixed Height */
.shot-history-container {
    height: 200px;
    overflow-y: auto;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    background: var(--white);
}

/* Shot History Item */
.shot-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: var(--white);
    border-radius: 8px;
    margin-bottom: 6px;
    border: 1px solid var(--border-light);
    transition: all 0.2s;
    cursor: pointer;
}

.shot-item:hover {
    background: var(--cream);
    border-color: var(--accent-green);
}

.shot-item-info {
    flex: 1;
}

.shot-item-main {
    font-weight: 600;
    font-size: 12px;
    color: var(--text-primary);
}

.shot-item-sub {
    color: var(--text-tertiary);
    font-size: 10px;
    margin-top: 2px;
}

.shot-item-score {
    font-weight: 700;
    font-size: 14px;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.shot-item-taste {
    font-size: 9px;
    color: var(--text-tertiary);
    margin-top: 2px;
}

.rate-badge {
    background: var(--gold);
    color: var(--black);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
}

/* Personal Benchmarks Formatted */
.benchmark-threshold {
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.6;
    margin-bottom: 12px;
    padding: 10px;
    background: var(--cream);
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

.benchmark-list {
    font-size: 11px;
    color: var(--text-secondary);
    line-height: 1.6;
}

.benchmark-item {
    padding: 4px 0;
    font-size: 11px;
    color: var(--text-secondary);
}

/* Custom App Modal */
.app-modal-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2000;
}

.modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
}

.app-modal {
    position: relative;
    max-width: 320px;
    width: 90%;
    background: var(--white);
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

.app-modal.info {
    border-top: 3px solid var(--accent-green);
}

.app-modal.warning {
    border-top: 3px solid var(--gold);
}

.app-modal.error {
    border-top: 3px solid var(--poor);
}

.app-modal.success {
    border-top: 3px solid var(--excellent);
}

.modal-message {
    margin-bottom: 16px;
    font-size: 14px;
    line-height: 1.5;
}

.modal-buttons {
    display: flex;
    gap: 8px;
}

.modal-ok-btn, .modal-cancel-btn, .modal-confirm-btn {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Inter', sans-serif;
}

.modal-ok-btn, .modal-confirm-btn {
    background: var(--accent-green);
    color: var(--white);
}

.modal-cancel-btn {
    background: var(--grey-light);
    color: var(--white);
}

.modal-ok-btn:hover, .modal-confirm-btn:hover {
    background: var(--black);
}

.modal-cancel-btn:hover {
    background: var(--grey-dark);
}

/* Modal - Compact Design */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 1000;
    align-items: center;
    justify-content: center;
}

.modal.show { display: flex; }

.modal-content {
    background: var(--white);
    border-radius: 16px;
    padding: 16px;
    max-width: 90%;
    width: 320px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 14px;
}

.modal-close {
    background: transparent;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--text-tertiary);
    padding: 2px;
    border-radius: 50%;
    transition: all 0.2s;
}

.modal-close:hover {
    background: var(--cream);
    color: var(--text-primary);
}

/* Data Entry Modal */
.data-entry-content {
    text-align: center;
}

.data-entry-title {
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 0;
    color: var(--text-primary);
}

.entry-options {
    display: flex;
    gap: 8px;
    margin-bottom: 14px;
}

.entry-option-btn {
    flex: 1;
    padding: 10px 8px;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: var(--white);
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    transition: all 0.2s;
    color: var(--text-primary);
    font-family: 'Inter', sans-serif;
}

.entry-option-btn:hover {
    border-color: var(--accent-green);
    background: var(--cream);
}

.entry-option-btn.active {
    border-color: var(--accent-green);
    background: var(--accent-green);
    color: var(--white);
}

.manual-inputs {
    display: none;
}

.manual-inputs.show {
    display: block;
}

.input-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
}

.input-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
    min-width: 60px;
    text-align: left;
}

.number-input {
    flex: 1;
    padding: 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--white);
    font-size: 14px;
    font-weight: 600;
    text-align: center;
    font-family: 'Inter', sans-serif;
}

.number-input:focus {
    outline: 2px solid var(--accent-green);
    border-color: var(--accent-green);
}

.timer-section {
    display: none;
    text-align: center;
}

.timer-section.show {
    display: block;
}

.timer-row {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin: 12px 0;
}

.timer-label {
    font-size: 11px;
    font-weight: 600;
    color: var(--text-secondary);
}

.timer-display {
    font-size: 24px;
    font-weight: 800;
    color: var(--accent-green);
    font-family: 'Inter', sans-serif;
}

.timer-controls {
    display: flex;
    gap: 8px;
    justify-content: center;
    margin-bottom: 12px;
}

.timer-btn {
    padding: 6px 16px;
    border: none;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Inter', sans-serif;
}

.timer-btn.start {
    background: var(--accent-green);
    color: var(--white);
}

.timer-btn.stop {
    background: var(--poor);
    color: var(--white);
}

.timer-btn:hover {
    transform: translateY(-1px);
}

.save-data-btn {
    width: 100%;
    background: var(--black);
    color: var(--white);
    border: none;
    padding: 12px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Inter', sans-serif;
    margin-top: 8px;
}

.save-data-btn:hover {
    background: var(--charcoal);
}

/* Enhanced Taste Modal */
.taste-modal .modal-content {
    text-align: center;
}

.taste-scale {
    margin: 20px 0;
    position: relative;
}

.scale-track {
    height: 10px;
    background: linear-gradient(to right, #CD5C5C 0%, #FFA500 25%, #2D5016 50%, #FFA500 75%, #CD5C5C 100%);
    border-radius: 5px;
    position: relative;
    margin: 16px 0;
    cursor: pointer;
}

.scale-handle {
    width: 28px;
    height: 28px;
    background: var(--white);
    border: 3px solid var(--accent-green);
    border-radius: 50%;
    position: absolute;
    top: -9px;
    cursor: pointer;
    transition: all 0.2s;
    left: 50%;
    transform: translateX(-50%);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.scale-handle:hover {
    transform: translateX(-50%) scale(1.1);
    box-shadow: 0 6px 16px rgba(0,0,0,0.2);
}

.scale-labels {
    display: flex;
    justify-content: space-between;
    font-size: 9px;
    color: var(--text-tertiary);
    margin-top: 14px;
    padding: 0 12px;
    font-weight: 500;
}

.taste-value {
    font-size: 18px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 16px 0 8px;
    min-height: 24px;
}

.taste-decimal {
    font-size: 13px;
    color: var(--text-secondary);
    margin-bottom: 6px;
}

.taste-details {
    font-size: 12px;
    color: var(--text-secondary);
    margin-bottom: 20px;
    min-height: 36px;
    line-height: 1.4;
    padding: 0 8px;
}

.taste-buttons {
    display: flex;
    gap: 8px;
    justify-content: center;
    align-items: center;
}

.skip-taste-btn, .rate-taste-btn {
    flex: 1;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Inter', sans-serif;
    border: 2px solid;
}

.skip-taste-btn {
    background: var(--white);
    color: var(--grey-medium);
    border-color: var(--grey-light);
}

.skip-taste-btn:hover {
    background: var(--cream);
    border-color: var(--grey-medium);
}

.rate-taste-btn {
    background: var(--accent-green);
    color: var(--white);
    border-color: var(--accent-green);
}

.rate-taste-btn:hover {
    background: var(--black);
    border-color: var(--black);
}

/* Shot Detail Modal */
.shot-detail-content {
    font-size: 12px;
}

.shot-detail-header {
    background: var(--cream);
    margin: -16px -16px 12px;
    padding: 12px 16px;
    border-radius: 16px 16px 0 0;
}

.shot-detail-number {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
}

.shot-detail-timestamp {
    font-size: 11px;
    color: var(--text-tertiary);
}

.shot-detail-section {
    margin-bottom: 16px;
    padding: 10px;
    background: var(--cream);
    border-radius: 8px;
}

.shot-detail-section-title {
    font-size: 10px;
    font-weight: 600;
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
}

.shot-detail-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
}

.shot-detail-label {
    color: var(--text-secondary);
}

.shot-detail-value {
    font-weight: 600;
    color: var(--text-primary);
}

.shot-detail-notes {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--border);
    border-radius: 6px;
    font-size: 12px;
    font-family: 'Inter', sans-serif;
    resize: vertical;
    min-height: 60px;
}

.shot-detail-actions {
    display: flex;
    gap: 8px;
    margin-top: 12px;
}

.shot-detail-btn {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Inter', sans-serif;
    border: none;
}

.shot-edit-btn {
    background: var(--accent-green);
    color: var(--white);
}

.shot-delete-btn {
    background: var(--poor);
    color: var(--white);
}

.shot-edit-btn:hover {
    background: var(--black);
}

.shot-delete-btn:hover {
    background: #660000;
}

/* Mobile optimization */
@media (max-width: 430px) {
    .table-row { min-height: 48px; }
    .row-label { padding: 8px 4px; font-size: 10px; min-height: 48px; }
    .table-cell { padding: 6px 4px; font-size: 12px; min-height: 48px; }
    .micro-btn { width: 22px; height: 22px; font-size: 13px; }
    .cell-input { font-size: 14px; padding: 4px 2px; min-width: 30px; }
}

/* Footer Styles */
.footer-icons {
    display: flex;
    justify-content: center;
    gap: 12px;
    flex-wrap: wrap;
    margin: 12px 0;
}

.footer-icon {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 8px 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    min-width: 60px;
    font-family: 'Inter', sans-serif;
}

.footer-icon:hover {
    background: var(--cream);
    border-color: var(--accent-green);
    transform: translateY(-2px);
}

.footer-icon-label {
    font-size: 10px;
    color: var(--text-secondary);
    font-weight: 500;
}

.footer-copyright {
    text-align: center;
    font-size: 11px;
    color: var(--text-tertiary);
    margin-top: 12px;
}

.hidden { display: none !important; }

/* Remove number input spinners */
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}

input[type=number] { -moz-appearance: textfield; }

/* Empty state text - consistent sizing */
.empty-state {
    text-align: center;
    color: var(--text-tertiary);
    padding: 20px;
    font-style: italic;
    font-size: 12px; /* Consistent 12px font size */
}
</style>
</head>

<body>
<div class="app">
    <!-- Header -->
    <header class="header">
    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
        <div style="text-align: center; flex: 1;">
            <img src="https://raw.githubusercontent.com/lazysous/logo/main/BM-logo-full-white.png" alt="Brewmie" style="height: 36px; width: auto;">
            <div class="brand-subtitle"><a href="https://lazysous.app" target="_blank">By Lazy Sous</a></div>
        </div>
        <div id="auth-container" style="position: absolute; right: 20px; top: 16px;">
            <div id="signed-out-state">
                <button id="google-sign-in-btn" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                    <span style="font-size: 14px;">ðŸ”’</span>
                    <span>Sign In</span>
                </button>
            </div>
            <div id="signed-in-state" style="display: none;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <img id="user-avatar" src="" alt="Avatar" style="width: 24px; height: 24px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3);">
                    <button id="sign-out-btn" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer;">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </div>
</header>

    <!-- Sub Header -->
    <div class="sub-header">
        <div class="welcome-message" id="welcome-message">Good morning! Ready for perfect coffee?</div>
        <div class="weather-strip" id="weather-strip">Loading weather...</div>
    </div>

    <!-- Set Up Tab -->
    <div class="tab-content" id="setup-tab">
        
        <div class="setup-content">
            <div class="collapse-controls">
                <button class="collapse-btn" onclick="expandAllCards()">Expand All</button>
                <button class="collapse-btn" onclick="collapseAllCards()">Collapse All</button>
            </div>

            <div class="collapsible-card">
                <div class="card-header" onclick="toggleCard(this)">
                    Units
                    <span class="expand-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div class="units-toggle">
                        <button class="active" onclick="toggleUnits('metric')">Metric</button>
                        <button onclick="toggleUnits('imperial')">Imperial</button>
                    </div>
                </div>
            </div>

            <div class="collapsible-card">
                <div class="card-header" onclick="toggleCard(this)">
                    Machine
                    <span class="expand-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div class="setup-row">
                        <div>
                            <label class="setup-label">Brand</label>
                            <select id="machine-brand" class="setup-input" onchange="updateMachineModels()">
                                <option value="breville">Breville</option>
                                <option value="delonghi">DeLonghi</option>
                                <option value="sage">Sage</option>
                                <option value="gaggia">Gaggia</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="setup-label">Model</label>
                            <select id="machine-model" class="setup-input" onchange="updateMachineProfile()">
                                <option value="express">Barista Express</option>
                                <option value="pro">Barista Pro</option>
                                <option value="touch">Barista Touch</option>
                            </select>
                        </div>
                    </div>
                    <div class="setup-row">
                        <div>
                            <label class="setup-label">Basket Size</label>
                            <select id="basket-size" class="setup-input" onchange="updateMachineProfile()">
                                <option value="single">Single (7-9g)</option>
                                <option value="double" selected>Double (16-22g)</option>
                                <option value="triple">Triple (21-25g)</option>
                            </select>
                        </div>
                        <div>
                            <label class="setup-label">Basket Type</label>
                            <select id="basket-type" class="setup-input">
                                <option value="standard">Standard</option>
                                <option value="precision" selected>Precision</option>
                                <option value="bottomless">Bottomless</option>
                            </select>
                        </div>
                    </div>
                    <div class="setup-row">
                        <div>
                            <label class="setup-label">Shot Temperature (<span id="temp-unit-label">Â°C</span>)</label>
                            <input type="number" id="shot-temp" class="setup-input" value="93" min="85" max="96">
                        </div>
                        <div></div>
                    </div>
                </div>
            </div>

            <div class="collapsible-card">
                <div class="card-header" onclick="toggleCard(this)">
                    Grinder
                    <span class="expand-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div class="setup-row">
                        <div>
                            <label class="setup-label">Grinder Type</label>
                            <select id="grinder-type" class="setup-input" onchange="updateGrinderType()">
                                <option value="integrated">Built-in Machine Grinder</option>
                                <option value="standalone">Separate Grinder</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="standalone-grinder-section" style="display: none;">
                        <div class="setup-row">
                            <div>
                                <label class="setup-label">Grinder Brand</label>
                                <div id="standalone-grinder-section" style="display: none;">
                        <div class="setup-row">
                            <div>
                                <label class="setup-label">Grinder Brand</label>
                                <input type="text" id="grinder-brand-input" class="setup-input" placeholder="e.g. Baratza" list="grinder-brands" onchange="updateGrinderBrand()">
                                <datalist id="grinder-brands">
                                    <option value="Baratza">
                                    <option value="Eureka">
                                    <option value="Niche">
                                    <option value="Fellow">
                                    <option value="DF64">
                                    <option value="1Zpresso">
                                    <option value="Comandante">
                                    <option value="Breville">
                                    <option value="Sage">
                                    <option value="Rancilio">
                                </datalist>
                            </div>
                            <div>
                                <label class="setup-label">Grinder Model</label>
                                <input type="text" id="grinder-model-input" class="setup-input" placeholder="e.g. Sette 270Wi" onchange="updateCustomGrinder()">
                            </div>
                        </div>
                        
                        <div class="setup-row">
                            <div>
                                <label class="setup-label">Min Setting</label>
                                <input type="number" id="grind-custom-min" class="setup-input" value="1" min="0" max="999" step="0.1" onchange="updateCustomGrinder()">
                            </div>
                            <div>
                                <label class="setup-label">Max Setting</label>
                                <input type="number" id="grind-custom-max" class="setup-input" value="40" min="1" max="999" step="0.1" onchange="updateCustomGrinder()">
                            </div>
                        </div>
                        
                        <div style="font-size: 10px; color: var(--text-tertiary); text-align: center; margin-top: 8px;">
                            Popular models will auto-fill settings. Custom entries welcome!
                        </div>
                    </div>
                            </div>
                            <div>
                                <label class="setup-label">Grinder Model</label>
                                <select id="grinder-model" class="setup-input" onchange="updateGrinderProfile()">
                                    <option value="">Select model...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="custom-grind-range" style="display: none;">
                            <div class="setup-row">
                                <div>
                                    <label class="setup-label">Min Grind Setting</label>
                                    <input type="number" id="grind-custom-min" class="setup-input" value="1" min="0" max="100">
                                </div>
                                <div>
                                    <label class="setup-label">Max Grind Setting</label>
                                    <input type="number" id="grind-custom-max" class="setup-input" value="50" min="1" max="100">
                                </div>
                            </div>
                            <div style="font-size: 10px; color: var(--text-tertiary); text-align: center; margin-top: 8px;">
                                Enter your grinder's actual min/max settings
                            </div>
                        </div>
                        
                        <div id="grinder-info" style="display: none; margin-top: 12px; padding: 8px; background: var(--cream); border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-secondary);">
                                <span id="grinder-range-info">Range: 1-30</span> â€¢ 
                                <span id="grinder-type-info">Stepped adjustment</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-card">
                <div class="card-header" onclick="toggleCard(this)">
                    Tamper Type
                    <span class="expand-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div class="setup-grid-3">
                        <button class="option-btn active" data-tamp="manual" onclick="selectTampType('manual')">
                            Manual
                        </button>
                        <button class="option-btn" data-tamp="spring" onclick="selectTampType('spring')">
                            Spring-Loaded
                        </button>
                        <button class="option-btn" data-tamp="automatic" onclick="selectTampType('automatic')">
                            Automatic
                        </button>
                    </div>
                    
                    <div id="spring-range-setup" class="spring-range-setup" style="display: none; margin-top: 12px;">
                        <div class="setup-row">
                            <div>
                                <label class="setup-label">Min Setting</label>
                                <input type="number" id="spring-min" class="setup-input" value="0" min="0" max="100">
                            </div>
                            <div>
                                <label class="setup-label">Max Setting</label>
                                <input type="number" id="spring-max" class="setup-input" value="99" min="0" max="100">
                            </div>
                        </div>
                        <div style="font-size: 10px; color: var(--text-tertiary); text-align: center; margin-top: 8px;">
                            Set your tamper's actual min/max range
                        </div>
                    </div>

                    <div id="auto-range-setup" class="auto-range-setup" style="display: none; margin-top: 12px;">
                        <div class="setup-row">
                            <div>
                                <label class="setup-label">Min Pressure</label>
                                <input type="number" id="auto-min" class="setup-input" value="0" min="0" max="50">
                            </div>
                            <div>
                                <label class="setup-label">Max Pressure</label>
                                <input type="number" id="auto-max" class="setup-input" value="30" min="0" max="50">
                            </div>
                        </div>
                        
                        <div style="font-size: 10px; color: var(--text-tertiary); text-align: center; margin-top: 8px;">
                            Configure your automatic/electronic tamper
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-card">
                <div class="card-header" onclick="toggleCard(this)">
                    Beans
                    <span class="expand-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <div class="setup-row">
                        <div>
                            <label class="setup-label">Brand (Optional)</label>
                            <input type="text" id="bean-brand" class="setup-input" placeholder="e.g. Seven Seeds">
                        </div>
                        <div>
                            <label class="setup-label">Type (Optional)</label>
                            <input type="text" id="bean-type" class="setup-input" placeholder="e.g. Single Origin">
                        </div>
                    </div>
                    <div class="setup-row">
    <div>
        <label class="setup-label">Date of Roast</label>
        <input type="date" id="roast-date" class="setup-input" onchange="updateRoastAge()">
        <div id="roast-age" style="font-size: 10px; color: var(--text-tertiary); margin-top: 4px;">Days since roast: --</div>
    </div>
    <div>
        <label class="setup-label">Roast Level</label>
        <select id="roast-select" class="setup-input">
                                <option value="light">Light</option>
                                <option value="medium" selected>Medium</option>
                                <option value="dark">Dark</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="collapsible-card">
                <div class="card-header" onclick="toggleCard(this)">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        Maintenance
                        <span id="maintenance-warning-indicator" style="display: none; background: var(--poor); color: white; font-size: 9px; padding: 2px 6px; border-radius: 10px; font-weight: 600;">!</span>
                    </div>
                    <span class="expand-icon">â–¼</span>
                </div>
                <div class="card-content">
                    <!-- Maintenance Alerts -->
                    <div id="maintenance-alerts" style="margin-bottom: 12px;"></div>
                    <div class="maintenance-row">
                        <div class="maintenance-input">
                            <label class="setup-label">Last Filter Change</label>
                            <input type="date" id="filter-date" class="setup-input">
                            <div class="maintenance-note" id="filter-note">Next due in -- days or -- shots</div>
                        </div>
                        <button class="today-btn" onclick="setMaintenanceToday('filter')">Today</button>
                    </div>
                    <div class="maintenance-row">
                        <div class="maintenance-input">
                            <label class="setup-label">Last Descale</label>
                            <input type="date" id="descale-date" class="setup-input">
                            <div class="maintenance-note" id="descale-note">Next due in -- days or -- shots</div>
                        </div>
                        <button class="today-btn" onclick="setMaintenanceToday('descale')">Today</button>
                    </div>
                    <div class="maintenance-row">
                        <div class="maintenance-input">
                            <label class="setup-label">Last Flush</label>
                            <input type="date" id="flush-date" class="setup-input">
                            <div class="maintenance-note" id="flush-note">Next due in -- days or -- shots</div>
                        </div>
                        <button class="today-btn" onclick="setMaintenanceToday('flush')">Today</button>
                    </div>
                </div>
            </div>
<!-- Footer Section -->
    <div style="margin: 16px 0 8px; text-align: center;">
        <!-- Auth Promo -->
        <div style="text-align: center; padding: 12px; background: var(--cream); border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border);" id="auth-promo-setup">
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">
                <span style="font-size: 16px;">ðŸ”„</span> Keep your brewing data safe
            </div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 8px;">
                Sign in to sync your shots, settings, and insights across all devices
            </div>
            <button onclick="signInWithGoogle()" style="background: var(--accent-green); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer;">
                Sign In with Google
            </button>
        </div>
        
        <a href="https://lazysous.app" target="_blank" style="text-decoration: none; display: inline-flex; align-items: center; gap: 10px; padding: 10px 18px; background: var(--black); border-radius: 18px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <img src="https://raw.githubusercontent.com/lazysous/logo/main/logo-transparent-white.png" alt="Lazy Sous" style="height: 18px; width: auto;">
            <span style="font-size: 13px; color: var(--white); font-weight: 500;">What's for dinner?</span>
            <span style="font-size: 13px; color: var(--gold); font-weight: 600;">Visit Lazy Sous â†’</span>
        </a>
        
        <div class="footer-icons" style="margin-top: 14px;">
            <button class="footer-icon" onclick="window.open('https://www.instagram.com/lazysous.app/', '_blank')" style="background: none; border: none; padding: 6px 12px; cursor: pointer; transition: all 0.2s;">
                <span style="font-size: 18px;">ðŸ“¸</span>
                <span class="footer-icon-label" style="display: block; font-size: 10px; margin-top: 2px;">Follow</span>
            </button>
            <button class="footer-icon" onclick="openSupportModal()" style="background: none; border: none; padding: 6px 12px; cursor: pointer; transition: all 0.2s;">
                <span style="font-size: 18px;">â¤ï¸</span>
                <span class="footer-icon-label" style="display: block; font-size: 10px; margin-top: 2px;">Support</span>
            </button>
            <button class="footer-icon" onclick="openPrivacyModal()" style="background: none; border: none; padding: 6px 12px; cursor: pointer; transition: all 0.2s;">
                <span style="font-size: 18px;">ðŸ¥¸</span>
                <span class="footer-icon-label" style="display: block; font-size: 10px; margin-top: 2px;">Privacy</span>
            </button>
        </div>
        
        <div style="font-size: 10px; color: var(--text-tertiary); margin-top: 10px;">Â© <span class="copyright-year-setup"></span> Lazy Sous.</div>
    </div>
        
        <div style="font-size: 10px; color: var(--text-tertiary); margin-top: 10px;">Â© <span class="copyright-year-setup"></span> Lazy Sous.</div>
    </div>
    
    <script>
    // Auto-update copyright year
    document.querySelector('.copyright-year-setup').textContent = new Date().getFullYear();
    </script>
        </div>
    </div>
    <!-- Brew Tab -->
    <div class="tab-content active" id="brew-tab">
        <!-- Setup Reminder Enhanced -->
        <div class="setup-reminder" id="setup-reminder" style="background: linear-gradient(135deg, #FFF3CD, #FFE8A1); border: 2px solid var(--gold); cursor: pointer;" onclick="switchTab('setup')">
            <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 16px;">âš¡</span>
                    <div>
                        <div style="font-weight: 600; font-size: 12px; color: var(--black); margin-bottom: 2px;">How's your setup?</div>
                        <div style="font-size: 11px; color: #704214;">Set your beans and equpment for best analysis</div>
                    </div>
                </div>
                <button class="dismiss-btn" onclick="dismissSetupReminder(event)" style="background: #704214; flex-shrink: 0;">Ã—</button>
            </div>
        </div>
        
        <!-- Validation Alert -->
        <div class="validation-alert" id="validation-alert"></div>

        <!-- Hero Score Section - Will move above table post-brew -->
        <div class="hero-score" id="hero-score-section">
            <div class="score-display" id="hero-score">--</div>
            <div class="score-label">BREW SCORE</div>
            <div class="feedback-message" id="feedback-message"></div>
        </div>

        <!-- Brew Table -->
        <div class="brew-table" id="brew-table">
            <div class="table-header">
                <div class="header-cell"></div>
                <div class="header-cell">INPUT<br><span style="font-size: 8px; opacity: 0.7;">(target)</span></div>
                <div class="header-cell">BREW<br><span style="font-size: 8px; opacity: 0.7;">(actual)</span></div>
                <div class="header-cell" id="adjust-header">ADJUST<br><span style="font-size: 8px; opacity: 0.7;">(recommended)</span></div>
            </div>
            
            <div class="table-row">
                <div class="row-label">
                    Grind
                    <div class="row-label-sub">(setting)</div>
                </div>
                <div class="table-cell">
                    <div class="input-controls">
                        <button class="micro-btn" onclick="adjustMetric('grind', -1)">-</button>
                        <input type="number" class="cell-input" id="grind-input" value="8" min="1" max="50" onchange="onInputChange('grind-input')">
                        <button class="micro-btn" onclick="adjustMetric('grind', 1)">+</button>
                    </div>
                </div>
                <div class="table-cell" id="grind-brew">--</div>
                <div class="table-cell" id="grind-adjust">--</div>
            </div>
            
            <div class="table-row">
                <div class="row-label">
                    Dose
                    <div class="row-label-sub" id="dose-unit">(g)</div>
                </div>
                <div class="table-cell">
                    <div class="input-controls">
                        <button class="micro-btn" onclick="adjustMetric('dose', -1)">-</button>
                        <input type="number" class="cell-input" id="dose-input" value="18" min="10" max="25" onchange="onInputChange('dose-input')">
                        <button class="micro-btn" onclick="adjustMetric('dose', 1)">+</button>
                    </div>
                </div>
                <div class="table-cell" id="dose-brew">--</div>
                <div class="table-cell" id="dose-adjust">--</div>
            </div>
            
            <div class="table-row">
                <div class="row-label">
                    Volume
                    <div class="row-label-sub" id="volume-unit">(g)</div>
                </div>
                <div class="table-cell">
                    <div class="input-controls">
                        <button class="micro-btn" onclick="adjustMetric('volume', -1)">-</button>
                        <input type="number" class="cell-input" id="volume-target" value="36" min="10" max="100" onchange="onInputChange('volume-target')">
                        <button class="micro-btn" onclick="adjustMetric('volume', 1)">+</button>
                    </div>
                </div>
                <div class="table-cell" id="volume-brew">--</div>
                <div class="table-cell" id="volume-adjust">36g</div>
            </div>
            
            <div class="table-row">
                <div class="row-label">
                    Time
                    <div class="row-label-sub">(sec)</div>
                </div>
                <div class="table-cell">
                    <div class="input-controls">
                        <button class="micro-btn" onclick="adjustMetric('time', -1)">-</button>
                        <input type="number" class="cell-input" id="time-target" value="28" min="10" max="60" onchange="onInputChange('time-target')">
                        <button class="micro-btn" onclick="adjustMetric('time', 1)">+</button>
                    </div>
                </div>
                <div class="table-cell" id="time-brew">--</div>
                <div class="table-cell" id="time-adjust">28s</div>
            </div>
            
            <div class="table-row">
    <div class="row-label">
        Tamp
        <div class="row-label-sub">(pressure)</div>
    </div>
    <div class="table-cell">
        <div class="tamp-control" id="manual-tamp-control">
            <button class="tamp-btn" onclick="adjustTamp(-1)">-</button>
            <div class="tamp-symbol" id="tamp-display">â—</div>
            <button class="tamp-btn" onclick="adjustTamp(1)">+</button>
        </div>
        <div class="spring-tamp-control" id="spring-tamp-control" style="display: none;">
            <button class="micro-btn" onclick="adjustSpringTamp(-1)">-</button>
            <input type="number" class="cell-input" id="spring-input" value="16" min="0" max="99" style="width: 50px; text-align: center;" onchange="onSpringChange()">
            <button class="micro-btn" onclick="adjustSpringTamp(1)">+</button>
        </div>
        <div class="auto-tamp-control" id="auto-tamp-control" style="display: none;">
            <span id="auto-tamp-display">15</span>
        </div>
    </div>
    <div class="table-cell" id="tamp-brew">
        <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">--</div>
    </div>
    <div class="table-cell" id="tamp-adjust">
        <div style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">â—</div>
    </div>
</div>
        </div>

        <!-- Control Row -->
        <div class="control-row">
            <label class="session-checkbox">
                <input type="checkbox" id="session-checkbox" checked>
                <span id="session-label">First shot of the day?</span>
            </label>
            <button class="reset-btn" onclick="resetBrew()">Reset</button>
        </div>

        <!-- Taste Button (Hidden Initially) -->
        <div class="taste-button-section" id="taste-button-section">
            <button class="taste-trigger-btn" onclick="openTasteModal()">
                Tap here to rate the taste
            </button>
        </div>

        <!-- Apply Adjustments Button (Hidden Initially) -->
<div class="apply-button-section" id="apply-button-section" style="display: none; margin-bottom: 8px;">
    <div style="display: flex; gap: 8px;">
        <button style="flex: 1; background: var(--accent-green); color: var(--white); border: none; padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 800; cursor: pointer; transition: all 0.3s; font-family: 'Inter', sans-serif; border: 2px solid var(--accent-green);" onclick="applyAdjustments()">
            Apply
        </button>
        <button style="flex: 1; background: var(--grey-medium); color: var(--white); border: none; padding: 18px; border-radius: 16px; font-size: 18px; font-weight: 800; cursor: pointer; transition: all 0.3s; font-family: 'Inter', sans-serif; border: 2px solid var(--grey-medium);" onclick="skipAdjustments()">
            Skip
        </button>
    </div>
</div>

        <!-- Brew Button -->
<div class="brew-button-section" id="brew-button-section">
    <button class="brew-btn" id="brew-btn" onclick="startBrew()">
        BREW
    </button>
</div>
<!-- Bean Management -->
<div style="margin-top: 8px; padding: 10px; background: var(--cream); border-radius: 8px; border: 1px solid var(--border); margin-bottom: 12px;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div style="font-size: 11px; color: var(--text-secondary);">
            <span id="current-bean-label">No beans selected</span>
        </div>
        <div style="display: flex; gap: 6px;">
            <button onclick="clearBeans()" style="background: var(--grey-light); color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer;">Clear</button>
            <button onclick="openNewBeansModal()" style="background: var(--accent-green); color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; cursor: pointer;">New Beans</button>
        </div>
    </div>
</div>

    <!-- Footer Section -->
    <div style="margin: 16px 0 8px; text-align: center;">
        <!-- Auth Promo -->
        <div style="text-align: center; padding: 12px; background: var(--cream); border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border);" id="auth-promo-brew">
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">
                <span style="font-size: 16px;">ðŸ”„</span> Keep your brewing data safe
            </div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 8px;">
                Sign in to sync your shots, settings, and insights across all devices
            </div>
            <button onclick="signInWithGoogle()" style="background: var(--accent-green); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer;">
                Sign In with Google
            </button>
        </div>
        
        <a href="https://lazysous.app" target="_blank" style="text-decoration: none; display: inline-flex; align-items: center; gap: 10px; padding: 10px 18px; background: var(--black); border-radius: 18px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <img src="https://raw.githubusercontent.com/lazysous/logo/main/logo-transparent-white.png" alt="Lazy Sous" style="height: 18px; width: auto;">
            <span style="font-size: 13px; color: var(--white); font-weight: 500;">What's for dinner?</span>
            <span style="font-size: 13px; color: var(--gold); font-weight: 600;">Visit Lazy Sous â†’</span>
        </a>
        
        <div class="footer-icons" style="margin-top: 14px;">
            <button class="footer-icon" onclick="window.open('https://www.instagram.com/lazysous.app/', '_blank')" style="background: none; border: none; padding: 6px 12px; cursor: pointer; transition: all 0.2s;">
                <span style="font-size: 18px;">ðŸ“¸</span>
                <span class="footer-icon-label" style="display: block; font-size: 10px; margin-top: 2px;">Follow</span>
            </button>
            <button class="footer-icon" onclick="openSupportModal()" style="background: none; border: none; padding: 6px 12px; cursor: pointer; transition: all 0.2s;">
                <span style="font-size: 18px;">â¤ï¸</span>
                <span class="footer-icon-label" style="display: block; font-size: 10px; margin-top: 2px;">Support</span>
            </button>
            <button class="footer-icon" onclick="openPrivacyModal()" style="background: none; border: none; padding: 6px 12px; cursor: pointer; transition: all 0.2s;">
                <span style="font-size: 18px;">ðŸ¥¸</span>
                <span class="footer-icon-label" style="display: block; font-size: 10px; margin-top: 2px;">Privacy</span>
            </button>
        </div>
        
        <div style="font-size: 10px; color: var(--text-tertiary); margin-top: 10px;">Â© <span class="copyright-year-brew"></span> Lazy Sous.</div>
    </div>
    
    <script>
    // Auto-update copyright year
    document.querySelector('.copyright-year-brew').textContent = new Date().getFullYear();
    </script>
    </div>

    <!-- Insights Tab -->
    <div class="tab-content" id="insights-tab">
        <div class="insights-grid">
            <div class="insight-card">
                <div class="insight-number" id="first-shot-avg">--</div>
                <div class="insight-label">First Shot Avg</div>
            </div>
            <div class="insight-card">
                <div class="insight-number" id="follow-up-avg">--</div>
                <div class="insight-label">Follow-up Avg</div>
            </div>
            <div class="insight-card">
                <div class="insight-number" id="optimal-grind">--</div>
                <div class="insight-label">Optimal Grind</div>
            </div>
            <div class="insight-card">
                <div class="insight-number" id="total-shots">--</div>
                <div class="insight-label">Total Shots</div>
            </div>
        </div>

        <div class="card">
            <div class="section-header">
                <div class="card-title">Recent Performance</div>
                <button class="clear-btn" onclick="clearRecentPerformance()">Clear</button>
            </div>
            <div class="shot-history-container">
                <div id="shot-history">
                    <div class="empty-state">
                        No shots logged yet
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="section-header">
                <div class="card-title">Personal Benchmarks</div>
                <button class="clear-btn" onclick="clearPersonalBenchmarks()">Clear</button>
            </div>
            <div class="benchmark-threshold">
                Requires 10+ rated shots.
            </div>
            <div id="personal-benchmarks" class="benchmark-list">
                <div class="empty-state">
                    Build your benchmark data with more shots
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title" style="margin-bottom: 12px;">Insights Management</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px;">
                <button class="option-btn" onclick="exportData()">Export Insights</button>
                <button class="option-btn" onclick="document.getElementById('import-input').click()">Import Insights</button>
            </div>
            <input type="file" id="import-input" accept=".json" style="display: none;" onchange="importData(event)">
            <div style="font-size: 10px; color: var(--text-tertiary); text-align: center; margin-bottom: 8px;">
                Backup your shot history and settings
            </div>
            <button class="reset-all-btn" onclick="resetAllData()">
                Reset All Insights
            </button>
        </div>
<!-- Footer Section -->
    <div style="margin: 16px 0 8px; text-align: center;">
        <!-- Auth Promo -->
        <div style="text-align: center; padding: 12px; background: var(--cream); border-radius: 8px; margin-bottom: 12px; border: 1px solid var(--border);" id="auth-promo-insights">
            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 6px;">
                <span style="font-size: 16px;">ðŸ”„</span> Keep your brewing data safe
            </div>
            <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 8px;">
                Sign in to sync your shots, settings, and insights across all devices
            </div>
            <button onclick="signInWithGoogle()" style="background: var(--accent-green); color: white; border: none; padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer;">
                Sign In with Google
            </button>
        </div>
        
        <a href="https://lazysous.app" target="_blank" style="text-decoration: none; display: inline-flex; align-items: center; gap: 10px; padding: 10px 18px; background: var(--black); border-radius: 18px; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <img src="https://raw.githubusercontent.com/lazysous/logo/main/logo-transparent-white.png" alt="Lazy Sous" style="height: 18px; width: auto;">
            <span style="font-size: 13px; color: var(--white); font-weight: 500;">What's for dinner?</span>
            <span style="font-size: 13px; color: var(--gold); font-weight: 600;">Visit Lazy Sous â†’</span>
        </a>
        
        <div class="footer-icons" style="margin-top: 14px;">
            <button class="footer-icon" onclick="window.open('https://www.instagram.com/lazysous.app/', '_blank')" style="background: none; border: none; padding: 6px 12px; cursor: pointer; transition: all 0.2s;">
                <span style="font-size: 18px;">ðŸ“¸</span>
                <span class="footer-icon-label" style="display: block; font-size: 10px; margin-top: 2px;">Follow</span>
            </button>
            <button class="footer-icon" onclick="openSupportModal()" style="background: none; border: none; padding: 6px 12px; cursor: pointer; transition: all 0.2s;">
                <span style="font-size: 18px;">â¤ï¸</span>
                <span class="footer-icon-label" style="display: block; font-size: 10px; margin-top: 2px;">Support</span>
            </button>
            <button class="footer-icon" onclick="openPrivacyModal()" style="background: none; border: none; padding: 6px 12px; cursor: pointer; transition: all 0.2s;">
                <span style="font-size: 18px;">ðŸ¥¸</span>
                <span class="footer-icon-label" style="display: block; font-size: 10px; margin-top: 2px;">Privacy</span>
            </button>
        </div>
        
        <div style="font-size: 10px; color: var(--text-tertiary); margin-top: 10px;">Â© <span id="copyright-year"></span> Lazy Sous.</div>
    </div>
    
    <script>
    // Auto-update copyright year
    document.getElementById('copyright-year').textContent = new Date().getFullYear();
    </script>
    </div>

    <!-- Navigation -->
    <nav class="bottom-nav">
        <button class="nav-item" onclick="switchTab('setup')" id="setup-nav">
            <span class="nav-icon">ðŸ”§</span>
            <span>Set Up</span>
            <span class="nav-badge" id="setup-badge" style="display: none;"></span>
        </button>
        <button class="nav-item brew-nav active" onclick="switchTab('brew')" id="brew-nav">
            <span class="nav-icon">â˜•</span>
            <span>Brew</span>
        </button>
        <button class="nav-item" onclick="switchTab('insights')" id="insights-nav">
            <span class="nav-icon">ðŸš€</span>
            <span>Insights</span>
        </button>
    </nav>
</div>

<!-- Data Entry Modal -->
<div class="modal" id="data-entry-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="data-entry-title">Log Your Results</h3>
            <button class="modal-close" onclick="closeDataEntry()">Ã—</button>
        </div>
        
        <div class="data-entry-content">
            <div class="entry-options">
                <button class="entry-option-btn active" onclick="selectEntryMode('manual')">Manual Entry</button>
                <button class="entry-option-btn" onclick="selectEntryMode('timer')">Use Timer</button>
            </div>

            <div class="manual-inputs show" id="manual-inputs">
                <div class="input-row">
                    <label class="input-label" style="text-align: left;">Time (s)</label>
                    <input type="number" class="number-input" id="manual-time" step="0.1" min="10" max="60" value="28">
                </div>
                <div class="input-row">
                    <label class="input-label" style="text-align: left;">Volume (<span id="entry-volume-unit">g</span>)</label>
                    <input type="number" class="number-input" id="manual-volume" step="0.1" min="10" max="80" value="36">
                </div>
                <button class="save-data-btn" onclick="saveManualData()">
                    Save Results
                </button>
            </div>

            <div class="timer-section" id="timer-section">
                <div class="timer-row">
                    <span class="timer-label" style="text-align: left;">Time (s)</span>
                    <div class="timer-display" id="timer-display">00.0</div>
                </div>
                <div class="input-row">
                    <label class="input-label" style="text-align: left;">Volume (<span id="timer-volume-unit">g</span>)</label>
                    <input type="number" class="number-input" id="timer-volume" step="0.1" min="10" max="80" value="36">
                </div>
                <div class="timer-controls">
                    <button class="timer-btn start" id="start-btn" onclick="startTimer()">Start</button>
                    <button class="timer-btn stop" id="stop-btn" onclick="stopTimer()" disabled>Stop</button>
                </div>
                <button class="save-data-btn" onclick="saveTimerData()" id="save-timer-btn" style="display: none;">
                    Save Results
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Taste Modal -->
<div class="modal" id="taste-modal">
    <div class="modal-content taste-modal">
        <div class="modal-header">
            <h3 style="font-size: 14px;">How did it taste?</h3>
            <button class="modal-close" onclick="closeTasteModal()">Ã—</button>
        </div>
        
        <div class="taste-scale">
            <div class="scale-track" id="scale-track">
                <div class="scale-handle" id="scale-handle"></div>
            </div>
            <div class="scale-labels">
                <span>Very Sour</span>
                <span>Sour</span>
                <span>Perfect</span>
                <span>Bitter</span>
                <span>Very Bitter</span>
            </div>
        </div>
        
        <div class="taste-value" id="taste-value">Perfect Balance</div>
        <div class="taste-decimal" id="taste-decimal">5.0</div>
        <div class="taste-details" id="taste-details">Optimal extraction with balanced acidity and sweetness</div>
        
        <div class="taste-buttons">
            <button class="skip-taste-btn" onclick="skipTaste()">Didn't Try</button>
            <button class="rate-taste-btn" onclick="saveTaste()">Rate Shot</button>
        </div>
    </div>
</div>

<!-- Shot Detail Modal -->
<div class="modal" id="shot-detail-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="font-size: 14px;">Shot Details</h3>
            <button class="modal-close" onclick="closeShotDetail()">Ã—</button>
        </div>
        
        <div class="shot-detail-content">
            <div class="shot-detail-header">
                <div class="shot-detail-number" id="shot-detail-number">Shot #23</div>
                <div class="shot-detail-timestamp">
                    <div id="shot-detail-date" style="font-size: 12px; font-weight: 600;">Monday, 15 Dec 2024</div>
                    <div id="shot-detail-time" style="font-size: 11px;">3:45pm</div>
                </div>
            </div>
            
            <div class="shot-detail-section">
    <div class="shot-detail-section-title">SHOT PERFORMANCE</div>
    <div class="shot-detail-row">
        <span class="shot-detail-label">Score:</span>
        <span class="shot-detail-value" id="detail-score" style="font-weight: 800;">--</span>
    </div>
    <div class="shot-detail-row" style="background: var(--cream); padding: 6px 4px; margin: 8px -10px; border-radius: 6px;">
        <span class="shot-detail-label" style="font-weight: 600; color: var(--text-primary);">Metric</span>
        <span class="shot-detail-value" style="font-size: 10px; color: var(--text-secondary);">
            Input â†’ Actual â†’ Recommended
        </span>
    </div>
    <div class="shot-detail-row">
        <span class="shot-detail-label">Grind:</span>
        <span class="shot-detail-value">
            <span id="detail-grind-input">--</span> â†’ 
            <span id="detail-grind-output">--</span> â†’ 
            <span id="detail-grind-rec" style="color: var(--accent-green);">--</span>
        </span>
    </div>
    <div class="shot-detail-row">
        <span class="shot-detail-label">Dose:</span>
        <span class="shot-detail-value">
            <span id="detail-dose-input">--</span> â†’ 
            <span id="detail-dose-output">--</span> â†’ 
            <span id="detail-dose-rec" style="color: var(--accent-green);">--</span>
        </span>
    </div>
    <div class="shot-detail-row">
        <span class="shot-detail-label">Volume:</span>
        <span class="shot-detail-value">
            <span id="detail-volume-input">--</span> â†’ 
            <span id="detail-volume-output">--</span> â†’ 
            <span id="detail-volume-rec" style="color: var(--accent-green);">--</span>
        </span>
    </div>
    <div class="shot-detail-row">
        <span class="shot-detail-label">Time:</span>
        <span class="shot-detail-value">
            <span id="detail-time-input">--</span> â†’ 
            <span id="detail-time-output">--</span> â†’ 
            <span id="detail-time-rec" style="color: var(--accent-green);">--</span>
        </span>
    </div>
    <div class="shot-detail-row">
        <span class="shot-detail-label">Tamp:</span>
        <span class="shot-detail-value" id="detail-tamp">-- â†’ -- â†’ --</span>
    </div>
</div>

<div class="shot-detail-section">
    <div class="shot-detail-section-title">CONDITIONS</div>
    <div class="shot-detail-row">
        <span class="shot-detail-label">Weather:</span>
        <span class="shot-detail-value" id="detail-weather">25Â°C, 65% humidity</span>
    </div>
    <div class="shot-detail-row">
        <span class="shot-detail-label">Bean age:</span>
        <span class="shot-detail-value" id="detail-bean-age">14 days</span>
    </div>
</div>

<div class="shot-detail-section">
    <div class="shot-detail-section-title">TASTE</div>
                <div id="detail-taste-section">
                    <div class="shot-detail-row">
                        <span class="shot-detail-label">Rating:</span>
                        <span class="shot-detail-value" id="detail-taste">5.2</span>
                    </div>
                </div>
                <div id="detail-rate-now" style="display: none;">
                    <button class="taste-trigger-btn" style="margin-top: 8px;" onclick="ratePastShot()">
                        Rate Now
                    </button>
                </div>
            </div>
            
            <div class="shot-detail-section">
                <div class="shot-detail-section-title">NOTES</div>
                <textarea class="shot-detail-notes" id="detail-notes" placeholder="Add notes about this shot..."></textarea>
            </div>
            
            <div class="shot-detail-actions">
                <button class="shot-detail-btn shot-edit-btn" onclick="editShot()">Edit</button>
                <button class="shot-detail-btn shot-delete-btn" onclick="deleteShot()">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
// Supabase Configuration
const SUPABASE_URL = 'https://evzvfmviodlpjuewumlp.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV2enZmbXZpb2RscGp1ZXd1bWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyNDk1MDAsImV4cCI6MjA3MzgyNTUwMH0.6WJoVdjl__MKh8WNygrmkslnZm-JIDbvIPbXfrZa4hQ';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// User management
let currentUserId = null;
let currentUser = null;
let isSignedIn = false;

// ML Model Storage
let mlModel = null;
let personalModel = null;

// Load ML training data from Supabase using direct URL
async function loadMLModel() {
    try {
        console.log('Loading ML training data...');
        
        // Use direct public URL since your storage is set up correctly
        const response = await fetch('https://evzvfmviodlpjuewumlp.supabase.co/storage/v1/object/public/training-data/baseline/espresso_training_baseline.csv');
        
        if (!response.ok) {
            console.error('Failed to fetch CSV:', response.status);
            return false;
        }
        
        const text = await response.text();
        const lines = text.split('\n').filter(line => line.trim());
        const headers = lines[0].split(',').map(h => h.trim());
        
        const trainingData = [];
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const row = {};
            headers.forEach((header, idx) => {
                const value = values[idx]?.trim();
                row[header] = isNaN(value) ? value : parseFloat(value);
            });
            trainingData.push(row);
        }
        
        mlModel = trainingData;
        console.log(`ML model loaded with ${trainingData.length} training samples`);
        
        return true;
    } catch (error) {
        console.error('ML load failed:', error);
        return false;
    }
}

// Load successful community shots to enhance ML model
async function loadCommunityData() {
    try {
        console.log('Loading community patterns...');
        
        // Simplified query - remove problematic chained filters
        const { data: communityShots, error } = await supabase
            .from('shots')
            .select('*')
            .gte('score', 80)
            .gte('actual_time', 15)
            .order('score', { ascending: false })
            .limit(500);
        
        if (error) {
            console.error('Supabase query error:', error);
            return false;
        }
        
        if (!communityShots || communityShots.length === 0) {
            console.log('No community data available yet');
            return false;
        }
        
        // Filter out invalid data and shots without taste ratings in JavaScript
        const validShots = communityShots.filter(shot => 
            shot.taste !== null && 
            shot.taste !== 'none' &&
            shot.actual_time <= 60 &&
            shot.dose >= 10 &&
            shot.dose <= 30
        );
        
        if (validShots.length > 0) {
            // Add community data to ML model with proper formatting
            const communityPatterns = validShots.map(shot => ({
                ...shot,
                source: 'community',
                // Normalize naming to match CSV format
                actualVolume: shot.actual_volume,
                actualTime: shot.actual_time,
                volumeTarget: shot.volume_target,
                timeTarget: shot.time_target,
                waterTempC: shot.water_temp_c,
                beanAge: shot.bean_age,
                roastLevel: shot.roast_level,
                tampPressureKg: shot.tamp_pressure_kg
            }));
            
            // Merge with existing ML model
            mlModel = [...mlModel, ...communityPatterns];
            console.log(`Added ${validShots.length} community patterns to ML model`);
            return true;
        }
        
        return false;
    } catch (error) {
        console.error('Community data load failed:', error);
        return false;
    }
}

// Find similar shots in training data
function findSimilarShots(currentConditions) {
    if (!mlModel || mlModel.length === 0) return null;
    
    // Start with community + CSV training data (objective science)
    let dataToSearch = [...mlModel];
    
    // Calculate similarity using ALL available data
    const similarities = dataToSearch.map(shot => {
        let distance = 0;
        let weight = 1;
        
        // Primary factors (highest weight)
        distance += Math.abs((shot.grind || 0) - currentConditions.grind) * 3;
        distance += Math.abs((shot.dose || 0) - currentConditions.dose) * 2;
        
        // Time comparison if available
        if (shot.actualTime && currentConditions.targetTime) {
            distance += Math.abs(shot.actualTime - currentConditions.targetTime) * 2;
        }
        
        // Volume comparison if available
        if (shot.actualVolume && currentConditions.targetVolume) {
            distance += Math.abs(shot.actualVolume - currentConditions.targetVolume) * 1.5;
        }
        
        // Temperature if available
        if (shot.waterTempC && currentConditions.waterTemp) {
            distance += Math.abs(shot.waterTempC - currentConditions.waterTemp) * 0.5;
        }
        
        // Tamp pressure if available
        if (shot.tampPressureKg && currentConditions.tampPressure) {
            distance += Math.abs(shot.tampPressureKg - currentConditions.tampPressure) * 1;
        }
        
        // Environmental factors
        if (shot.humidity && currentConditions.humidity) {
            distance += Math.abs(shot.humidity - currentConditions.humidity) * 0.2;
        }
        if (shot.beanAge && currentConditions.beanAge) {
            distance += Math.abs(shot.beanAge - currentConditions.beanAge) * 0.3;
        }
        if (shot.roastLevel && currentConditions.roastLevel) {
            distance += Math.abs(shot.roastLevel - currentConditions.roastLevel) * 2;
        }
        
        // Boost community data slightly over CSV
        if (shot.source === 'community') {
            weight = 1.2;  // 20% more weight for real-world data
        }
        
        return {
            shot: shot,
            distance: distance / weight,
            source: shot.source || 'csv'
        };
    });
    
    // Get 15 most similar shots for better pattern recognition
    similarities.sort((a, b) => a.distance - b.distance);
    return similarities.slice(0, 15);
}

// Apply personal taste preferences on top of ML recommendations
function applyPersonalPreferences(baseRecommendation, confidence) {
    // Don't override if user has no history
    if (brewmieData.shots.length < 5) return baseRecommendation;
    
    // Get user's personal patterns
    const userShots = brewmieData.shots.filter(s => 
        s.taste && s.taste !== 'none' && s.score >= 80
    );
    
    if (userShots.length === 0) return baseRecommendation;
    
    // Calculate user's taste preference bias
    const avgTaste = userShots.reduce((sum, s) => sum + parseFloat(s.taste), 0) / userShots.length;
    let personalAdjustment = { ...baseRecommendation };
    
    // User prefers stronger/more bitter coffee
    if (avgTaste > 6) {
        personalAdjustment.grind += 0.5;  // Slightly coarser
        personalAdjustment.reason += ' (adjusted for your bitter preference)';
    }
    // User prefers brighter/more acidic coffee  
    else if (avgTaste < 4) {
        personalAdjustment.grind -= 0.5;  // Slightly finer
        personalAdjustment.reason += ' (adjusted for your bright preference)';
    }
    
    // Check user's typical extraction time preference
    const avgTimeDiff = userShots
        .filter(s => s.taste >= 4.5 && s.taste <= 5.5)
        .reduce((sum, s) => sum + (s.actualTime - s.timeTarget), 0) / userShots.length;
    
    if (avgTimeDiff > 2) {
        // User's perfect shots tend to run slower
        personalAdjustment.timeTarget = (personalAdjustment.timeTarget || 28) + 2;
    } else if (avgTimeDiff < -2) {
        // User's perfect shots tend to run faster
        personalAdjustment.timeTarget = (personalAdjustment.timeTarget || 28) - 2;
    }
    
    return personalAdjustment;
}

// Google Auth Configuration
const GOOGLE_CLIENT_ID = 'YOUR_GOOGLE_CLIENT_ID'; // You'll need to set this

async function initializeGoogleAuth() {
    try {
        await new Promise((resolve) => {
            window.google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleGoogleSignIn,
                auto_select: false,
                cancel_on_tap_outside: false
            });
            resolve();
        });
        
        // Check if user is already signed in
        const savedUser = localStorage.getItem('brewmie_user');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            isSignedIn = true;
            await initializeUser();
            updateAuthUI();
        } else {
            // Try anonymous mode
            await initializeAnonymousUser();
        }
        
        // Set up auth UI
        document.getElementById('google-sign-in-btn').addEventListener('click', signInWithGoogle);
        document.getElementById('sign-out-btn').addEventListener('click', signOut);
        
    } catch (error) {
        console.error('Google Auth init error:', error);
        await initializeAnonymousUser();
    }
}

async function handleGoogleSignIn(response) {
    try {
        const decoded = parseJWT(response.credential);
        currentUser = {
            id: decoded.sub,
            email: decoded.email,
            name: decoded.name,
            picture: decoded.picture
        };
        
        isSignedIn = true;
        localStorage.setItem('brewmie_user', JSON.stringify(currentUser));
        
        await initializeUser();
        updateAuthUI();
        
        showAlert(`Welcome ${currentUser.name}! Your data will now sync across devices.`, 'success');
        
    } catch (error) {
        console.error('Sign in error:', error);
        showAlert('Sign in failed. Please try again.', 'error');
    }
}

function parseJWT(token) {
    const base64Url = token.split('.')[1];
    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
    }).join(''));
    return JSON.parse(jsonPayload);
}

function signInWithGoogle() {
    window.google.accounts.id.prompt((notification) => {
        if (notification.isNotDisplayed()) {
            // Fallback to popup
            window.google.accounts.id.renderButton(
                document.getElementById('google-sign-in-btn'),
                { theme: 'outline', size: 'medium' }
            );
        }
    });
}

async function signOut() {
    try {
        currentUser = null;
        currentUserId = null;
        isSignedIn = false;
        localStorage.removeItem('brewmie_user');
        
        // Switch to anonymous mode
        await initializeAnonymousUser();
        updateAuthUI();
        
        showAlert('Signed out successfully', 'info');
        
    } catch (error) {
        console.error('Sign out error:', error);
    }
}

function updateAuthUI() {
    const signedInState = document.getElementById('signed-in-state');
    const signedOutState = document.getElementById('signed-out-state');
    
    if (isSignedIn && currentUser) {
        signedInState.style.display = 'flex';
        signedOutState.style.display = 'none';
        document.getElementById('user-avatar').src = currentUser.picture;
    } else {
        signedInState.style.display = 'none';
        signedOutState.style.display = 'block';
    }
    
    updateAuthPromo();
}

function updateAuthPromo() {
    const promos = ['auth-promo-setup', 'auth-promo-brew', 'auth-promo-insights'];
    promos.forEach(promoId => {
        const promo = document.getElementById(promoId);
        if (promo) {
            promo.style.display = isSignedIn ? 'none' : 'block';
        }
    });
}
    
async function initializeUser() {
    try {
        if (isSignedIn && currentUser) {
            // Signed-in user
            let { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('google_id', currentUser.id)
                .single();
            
            if (!profile) {
                const { data: newProfile, error } = await supabase
                    .from('profiles')
                    .insert([{
                        google_id: currentUser.id,
                        email: currentUser.email,
                        name: currentUser.name,
                        algorithm_version: '3.4'
                    }])
                    .select()
                    .single();
                
                if (error) throw error;
                profile = newProfile;
            }
            
            currentUserId = profile.id;
            console.log('Signed-in user initialized:', currentUserId);
            
            // Load user's cloud data
            await loadUserDataFromCloud();
            
        } else {
            // Anonymous user fallback
            await initializeAnonymousUser();
        }
        
        // Load ML model
        await loadMLModel();
        await loadCommunityData();
        
    } catch (error) {
        console.error('User init error:', error);
        await initializeAnonymousUser();
    }
}

async function initializeAnonymousUser() {
    let deviceId = localStorage.getItem('brewmie_device_id');
    if (!deviceId) {
        deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('brewmie_device_id', deviceId);
    }
    
    try {
        let { data: profile } = await supabase
            .from('profiles')
            .select('*')
            .eq('device_id', deviceId)
            .single();
        
        if (!profile) {
            const { data: newProfile, error } = await supabase
                .from('profiles')
                .insert([{
                    device_id: deviceId,
                    algorithm_version: '3.4'
                }])
                .select()
                .single();
            
            if (error) throw error;
            profile = newProfile;
        }
        
        currentUserId = profile.id;
        console.log('Anonymous user initialized:', currentUserId);
        
    } catch (error) {
        console.error('Anonymous user init error:', error);
    }
}

async function syncToCloud() {
    if (!currentUserId) return;
    
    try {
        const localShots = brewmieData.shots.slice(0, 20);
        
        // Rate limit - max 50 shots per day per user
        const today = new Date().toDateString();
        const todaysShots = brewmieData.shots.filter(s => 
            new Date(s.id).toDateString() === today
        );
        if (todaysShots.length > 50) {
            console.log('Daily shot limit reached');
            return;
        }
        
        for (const shot of localShots) {
            if (shot.synced) continue;
            
            // Validation - reject obviously fake data
            if (shot.score > 100 || shot.score < 0 ||
                shot.actualTime > 120 || shot.actualTime < 5 ||
                shot.dose > 50 || shot.dose < 5 ||
                shot.grind > 100 || shot.grind < 0) {
                console.log('Invalid shot data detected, skipping');
                shot.synced = true;
                continue;
            }
            
            // Only send fields that actually exist in the shot
            const shotData = {
                user_id: currentUserId,
                grind: shot.grind || shot.inputGrind || null,
                dose: shot.dose || shot.actualDose || null,
                volume_target: shot.volumeTarget || null,
                actual_volume: shot.actualVolume || null,
                time_target: shot.timeTarget || null,
                actual_time: shot.actualTime || null,
                score: shot.score || null,
                taste: (shot.taste && shot.taste !== 'none') ? parseFloat(shot.taste) : null,
                humidity: shot.weather?.humidity || null,
                water_temp_c: shot.waterTempC || null,
                bean_age: shot.beanAge || null,
                roast_level: shot.roastLevel ? 
                    (shot.roastLevel === 'light' ? 1 : 
                     shot.roastLevel === 'medium' ? 2 : 
                     shot.roastLevel === 'dark' ? 3 : 
                     typeof shot.roastLevel === 'number' ? shot.roastLevel : null) 
                    : null,
                machine: shot.machine || null,
                tamp_type: shot.tampType || null,
                tamp_pressure_kg: shot.tampPressureKg || null,
                is_first_brew: shot.isFirstBrew === true,
                algorithm_version: shot.algorithmVersion || '3.4',
                recommendation_confidence: shot.recommendationConfidence || null
            };
            
            // Only include non-null values to avoid database errors
            Object.keys(shotData).forEach(key => {
                if (shotData[key] === undefined) {
                    delete shotData[key];
                }
            });
            
            const { data, error } = await supabase
                .from('shots')
                .insert([shotData])
                .select();
            
            if (!error && data) {
                shot.synced = true;
                console.log('Shot synced successfully:', data[0].id);
                
                // Good shots contribute to community learning
                if (shot.score >= 85 && shot.taste && shot.taste !== 'none') {
                    console.log('High-quality shot added to community dataset');
                }
            }
            
            if (error) {
                console.error('Shot sync error details:', error.message);
            } else {
                shot.synced = true;
                // console.log('Shot synced successfully:', data[0].id);
            }
        }
        
    } catch (error) {
        console.error('Sync error:', error);
    }
}

async function loadUserDataFromCloud() {
    if (!currentUserId || !isSignedIn) return;
    
    try {
        // Load complete user data from cloud
        const { data: userData, error } = await supabase
            .from('user_data')
            .select('*')
            .eq('user_id', currentUserId)
            .single();
        
        if (error && error.code !== 'PGRST116') throw error;
        
        if (userData && userData.data) {
            const cloudData = userData.data;
            
            // Merge cloud data with local data
            if (cloudData.shots && cloudData.shots.length > 0) {
                const localShotIds = new Set(brewmieData.shots.map(s => s.id));
                const newShots = cloudData.shots.filter(shot => !localShotIds.has(shot.id));
                
                if (newShots.length > 0) {
                    brewmieData.shots = [...newShots, ...brewmieData.shots]
                        .sort((a, b) => b.id - a.id)
                        .slice(0, 100);
                }
            }
            
            // Merge settings (prioritize cloud for signed-in users)
            if (cloudData.machine) brewmieData.machine = { ...brewmieData.machine, ...cloudData.machine };
            if (cloudData.grinder) brewmieData.grinder = { ...brewmieData.grinder, ...cloudData.grinder };
            if (cloudData.beans) brewmieData.beans = { ...brewmieData.beans, ...cloudData.beans };
            if (cloudData.maintenance) brewmieData.maintenance = { ...brewmieData.maintenance, ...cloudData.maintenance };
            if (cloudData.personalWeights) brewmieData.personalWeights = { ...brewmieData.personalWeights, ...cloudData.personalWeights };
            
            console.log('User data loaded from cloud');
            saveData();
        }
        
        // Also load shots for community ML
        await loadUserShotsFromCloud();
        
    } catch (error) {
        console.error('Failed to load user data from cloud:', error);
    }
}

async function loadUserShotsFromCloud() {
    if (!currentUserId) return;
    
    try {
        // Get user's last 30 shots from cloud (for community ML)
        const { data: cloudShots, error } = await supabase
            .from('shots')
            .select('*')
            .eq('user_id', currentUserId)
            .order('created_at', { ascending: false })
            .limit(30);
        
        if (error) throw error;
        if (!cloudShots || cloudShots.length === 0) return;
        
        // This is just for ML - actual user data sync happens above
        console.log(`Loaded ${cloudShots.length} shots for ML patterns`);
        
    } catch (error) {
        console.error('Failed to load cloud shots:', error);
    }
}

async function syncUserDataToCloud() {
    if (!currentUserId || !isSignedIn) return;
    
    try {
        const userDataToSync = {
            machine: brewmieData.machine,
            grinder: brewmieData.grinder,
            beans: brewmieData.beans,
            maintenance: brewmieData.maintenance,
            personalWeights: brewmieData.personalWeights,
            shots: brewmieData.shots.slice(0, 50), // Sync last 50 shots
            lastSynced: new Date().toISOString()
        };
        
        const { error } = await supabase
            .from('user_data')
            .upsert({
                user_id: currentUserId,
                data: userDataToSync,
                updated_at: new Date().toISOString()
            });
        
        if (error) throw error;
        console.log('User data synced to cloud');
        
    } catch (error) {
        console.error('Failed to sync user data to cloud:', error);
    }
}

// Constants
const TAMP_SYMBOLS = ['â–¼', 'â—', 'â–²'];
// Grinder Profiles for normalization
const GRINDER_PROFILES = {
    // Integrated grinders
    'breville-express': { brand: 'Breville', model: 'Express Built-in', min: 1, max: 18, factor: 5.88 },
    'breville-pro': { brand: 'Breville', model: 'Pro Built-in', min: 1, max: 30, factor: 3.45 },
    'breville-touch': { brand: 'Breville', model: 'Touch Built-in', min: 1, max: 30, factor: 3.45 },
    'delonghi-integrated': { brand: 'DeLonghi', model: 'Built-in', min: 1, max: 13, factor: 8.33 },
    
    // Standalone grinders
    'baratza-encore': { brand: 'Baratza', model: 'Encore', min: 1, max: 40, factor: 2.56 },
    'baratza-virtuoso': { brand: 'Baratza', model: 'Virtuoso+', min: 1, max: 40, factor: 2.56 },
    'baratza-sette': { brand: 'Baratza', model: 'Sette 270', min: 1, max: 31, factor: 3.33 },
    'eureka-mignon': { brand: 'Eureka', model: 'Mignon', min: 0, max: 5, factor: 20, decimal: true },
    'eureka-specialita': { brand: 'Eureka', model: 'Specialita', min: 0, max: 5, factor: 20, decimal: true },
    'niche-zero': { brand: 'Niche', model: 'Zero', min: 4, max: 50, factor: 2.17 },
    'fellow-ode': { brand: 'Fellow', model: 'Ode', min: 1, max: 11, factor: 10 },
    'fellow-opus': { brand: 'Fellow', model: 'Opus', min: 1, max: 41, factor: 2.5 },
    'df64': { brand: 'DF64', model: 'Standard', min: 0, max: 100, factor: 1 },
    '1zpresso-jx': { brand: '1Zpresso', model: 'JX-Pro', min: 10, max: 40, factor: 3.33, clicks: true },
    'comandante': { brand: 'Comandante', model: 'C40', min: 8, max: 30, factor: 4.54, clicks: true },
    'other': { brand: 'Other', model: 'Custom', min: 1, max: 50, factor: 2.04 }
};

// Normalize grind to 0-100 scale
function normalizeGrind(grinderKey, setting) {
    const profile = GRINDER_PROFILES[grinderKey];
    if (!profile) return setting; // Fallback to raw value
    
    const normalized = ((setting - profile.min) / (profile.max - profile.min)) * 100;
    return Math.round(normalized * 10) / 10; // One decimal place
}

// Denormalize from 0-100 back to grinder scale
function denormalizeGrind(grinderKey, normalized) {
    const profile = GRINDER_PROFILES[grinderKey];
    if (!profile) return normalized;
    
    const setting = (normalized / 100) * (profile.max - profile.min) + profile.min;
    return profile.decimal ? Math.round(setting * 10) / 10 : Math.round(setting);
}

// Equipment Profile Database
const EQUIPMENT_PROFILES = {
    breville: {
        express: { 
            grindRange: [1, 30], 
            pressureStability: 0.85, 
            tempStability: 0.9,
            recommendedDose: { single: 8, double: 18, triple: 22 },
            grindCalibration: 1.0,
            extractionMultiplier: 2.0
        },
        pro: { 
            grindRange: [1, 30], 
            pressureStability: 0.9, 
            tempStability: 0.95,
            recommendedDose: { single: 9, double: 19, triple: 23 },
            grindCalibration: 1.1,
            extractionMultiplier: 2.0
        },
        touch: { 
            grindRange: [1, 30], 
            pressureStability: 0.95, 
            tempStability: 0.95,
            recommendedDose: { single: 9, double: 19, triple: 23 },
            grindCalibration: 1.15,
            extractionMultiplier: 2.0
        }
    },
    delonghi: {
        specialista: { 
            grindRange: [1, 25], 
            pressureStability: 0.8, 
            tempStability: 0.85,
            recommendedDose: { single: 7, double: 16, triple: 21 },
            grindCalibration: 0.9,
            extractionMultiplier: 2.1
        },
        dedica: { 
            grindRange: [1, 20], 
            pressureStability: 0.75, 
            tempStability: 0.8,
            recommendedDose: { single: 7, double: 15, triple: 19 },
            grindCalibration: 0.85,
            extractionMultiplier: 2.2
        }
    },
    sage: {
        'duo-temp': { 
            grindRange: [1, 25], 
            pressureStability: 0.8, 
            tempStability: 0.85,
            recommendedDose: { single: 8, double: 17, triple: 21 },
            grindCalibration: 0.95,
            extractionMultiplier: 2.0
        },
        bambino: { 
            grindRange: [1, 25], 
            pressureStability: 0.85, 
            tempStability: 0.9,
            recommendedDose: { single: 8, double: 18, triple: 22 },
            grindCalibration: 1.0,
            extractionMultiplier: 2.0
        }
    },
    gaggia: {
        classic: { 
            grindRange: [1, 40], 
            pressureStability: 0.7, 
            tempStability: 0.75,
            recommendedDose: { single: 7, double: 16, triple: 20 },
            grindCalibration: 0.8,
            extractionMultiplier: 2.15
        }
    },
    other: {
        generic: { 
            grindRange: [1, 50], 
            pressureStability: 0.8, 
            tempStability: 0.8,
            recommendedDose: { single: 8, double: 18, triple: 22 },
            grindCalibration: 1.0,
            extractionMultiplier: 2.0
        }
    }
};

// Seeded Algorithm Data
const BASELINE_EXTRACTION_DATA = {
    timingCorrections: {
        veryFast: { threshold: -6, grindChange: -3, confidence: 0.95 },
        fast: { threshold: -3, grindChange: -1.5, confidence: 0.9 },
        slightlyFast: { threshold: -1, grindChange: -0.5, confidence: 0.7 },
        perfect: { threshold: 1, grindChange: 0, confidence: 1.0 },
        slightlySlow: { threshold: 3, grindChange: 0.5, confidence: 0.7 },
        slow: { threshold: 6, grindChange: 1.5, confidence: 0.9 },
        verySlow: { threshold: 10, grindChange: 3, confidence: 0.95 }
    },
    
    environmentalFactors: {
        humidity: {
            high: { threshold: 70, grindChange: 0.5, confidence: 0.8 },
            veryHigh: { threshold: 85, grindChange: 1, confidence: 0.9 },
            low: { threshold: 30, grindChange: -0.5, confidence: 0.8 },
            veryLow: { threshold: 15, grindChange: -1, confidence: 0.9 }
        },
        temperature: {
            hot: { threshold: 30, extractionSpeed: 1.1 },
            cold: { threshold: 10, extractionSpeed: 0.9 }
        }
    },
    
    beanAging: {
        fresh: { days: 5, timeAdjustment: 1, grindAdjustment: -0.5 },
        optimal: { days: 14, timeAdjustment: 0, grindAdjustment: 0 },
        aging: { days: 21, timeAdjustment: -1, grindAdjustment: 0.5 },
        stale: { days: 35, timeAdjustment: -2, grindAdjustment: 1 }
    },
    
    roastProfiles: {
        light: { optimalTime: 32, optimalRatio: 1.8, grindBias: -0.5 },
        medium: { optimalTime: 28, optimalRatio: 2.0, grindBias: 0 },
        dark: { optimalTime: 25, optimalRatio: 2.2, grindBias: 0.5 }
    }
};

// Maintenance Schedule
const maintenanceSchedule = {
    flush: { 
        shots: 30, 
        days: 7, 
        message: "Time for a backflush",
        icon: "ðŸš¿"
    },
    descale: { 
        shots: 300, 
        days: 60, 
        message: "Descaling recommended",
        icon: "ðŸ§ª"
    },
    filter: { 
        shots: 200, 
        days: 60, 
        message: "Filter change due",
        icon: "ðŸ’§"
    }
};

// App State
let brewmieData = {
    machine: { 
        brand: 'breville', 
        model: 'express', 
        maxGrind: 25,
        basketSize: 'double',
        basketType: 'precision',
        shotTemp: 93,
        profile: null
    },
    grinder: {
        type: 'integrated', // 'integrated' or 'standalone'
        key: 'breville-express', // Key from GRINDER_PROFILES
        customMin: 1,
        customMax: 50
    },
    currentGrind: 8,
    tampType: 'manual', // 'manual' | 'spring' | 'automatic'
    tampLevel: 1, // For manual: 0=low, 1=medium, 2=high
    springPressure: 16,
    springMin: 0,
    springMax: 99,
    autoPressure: 15,
    autoMin: 0,
    autoMax: 30,
    units: 'metric', // 'metric' | 'imperial'
    beans: {
        brand: '',
        type: '',
        roastDate: null,
        roastLevel: 'medium'
    },
    maintenance: {
        lastFilter: null,
        lastDescale: null,
        lastFlush: null,
        shotCounts: {
            sinceFilter: 0,
            sinceDescale: 0,
            sinceFlush: 0
        }
    },
    shots: [],
    lastUsed: null,
    setupReminderDismissed: null,
    maintenanceAlertsDismissed: {},
    personalWeights: { 
        humidityEffect: 1.0, 
        timePreference: 0.0,
        tastelearning: {},
        confidenceScore: 50
    },
    beanProfiles: [],
    currentBeanProfile: null,
    algorithmVersion: '3.4',
    validationFlags: [],
    hasTrainingBaseline: false
};

// Phase Management
let brewingPhase = 'pre-brew';
let currentShot = { weather: null };
let currentTab = 'brew';
let currentBrewVolume = 0;
let currentBrewTime = 0;
let timerInterval;
let timerStartTime;
let currentTasteValue = 5.0;
let currentShotDetailId = null;

// Custom Alert/Confirm System
function showAlert(message, type = 'info') {
    const modal = document.createElement('div');
    modal.className = 'app-modal-wrapper';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="app-modal ${type}">
            <div class="modal-message">${message}</div>
            <div class="modal-buttons">
                <button class="modal-ok-btn" onclick="this.closest('.app-modal-wrapper').remove()">OK</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function showConfirm(message, onConfirm, onCancel = null) {
    const modal = document.createElement('div');
    modal.className = 'app-modal-wrapper';
    modal.innerHTML = `
        <div class="modal-backdrop"></div>
        <div class="app-modal warning">
            <div class="modal-message">${message}</div>
            <div class="modal-buttons">
                <button class="modal-cancel-btn">Cancel</button>
                <button class="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    modal.querySelector('.modal-cancel-btn').onclick = () => {
        modal.remove();
        if (onCancel) onCancel();
    };
    
    modal.querySelector('.modal-confirm-btn').onclick = () => {
        modal.remove();
        if (onConfirm) onConfirm();
    };
}

// Unit Conversion Functions
function convertToDisplay(value, type) {
    if (brewmieData.units === 'imperial') {
        switch(type) {
            case 'temp':
                return Math.round(value * 9/5 + 32) + 'Â°F';
            case 'weight':
                return (value * 0.035274).toFixed(1) + 'oz';
            default:
                return value;
        }
    }
    return type === 'temp' ? value + 'Â°C' : value + 'g';
}

function convertFromImperial(value, type) {
    if (brewmieData.units === 'imperial') {
        switch(type) {
            case 'temp':
                return Math.round((value - 32) * 5/9);
            case 'weight':
                return Math.round(value / 0.035274);
            default:
                return value;
        }
    }
    return value;
}

// Phase State Management
function setBrewingPhase(phase) {
    brewingPhase = phase;
    
    const brewBtn = document.getElementById('brew-button-section');
    const tasteBtn = document.getElementById('taste-button-section');
    const applyBtn = document.getElementById('apply-button-section');
    const heroScore = document.getElementById('hero-score-section');
    const brewTable = document.getElementById('brew-table');
    
    // Reset ADJUST header color when changing phases
    const adjustHeader = document.getElementById('adjust-header');
    if (adjustHeader && (phase === 'pre-brew' || phase === 'ready-to-brew')) {
        adjustHeader.style.backgroundColor = '';
        adjustHeader.style.color = '';
    }
    
    switch(phase) {
        case 'pre-brew':
            brewBtn.style.display = 'block';
            tasteBtn.style.display = 'none';
            applyBtn.style.display = 'none';
            heroScore.classList.remove('show');
            document.getElementById('hero-score').textContent = '--';
            document.getElementById('feedback-message').textContent = '';
            break;
        case 'post-brew':
            brewBtn.style.display = 'none';
            tasteBtn.style.display = 'block';
            applyBtn.style.display = 'block';
            heroScore.classList.add('show');
            // Move score above table
            if (brewTable.parentNode) {
                brewTable.parentNode.insertBefore(heroScore, brewTable);
            }
            break;
        case 'ready-to-apply':
            brewBtn.style.display = 'none';
            tasteBtn.style.display = 'block';
            applyBtn.style.display = 'block';
            heroScore.classList.add('show');
            break;
        case 'ready-to-brew':
            brewBtn.style.display = 'block';
            tasteBtn.style.display = 'none';
            applyBtn.style.display = 'none';
            heroScore.classList.remove('show');
            break;
    }
}

// Setup Reminder Enhancement
function dismissSetupReminder(event) {
    event.stopPropagation();
    brewmieData.setupReminderDismissed = Date.now();
    document.getElementById('setup-reminder').style.display = 'none';
    saveData();
}

function checkSetupReminder() {
    const isSetupComplete = 
        brewmieData.beans.roastDate && 
        brewmieData.machine.profile &&
        (brewmieData.maintenance.lastFilter || brewmieData.maintenance.lastDescale);
    
    const dismissed = brewmieData.setupReminderDismissed;
    const weekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
    
    const reminder = document.getElementById('setup-reminder');
    if (!isSetupComplete && (!dismissed || dismissed < weekAgo)) {
        reminder.style.display = 'flex';
    } else {
        reminder.style.display = 'none';
    }
}

// Maintenance Alerts
function checkMaintenanceAlerts() {
    const alerts = [];
    const shotCounts = brewmieData.maintenance.shotCounts;
    
    Object.entries(maintenanceSchedule).forEach(([type, schedule]) => {
        const lastDate = brewmieData.maintenance[`last${type.charAt(0).toUpperCase() + type.slice(1)}`];
        const daysSince = lastDate ? Math.floor((Date.now() - new Date(lastDate)) / (1000 * 60 * 60 * 24)) : 999;
        
        if (shotCounts[`since${type.charAt(0).toUpperCase() + type.slice(1)}`] >= schedule.shots || 
            daysSince >= schedule.days) {
            if (!brewmieData.maintenanceAlertsDismissed[type] || 
                brewmieData.maintenanceAlertsDismissed[type] < Date.now() - (7 * 24 * 60 * 60 * 1000)) {
                alerts.push({ type, schedule });
            }
        }
    });
    
    const alertContainer = document.getElementById('maintenance-alerts');
    const warningIndicator = document.getElementById('maintenance-warning-indicator');
    const setupBadge = document.getElementById('setup-badge');
    
    if (alertContainer) {
        alertContainer.innerHTML = '';
    }
    
    if (alerts.length > 0) {
        // Show warning indicator on Maintenance card
        if (warningIndicator) {
            warningIndicator.style.display = 'inline-block';
        }
        // Show badge on Setup tab
        if (setupBadge) {
            setupBadge.style.display = 'block';
        }
        
        if (alertContainer) {
            alerts.forEach(alert => {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'maintenance-alert';
                alertDiv.innerHTML = `
                    <div>
                        <span class="maintenance-alert-icon">${alert.schedule.icon}</span>
                        <span>${alert.schedule.message}</span>
                    </div>
                    <button class="dismiss-btn" onclick="dismissMaintenanceAlert('${alert.type}')">Ã—</button>
                `;
                alertContainer.appendChild(alertDiv);
            });
        }
    } else {
        if (warningIndicator) {
            warningIndicator.style.display = 'none';
        }
        if (setupBadge) {
            setupBadge.style.display = 'none';
        }
    }
}

function dismissMaintenanceAlert(type) {
    brewmieData.maintenanceAlertsDismissed[type] = Date.now();
    saveData();
    checkMaintenanceAlerts();
}

function updateMaintenanceNotes() {
    const schedule = maintenanceSchedule;
    
    ['filter', 'descale', 'flush'].forEach(type => {
        const noteEl = document.getElementById(`${type}-note`);
        if (!noteEl) return;
        
        const lastDate = brewmieData.maintenance[`last${type.charAt(0).toUpperCase() + type.slice(1)}`];
        const shotsSince = brewmieData.maintenance.shotCounts[`since${type.charAt(0).toUpperCase() + type.slice(1)}`] || 0;
        
        if (!lastDate) {
            noteEl.textContent = 'No maintenance date set';
            noteEl.className = 'maintenance-note due';
            return;
        }
        
        const daysSince = Math.floor((Date.now() - new Date(lastDate)) / (1000 * 60 * 60 * 24));
        const daysRemaining = schedule[type].days - daysSince;
        const shotsRemaining = schedule[type].shots - shotsSince;
        
        if (daysRemaining <= 0 || shotsRemaining <= 0) {
            noteEl.textContent = 'âš ï¸ Maintenance overdue!';
            noteEl.className = 'maintenance-note due';
        } else if (daysRemaining <= 3 || shotsRemaining <= 5) {
            noteEl.textContent = `â° Due soon: ${daysRemaining} days or ${shotsRemaining} shots`;
            noteEl.className = 'maintenance-note soon';
        } else {
            noteEl.textContent = `Next due in ${daysRemaining} days or ${shotsRemaining} shots`;
            noteEl.className = 'maintenance-note';
        }
    });
}

// Tab Management
function switchTab(tab) {
    if (currentTab === 'setup') {
        collapseAllCards();
    }
    
    currentTab = tab;
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    document.getElementById(`${tab}-tab`).classList.add('active');
    
    document.querySelectorAll('.nav-item').forEach(btn => {
        btn.classList.remove('active');
    });
    
    document.getElementById(`${tab}-nav`).classList.add('active');
    
    if (tab === 'brew') {
        updateSessionLabel();
        updateTargets();
        loadInputSettings();
        checkSetupReminder();
        checkMaintenanceAlerts();
    } else if (tab === 'insights') {
        updateInsights();
    }
    
    updateWelcomeMessage();
}

// Setup Functions
function toggleCard(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.expand-icon');
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        header.classList.remove('expanded');
    } else {
        content.classList.add('expanded');
        header.classList.add('expanded');
    }
}

function expandAllCards() {
    document.querySelectorAll('.card-content').forEach(content => {
        content.classList.add('expanded');
        content.previousElementSibling.classList.add('expanded');
    });
}

function collapseAllCards() {
    document.querySelectorAll('.card-content').forEach(content => {
        content.classList.remove('expanded');
        content.previousElementSibling.classList.remove('expanded');
    });
}

// Tamper Type Selection
function selectTampType(type) {
    document.querySelectorAll('[data-tamp]').forEach(btn => btn.classList.remove('active'));
    document.querySelector(`[data-tamp="${type}"]`).classList.add('active');
    
    brewmieData.tampType = type;
    
    const springSetup = document.getElementById('spring-range-setup');
    const autoSetup = document.getElementById('auto-range-setup');
    const manualControl = document.getElementById('manual-tamp-control');
    const springControl = document.getElementById('spring-tamp-control');
    const autoControl = document.getElementById('auto-tamp-control');
    
    // Hide all first
    if (springSetup) springSetup.style.display = 'none';
    if (autoSetup) autoSetup.style.display = 'none';
    if (manualControl) manualControl.style.display = 'none';
    if (springControl) springControl.style.display = 'none';
    if (autoControl) autoControl.style.display = 'none';
    
    // Show appropriate controls
    if (type === 'spring') {
        if (springSetup) springSetup.style.display = 'block';
        if (springControl) springControl.style.display = 'flex';
        const springInput = document.getElementById('spring-input');
        if (springInput) springInput.value = brewmieData.springPressure;
    } else if (type === 'automatic') {
        if (autoSetup) autoSetup.style.display = 'block';
        if (autoControl) autoControl.style.display = 'flex';
        const autoDisplay = document.getElementById('auto-tamp-display');
        if (autoDisplay) autoDisplay.textContent = brewmieData.autoPressure;
    } else {
        if (manualControl) manualControl.style.display = 'flex';
    }
    
    saveData();
}

// Tamp Controls
function adjustTamp(direction) {
    if (brewmieData.tampType === 'manual') {
        if (direction === -1 && brewmieData.tampLevel > 0) {
            brewmieData.tampLevel--;
        } else if (direction === 1 && brewmieData.tampLevel < 2) {
            brewmieData.tampLevel++;
        }
        
        document.getElementById('tamp-display').textContent = TAMP_SYMBOLS[brewmieData.tampLevel];
        document.getElementById('tamp-adjust').textContent = TAMP_SYMBOLS[1];
        
        // Flash animation
        const buttons = document.querySelectorAll('.tamp-btn');
        buttons.forEach(btn => {
            if ((direction === -1 && btn.textContent === '-') || (direction === 1 && btn.textContent === '+')) {
                btn.classList.add('flash-green');
                setTimeout(() => btn.classList.remove('flash-green'), 200);
            }
        });
    }
    
    onInputChange();
    saveData();
}

function adjustSpringTamp(direction) {
    const springInput = document.getElementById('spring-input');
    const current = parseInt(springInput.value) || 16;
    const min = brewmieData.springMin || 0;
    const max = brewmieData.springMax || 99;
    const newValue = Math.max(min, Math.min(max, current + direction));
    
    springInput.value = newValue;
    brewmieData.springPressure = newValue;
    document.getElementById('tamp-adjust').textContent = newValue;
    
    // Flash animation
    const buttons = springInput.parentElement.querySelectorAll('.micro-btn');
    buttons.forEach(btn => {
        if ((direction === -1 && btn.textContent === '-') || (direction === 1 && btn.textContent === '+')) {
            btn.classList.add('flash-green');
            setTimeout(() => btn.classList.remove('flash-green'), 200);
        }
    });
    
    onInputChange();
    saveData();
}

function onSpringChange() {
    const springInput = document.getElementById('spring-input');
    const value = parseInt(springInput.value) || 16;
    const min = brewmieData.springMin || 0;
    const max = brewmieData.springMax || 99;
    
    brewmieData.springPressure = Math.max(min, Math.min(max, value));
    springInput.value = brewmieData.springPressure;
    document.getElementById('tamp-adjust').textContent = brewmieData.springPressure;
    
    onInputChange();
    saveData();
}

// Units Toggle
function toggleUnits(unit) {
    brewmieData.units = unit;
    
    document.querySelectorAll('.units-toggle button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.toLowerCase() === unit) {
            btn.classList.add('active');
        }
    });
    
    // Update labels
    if (unit === 'imperial') {
        document.getElementById('dose-unit').textContent = '(oz)';
        document.getElementById('volume-unit').textContent = '(oz)';
        document.getElementById('entry-volume-unit').textContent = 'oz';
        document.getElementById('timer-volume-unit').textContent = 'oz';
        document.getElementById('temp-unit-label').textContent = 'Â°F';
    } else {
        document.getElementById('dose-unit').textContent = '(g)';
        document.getElementById('volume-unit').textContent = '(g)';
        document.getElementById('entry-volume-unit').textContent = 'g';
        document.getElementById('timer-volume-unit').textContent = 'g';
        document.getElementById('temp-unit-label').textContent = 'Â°C';
    }
    
    // Refresh all displayed values with new units
    updateTargets();
    
    // If we have brew results, update those too
    if (document.getElementById('dose-brew').textContent !== '--') {
        const actualDose = parseInt(document.getElementById('dose-input').value);
        if (unit === 'imperial') {
            document.getElementById('dose-brew').textContent = convertToDisplay(actualDose, 'weight');
            if (currentBrewVolume > 0) {
                document.getElementById('volume-brew').textContent = convertToDisplay(currentBrewVolume, 'weight');
            }
        } else {
            document.getElementById('dose-brew').textContent = `${actualDose}g`;
            if (currentBrewVolume > 0) {
                document.getElementById('volume-brew').textContent = `${currentBrewVolume}g`;
            }
        }
    }
    
    // Update shot temperature display
    const shotTemp = document.getElementById('shot-temp');
    if (shotTemp) {
        const tempC = brewmieData.machine.shotTemp || 93;
        if (unit === 'imperial') {
            shotTemp.value = Math.round(tempC * 9/5 + 32);
        } else {
            shotTemp.value = tempC;
        }
    }
    
    saveData();
    updateWelcomeMessage();
    
    // Update weather display with new units
    if (currentShot.weather) {
        updateWeatherDisplay(currentShot.weather);
    }
}

// Machine Profile
function getCurrentMachineProfile() {
    const brand = brewmieData.machine.brand;
    const model = brewmieData.machine.model;
    return EQUIPMENT_PROFILES[brand]?.[model] || EQUIPMENT_PROFILES.other.generic;
}

function updateMachineModels() {
    const brand = document.getElementById('machine-brand').value;
    const modelSelect = document.getElementById('machine-model');
    
    const models = {
        breville: [
            { value: 'express', text: 'Barista Express' },
            { value: 'pro', text: 'Barista Pro' },
            { value: 'touch', text: 'Barista Touch' }
        ],
        delonghi: [
            { value: 'specialista', text: 'La Specialista' },
            { value: 'dedica', text: 'Dedica' }
        ],
        sage: [
            { value: 'duo-temp', text: 'Duo-Temp Pro' },
            { value: 'bambino', text: 'Bambino Plus' }
        ],
        gaggia: [
            { value: 'classic', text: 'Classic' }
        ],
        other: [
            { value: 'generic', text: 'Generic Model' }
        ]
    };
    
    modelSelect.innerHTML = '';
    models[brand]?.forEach(model => {
        const option = document.createElement('option');
        option.value = model.value;
        option.textContent = model.text;
        modelSelect.appendChild(option);
    });
    
    brewmieData.machine.brand = brand;
    saveData();
    
    setTimeout(() => updateMachineProfile(), 100);
}

function updateMachineProfile() {
    const brand = document.getElementById('machine-brand').value;
    const model = document.getElementById('machine-model').value;
    const profile = EQUIPMENT_PROFILES[brand]?.[model] || EQUIPMENT_PROFILES.other.generic;
    
    brewmieData.machine.brand = brand;
    brewmieData.machine.model = model;
    brewmieData.machine.profile = profile;
    brewmieData.machine.maxGrind = profile.grindRange[1];
    
    const grindInput = document.getElementById('grind-input');
    grindInput.min = profile.grindRange[0];
    grindInput.max = profile.grindRange[1];
    
    if (brewmieData.currentGrind < 1) {
        brewmieData.currentGrind = 1;
        grindInput.value = brewmieData.currentGrind;
    } else if (brewmieData.currentGrind > 50) {
        brewmieData.currentGrind = 50;
        grindInput.value = brewmieData.currentGrind;
    }
    
    const basketSize = document.getElementById('basket-size').value;
    const recommendedDose = profile.recommendedDose[basketSize];
    if (recommendedDose) {
        document.getElementById('dose-input').value = recommendedDose;
    }
    
    updateTargets();
    saveData();
    checkSetupReminder();
}

// Grinder Functions
function updateGrinderType() {
    const type = document.getElementById('grinder-type').value;
    const standaloneSection = document.getElementById('standalone-grinder-section');
    
    brewmieData.grinder.type = type;
    
    if (type === 'standalone') {
        standaloneSection.style.display = 'block';
    } else {
        standaloneSection.style.display = 'none';
        // Use integrated grinder based on machine
        const machineKey = `${brewmieData.machine.brand}-${brewmieData.machine.model}`;
        if (GRINDER_PROFILES[machineKey]) {
            brewmieData.grinder.key = machineKey;
        } else {
            brewmieData.grinder.key = 'other';
        }
        updateGrindRange();
    }
    
    saveData();
}

function updateGrinderModels() {
    const brand = document.getElementById('grinder-brand').value;
    const modelSelect = document.getElementById('grinder-model');
    
    const models = {
        'baratza': [
            { value: 'baratza-encore', text: 'Encore' },
            { value: 'baratza-virtuoso', text: 'Virtuoso+' },
            { value: 'baratza-sette', text: 'Sette 270' }
        ],
        'eureka': [
            { value: 'eureka-mignon', text: 'Mignon' },
            { value: 'eureka-specialita', text: 'Specialita' }
        ],
        'niche': [
            { value: 'niche-zero', text: 'Zero' }
        ],
        'fellow': [
            { value: 'fellow-ode', text: 'Ode' },
            { value: 'fellow-opus', text: 'Opus' }
        ],
        'df64': [
            { value: 'df64', text: 'Standard' }
        ],
        '1zpresso': [
            { value: '1zpresso-jx', text: 'JX-Pro' }
        ],
        'comandante': [
            { value: 'comandante', text: 'C40' }
        ],
        'other': [
            { value: 'other', text: 'Custom Grinder' }
        ]
    };
    
    modelSelect.innerHTML = '<option value="">Select model...</option>';
    models[brand]?.forEach(model => {
        const option = document.createElement('option');
        option.value = model.value;
        option.textContent = model.text;
        modelSelect.appendChild(option);
    });
}

function updateGrinderProfile() {
    const modelKey = document.getElementById('grinder-model').value;
    const customRange = document.getElementById('custom-grind-range');
    const grinderInfo = document.getElementById('grinder-info');
    
    if (!modelKey) return;
    
    brewmieData.grinder.key = modelKey;
    
    if (modelKey === 'other') {
        customRange.style.display = 'block';
        grinderInfo.style.display = 'none';
    } else {
        customRange.style.display = 'none';
        const profile = GRINDER_PROFILES[modelKey];
        if (profile) {
            grinderInfo.style.display = 'block';
            document.getElementById('grinder-range-info').textContent = 
                profile.decimal ? `Range: ${profile.min}-${profile.max} (0.1 increments)` : 
                profile.clicks ? `Range: ${profile.min}-${profile.max} clicks` :
                `Range: ${profile.min}-${profile.max}`;
            document.getElementById('grinder-type-info').textContent = 
                profile.decimal ? 'Stepless adjustment' : 
                profile.clicks ? 'Click adjustment' :
                'Stepped adjustment';
        }
    }
    
    updateGrindRange();
    saveData();
}

function updateGrindRange() {
    const grinderKey = brewmieData.grinder.key;
    const profile = GRINDER_PROFILES[grinderKey];
    const grindInput = document.getElementById('grind-input');
    
    if (profile) {
        grindInput.min = profile.min;
        grindInput.max = profile.max;
        
        if (profile.decimal) {
            grindInput.step = 0.1;
        } else {
            grindInput.step = 1;
        }
        
        // Adjust current grind if out of range
        if (brewmieData.currentGrind < profile.min) {
            brewmieData.currentGrind = profile.min;
            grindInput.value = profile.min;
        } else if (brewmieData.currentGrind > profile.max) {
            brewmieData.currentGrind = profile.max;
            grindInput.value = profile.max;
        }
    }
}

function updateRoastAge() {
    const roastDate = document.getElementById('roast-date')?.value;
    const ageEl = document.getElementById('roast-age');
    if (roastDate && ageEl) {
        const days = Math.floor((new Date() - new Date(roastDate)) / (1000 * 60 * 60 * 24));
        ageEl.textContent = `Days since roast: ${days}`;
    } else if (ageEl) {
        ageEl.textContent = 'Days since roast: --';
    }
}

// Maintenance Functions
function setMaintenanceToday(type) {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById(`${type}-date`).value = today;
    
    const capitalizedType = type.charAt(0).toUpperCase() + type.slice(1);
    brewmieData.maintenance[`last${capitalizedType}`] = today;
    
    // Reset shot counts
    brewmieData.maintenance.shotCounts[`since${capitalizedType}`] = 0;
    
    saveData();
    checkSetupReminder();
    checkMaintenanceAlerts();
    updateMaintenanceNotes();
}

// Weather System - Fixed with proper error handling
async function loadWeather() {
    try {
        // Use IP-based location (works everywhere, no permissions needed)
        const ipResponse = await fetch('https://ipapi.co/json/');
        const ipData = await ipResponse.json();
        
        // Get weather for IP location
        const weatherResponse = await fetch(
            `https://api.open-meteo.com/v1/forecast?latitude=${ipData.latitude}&longitude=${ipData.longitude}&current=temperature_2m,relative_humidity_2m&timezone=auto`
        );
        
        if (!weatherResponse.ok) throw new Error('Weather API failed');
        
        const weatherData = await weatherResponse.json();
        
        const weather = {
            temp: Math.round(weatherData.current.temperature_2m),
            humidity: Math.round(weatherData.current.relative_humidity_2m),
            location: `${ipData.city}, ${ipData.country_code}`
        };
        
        updateWeatherDisplay(weather);
        
    } catch (error) {
        console.error('Weather error:', error);
        // Silent fallback - just show time without weather
        updateWeatherDisplay(null);
    }
}

function updateWeatherDisplay(weather) {
    const now = new Date();
    const day = now.toLocaleDateString('en-AU', { weekday: 'short' });
    const time = now.toLocaleTimeString('en-AU', { 
        hour: 'numeric', 
        minute: '2-digit', 
        hour12: true 
    }).toLowerCase();
    
    if (!weather) {
        // Just show time if weather fails
        document.getElementById('weather-strip').textContent = `${day} ${time}`;
        currentShot.weather = { temp: 20, humidity: 50 };
        return;
    }
    
    currentShot.weather = weather;
    
    // Handle unit conversion
    const tempDisplay = brewmieData.units === 'imperial' ? 
        Math.round(weather.temp * 9/5 + 32) + 'Â°F' : 
        weather.temp + 'Â°C';
    
    document.getElementById('weather-strip').textContent = 
        `${day} ${time} â€¢ ${tempDisplay}, ${weather.humidity}% humidity â€¢ ${weather.location}`;
}

// Welcome Messages
function updateWelcomeMessage() {
    const hour = new Date().getHours();
    let message;
    
    if (hour >= 5 && hour < 12) {
        message = "Good morning! Ready for perfect coffee?";
    } else if (hour >= 12 && hour < 18) {
        message = "Good afternoon! Time for your next perfect shot?";
    } else if (hour >= 18 && hour < 24) {
        message = "Good evening! One more perfect brew?";
    } else {
        message = "Late night brewing? Perfection.";
    }
    
    document.getElementById('welcome-message').textContent = message;
}

// Session Detection
function updateSessionLabel() {
    const now = new Date();
    const hour = now.getHours();
    const isAfternoon = hour >= 12;
    
    const label = document.getElementById('session-label');
    const checkbox = document.getElementById('session-checkbox');
    
    if (isAfternoon) {
        label.textContent = 'First shot of the arvo?';
        const lastUsed = brewmieData.lastUsed ? new Date(brewmieData.lastUsed) : null;
        const hoursAgo = lastUsed ? (now - lastUsed) / (1000 * 60 * 60) : 24;
        checkbox.checked = hoursAgo > 3;
    } else {
        label.textContent = 'First shot of the day?';
        const today = now.toDateString();
        const lastUsedDate = brewmieData.lastUsed ? new Date(brewmieData.lastUsed).toDateString() : null;
        checkbox.checked = lastUsedDate !== today;
    }
}

// Input Change Detection
function onInputChange(inputId) {
    if (brewingPhase === 'post-brew' || brewingPhase === 'ready-to-apply') {
        // Clear actuals
        document.getElementById('grind-brew').textContent = '--';
        document.getElementById('dose-brew').textContent = '--';
        document.getElementById('volume-brew').textContent = '--';
        document.getElementById('time-brew').textContent = '--';
        document.getElementById('tamp-brew').textContent = '--';
        
        // Reset ADJUST header color
        const adjustHeader = document.getElementById('adjust-header');
        if (adjustHeader) {
            adjustHeader.style.backgroundColor = '';
            adjustHeader.style.color = '';
        }
        
        // Hide and reset hero score
        document.getElementById('hero-score-section').classList.remove('show');
        document.getElementById('hero-score').textContent = '--';
        document.getElementById('hero-score').className = 'score-display';
        document.getElementById('feedback-message').textContent = '';
        
        // Reset to pre-brew state
        setBrewingPhase('ready-to-brew');
    }
    
    // Update targets
    updateTargets();
    if (inputId) {
        validateInput(inputId.replace('-input', '').replace('-target', ''));
    }
    saveData();
}

// Metric Adjustments
function adjustMetric(metric, change) {
    const input = document.getElementById(`${metric}-input`) || document.getElementById(`${metric}-target`);
    if (!input) return;
    
    const current = parseInt(input.value) || 0;
    const min = parseInt(input.min) || 0;
    const max = parseInt(input.max) || 100;
    const newValue = Math.max(min, Math.min(max, current + change));
    
    input.value = newValue;
    
    if (!validateInput(metric)) {
        input.value = current;
        return;
    }
    
    // Flash animation
    const buttons = document.querySelectorAll('.micro-btn');
    buttons.forEach(btn => {
        const parent = btn.parentElement;
        if (parent && parent.querySelector(`#${metric}-input, #${metric}-target`)) {
            if ((change === -1 && btn.textContent === '-') || (change === 1 && btn.textContent === '+')) {
                btn.classList.add('flash-green');
                setTimeout(() => btn.classList.remove('flash-green'), 200);
            }
        }
    });
    
    if (metric === 'grind') {
        brewmieData.currentGrind = newValue;
        document.getElementById('grind-adjust').textContent = newValue;
    } else if (metric === 'dose') {
        document.getElementById('dose-adjust').textContent = `${newValue}g`;
    }
    
    onInputChange();
    updateTargets();
    saveData();
}

// Validation System
function validateInput(metric) {
    const input = document.getElementById(`${metric}-input`) || document.getElementById(`${metric}-target`);
    if (!input) return true;
    
    const value = parseFloat(input.value);
    let isValid = true;
    let message = '';
    
    switch(metric) {
        case 'grind':
            const profile = getCurrentMachineProfile();
            if (value < profile.grindRange[0] || value > profile.grindRange[1]) {
                isValid = false;
                message = `Grind setting ${value} outside your machine's range (${profile.grindRange[0]}-${profile.grindRange[1]})`;
            }
            break;
        case 'dose':
            if (value < 7 || value > 30) {
                isValid = false;
                message = `Dose ${value}g is extreme - typical range is 7-30g`;
            }
            break;
        case 'volume':
            const dose = parseFloat(document.getElementById('dose-input').value);
            const ratio = value / dose;
            if (ratio < 1.2 || ratio > 4.0) {
                isValid = false;
                message = `Brew ratio ${ratio.toFixed(1)}:1 is unusual - typical range is 1.2-4.0:1`;
            }
            break;
        case 'time':
            if (value < 10 || value > 60) {
                isValid = false;
                message = `Extraction time ${value}s is extreme - typical range is 10-60s`;
            }
            break;
    }
    
    if (!isValid) {
        showValidationAlert(message);
        brewmieData.validationFlags.push({
            metric: metric,
            value: value,
            message: message,
            timestamp: Date.now()
        });
    } else {
        hideValidationAlert();
    }
    
    return isValid;
}

function showValidationAlert(message) {
    const alert = document.getElementById('validation-alert');
    alert.textContent = message;
    alert.classList.add('show');
    setTimeout(() => hideValidationAlert(), 5000);
}

function hideValidationAlert() {
    const alert = document.getElementById('validation-alert');
    alert.classList.remove('show');
}

// Update Targets
function updateTargets() {
    const dose = parseInt(document.getElementById('dose-input').value) || 18;
    const volume = parseInt(document.getElementById('volume-target').value) || 36;
    const profile = getCurrentMachineProfile();
    const roast = document.getElementById('roast-select')?.value || brewmieData.beans.roastLevel;
    const roastProfile = BASELINE_EXTRACTION_DATA.roastProfiles[roast];
    
    // Update displays with units
    if (brewmieData.units === 'imperial') {
        document.getElementById('dose-adjust').textContent = convertToDisplay(dose, 'weight');
        document.getElementById('volume-adjust').textContent = convertToDisplay(volume, 'weight');
    } else {
        document.getElementById('dose-adjust').textContent = `${dose}g`;
        document.getElementById('volume-adjust').textContent = `${volume}g`;
    }
    
    const roastDate = document.getElementById('roast-date')?.value || brewmieData.beans.roastDate;
    const beanAge = roastDate ? Math.floor((new Date() - new Date(roastDate)) / (1000 * 60 * 60 * 24)) : 14;
    
    let targetTime = parseInt(document.getElementById('time-target').value) || roastProfile.optimalTime;
    document.getElementById('time-adjust').textContent = `${targetTime}s`;
    
    document.getElementById('grind-adjust').textContent = brewmieData.currentGrind;
}

// Load Input Settings
function loadInputSettings() {
    document.getElementById('grind-input').value = brewmieData.currentGrind;
    document.getElementById('grind-adjust').textContent = brewmieData.currentGrind;
    
    // Update tamp display based on type
    if (brewmieData.tampType === 'manual') {
        document.getElementById('manual-tamp-control').style.display = 'flex';
        document.getElementById('spring-tamp-control').style.display = 'none';
        document.getElementById('auto-tamp-control').style.display = 'none';
        document.getElementById('tamp-display').textContent = TAMP_SYMBOLS[brewmieData.tampLevel];
        document.getElementById('tamp-adjust').textContent = TAMP_SYMBOLS[1];
    } else if (brewmieData.tampType === 'spring') {
        document.getElementById('manual-tamp-control').style.display = 'none';
        document.getElementById('spring-tamp-control').style.display = 'flex';
        document.getElementById('auto-tamp-control').style.display = 'none';
        document.getElementById('spring-input').value = brewmieData.springPressure;
        document.getElementById('tamp-adjust').textContent = brewmieData.springPressure;
    } else if (brewmieData.tampType === 'automatic') {
        document.getElementById('manual-tamp-control').style.display = 'none';
        document.getElementById('spring-tamp-control').style.display = 'none';
        document.getElementById('auto-tamp-control').style.display = 'flex';
        document.getElementById('auto-tamp-display').textContent = brewmieData.autoPressure;
        document.getElementById('tamp-adjust').textContent = brewmieData.autoPressure;
    }
    
    updateTargets();
    updateBeanLabel();
}

// Brewing Process
function startBrew() {
    if (!validateBrewSetup()) {
        return;
    }
    
    currentShot.inputGrind = brewmieData.currentGrind;
    currentShot.inputDose = parseInt(document.getElementById('dose-input').value) || 18;
    currentShot.targetVolume = parseInt(document.getElementById('volume-target').value) || 36;
    currentShot.targetTime = parseInt(document.getElementById('time-target').value) || 28;
    
    const brewBtn = document.getElementById('brew-btn');
    brewBtn.classList.add('brewing');
    brewBtn.textContent = 'BREWING...';
    
    // Reduced animation time to 1500ms
    setTimeout(() => {
        brewBtn.classList.remove('brewing');
        brewBtn.textContent = 'BREW';
        openDataEntry();
    }, 1500);
}

function validateBrewSetup() {
    const dose = parseInt(document.getElementById('dose-input').value);
    const volume = parseInt(document.getElementById('volume-target').value);
    const time = parseInt(document.getElementById('time-target').value);
    
    const ratio = volume / dose;
    if (ratio > 4.5) {
        showValidationAlert(`Brew ratio ${ratio.toFixed(1)}:1 is too high - reduce volume or increase dose`);
        return false;
    }
    if (ratio < 1.0) {
        showValidationAlert(`Brew ratio ${ratio.toFixed(1)}:1 is too low - increase volume or reduce dose`);
        return false;
    }
    
    if (time < 15) {
        showValidationAlert(`Target time ${time}s is very fast - shots may be sour`);
        return false;
    }
    if (time > 45) {
        showValidationAlert(`Target time ${time}s is very slow - shots may be bitter`);
        return false;
    }
    
    return true;
}

// Data Entry Functions
function openDataEntry() {
    document.getElementById('manual-volume').value = document.getElementById('volume-target').value;
    document.getElementById('manual-time').value = document.getElementById('time-target').value;
    document.getElementById('timer-volume').value = document.getElementById('volume-target').value;
    
    document.getElementById('timer-display').textContent = '00.0';
    document.getElementById('start-btn').disabled = false;
    document.getElementById('stop-btn').disabled = true;
    document.getElementById('save-timer-btn').style.display = 'none';
    
    document.getElementById('data-entry-modal').classList.add('show');
}

function closeDataEntry() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    document.getElementById('data-entry-modal').classList.remove('show');
}

function selectEntryMode(mode) {
    document.querySelectorAll('.entry-option-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    if (mode === 'manual') {
        document.getElementById('manual-inputs').classList.add('show');
        document.getElementById('timer-section').classList.remove('show');
    } else {
        document.getElementById('manual-inputs').classList.remove('show');
        document.getElementById('timer-section').classList.add('show');
    }
}

function startTimer() {
    timerStartTime = Date.now();
    document.getElementById('start-btn').disabled = true;
    document.getElementById('stop-btn').disabled = false;
    
    timerInterval = setInterval(() => {
        const elapsed = (Date.now() - timerStartTime) / 1000;
        document.getElementById('timer-display').textContent = elapsed.toFixed(1);
    }, 100);
}

function stopTimer() {
    if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
    }
    
    document.getElementById('start-btn').disabled = false;
    document.getElementById('stop-btn').disabled = true;
    document.getElementById('save-timer-btn').style.display = 'block';
}

function saveManualData() {
    const volumeRaw = parseFloat(document.getElementById('manual-volume').value) || 36;
    const volume = brewmieData.units === 'imperial' ? 
        Math.round(volumeRaw / 0.035274) : volumeRaw; // Convert oz to g if imperial
    const time = parseFloat(document.getElementById('manual-time').value) || 28;
    
    currentBrewVolume = volume;
    currentBrewTime = time;
    currentShot.actualVolume = volume;
    currentShot.actualTime = time;
    
    processBrewResults(volume, time);
    closeDataEntry();
}

function saveTimerData() {
    const volumeRaw = parseFloat(document.getElementById('timer-volume').value) || 36;
    const volume = brewmieData.units === 'imperial' ? 
        Math.round(volumeRaw / 0.035274) : volumeRaw; // Convert oz to g if imperial
    const timeText = document.getElementById('timer-display').textContent;
    const time = parseFloat(timeText) || 28;
    
    currentBrewVolume = volume;
    currentBrewTime = time;
    currentShot.actualVolume = volume;
    currentShot.actualTime = time;
    
    processBrewResults(volume, time);
    closeDataEntry();
}

function processBrewResults(volume, time) {
    // Update ACTUAL column
    document.getElementById('grind-brew').textContent = brewmieData.currentGrind;
    
    const actualDose = parseInt(document.getElementById('dose-input').value);
    if (brewmieData.units === 'imperial') {
        document.getElementById('dose-brew').textContent = convertToDisplay(actualDose, 'weight');
        document.getElementById('volume-brew').textContent = convertToDisplay(volume, 'weight');
    } else {
        document.getElementById('dose-brew').textContent = `${actualDose}g`;
        document.getElementById('volume-brew').textContent = `${volume}g`;
    }
    
    document.getElementById('time-brew').textContent = `${time}s`;
    
    // Display tamp based on type - no wrapper needed
    if (brewmieData.tampType === 'manual') {
        document.getElementById('tamp-brew').textContent = TAMP_SYMBOLS[brewmieData.tampLevel];
    } else if (brewmieData.tampType === 'spring') {
        document.getElementById('tamp-brew').textContent = brewmieData.springPressure;
    } else {
        document.getElementById('tamp-brew').textContent = brewmieData.autoPressure;
    }
    
    currentShot.actualGrind = brewmieData.currentGrind;
    currentShot.actualDose = actualDose;
    
    calculateStrictScore();
    generateRecommendations();
    
    // Log the shot immediately (without taste)
    currentShot.taste = 'none';
    logShot();
    
    // Store the shot ID for potential taste update
    window.currentBrewShotId = currentShot.id;
    
    setBrewingPhase('post-brew');
}

// Recipe Generator Algorithm
function generateRecipe(beanProfile) {
    const profile = getCurrentMachineProfile();
    const userHistory = brewmieData.shots.filter(s => s.score >= 85);
    
    // Base recipe from roast level
    let recipe = {
        grind: null,
        dose: 18,
        yield: 36,
        time: 28
    };
    
    // Roast level base settings
    const roastSettings = {
        light: { timeBase: 32, ratioBase: 1.8, grindOffset: -1 },
        medium: { timeBase: 28, ratioBase: 2.0, grindOffset: 0 },
        dark: { timeBase: 25, ratioBase: 2.2, grindOffset: 1 }
    };
    
    const roast = roastSettings[beanProfile.roastLevel || 'medium'];
    recipe.time = roast.timeBase;
    recipe.yield = Math.round(recipe.dose * roast.ratioBase);
    
    // Calculate grind based on user's history or machine defaults
    if (userHistory.length >= 3) {
        // User has history - use their typical range
        const similarRoasts = userHistory.filter(s => 
            s.roastLevel === (beanProfile.roastLevel === 'light' ? 1 : 
                             beanProfile.roastLevel === 'dark' ? 3 : 2)
        );
        
        if (similarRoasts.length > 0) {
            // Average their successful grinds for similar roasts
            const avgGrind = similarRoasts.reduce((sum, s) => sum + s.grind, 0) / similarRoasts.length;
            recipe.grind = Math.round(avgGrind);
        } else {
            // Use their general grind offset from all shots
            const avgGrind = userHistory.reduce((sum, s) => sum + s.grind, 0) / userHistory.length;
            recipe.grind = Math.round(avgGrind + roast.grindOffset);
        }
    } else {
        // No history - use safe starting point (30% of grinder range)
        recipe.grind = Math.round(profile.grindRange[1] * 0.3);
    }
    
    // Apply modifiers based on optional bean details
    if (beanProfile.origin) {
        const originModifiers = {
            'Africa': { grind: -0.5, time: 2 },
            'Central America': { grind: 0, time: 0 },
            'South America': { grind: 0.5, time: -1 },
            'Asia-Pacific': { grind: 0.5, time: 1 }
        };
        const mod = originModifiers[beanProfile.origin] || { grind: 0, time: 0 };
        recipe.grind = Math.round(recipe.grind + mod.grind);
        recipe.time += mod.time;
    }
    
    if (beanProfile.process) {
        const processModifiers = {
            'washed': { grind: -0.5 },
            'natural': { grind: 1 },
            'honey': { grind: 0.5 }
        };
        const mod = processModifiers[beanProfile.process] || { grind: 0 };
        recipe.grind = Math.round(recipe.grind + mod.grind);
    }
    
    if (beanProfile.altitude === 'high') {
        recipe.grind = Math.round(recipe.grind - 0.5);
    }
    
    // Ensure grind is within machine limits
    recipe.grind = Math.max(profile.grindRange[0], 
                           Math.min(profile.grindRange[1], recipe.grind));
    
    // Calculate confidence based on available data
    let confidence = 0.3; // Base confidence
    if (userHistory.length >= 10) confidence += 0.3;
    if (userHistory.filter(s => s.roastLevel === 
        (beanProfile.roastLevel === 'light' ? 1 : 
         beanProfile.roastLevel === 'dark' ? 3 : 2)).length > 0) confidence += 0.2;
    if (beanProfile.origin) confidence += 0.1;
    if (beanProfile.process) confidence += 0.1;
    
    recipe.confidence = Math.min(1, confidence);
    
    return recipe;
}

// Create new bean profile
function createBeanProfile(details) {
    const profile = {
        id: Date.now(),
        created: new Date().toISOString(),
        roastLevel: details.roastLevel || 'medium',
        origin: details.origin || null,
        process: details.process || null,
        altitude: details.altitude || null,
        variety: details.variety || null,
        name: details.name || `${details.roastLevel || 'Medium'} Roast`,
        generatedRecipe: null,
        optimalRecipe: null,
        shotsWithBean: 0
    };
    
    // Generate initial recipe
    profile.generatedRecipe = generateRecipe(profile);
    
    return profile;
}

// Clear beans with expiry
function clearBeans() {
    // Check if there are any beans to clear
    if (!brewmieData.beans.roastDate && !brewmieData.beans.roastLevel && !brewmieData.currentBeanProfile) {
        showAlert('No beans to clear. Set up beans in the Setup tab first.', 'info');
        return;
    }
    
    const modal = document.createElement('div');
    modal.className = 'app-modal-wrapper';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="app-modal info">
            <div style="font-weight: 600; margin-bottom: 12px;">Clear Current Beans?</div>
            <div style="font-size: 12px; margin-bottom: 12px;">This temporarily ignores your bean settings. When do you expect to use new beans?</div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                <button class="option-btn" onclick="confirmClearBeans(7, this)">1 Week</button>
                <button class="option-btn" onclick="confirmClearBeans(14, this)">2 Weeks</button>
                <button class="option-btn" onclick="confirmClearBeans(21, this)">3 Weeks</button>
            </div>
            <button class="modal-cancel-btn" style="width: 100%; margin-top: 8px;" onclick="this.closest('.app-modal-wrapper').remove()">Cancel</button>
        </div>
    `;
    document.body.appendChild(modal);
}

function confirmClearBeans(days, button) {
    brewmieData.currentBeanProfile = null;
    brewmieData.beanClearedUntil = Date.now() + (days * 24 * 60 * 60 * 1000);
    updateBeanLabel();
    saveData();
    button.closest('.app-modal-wrapper').remove();
}

function updateBeanLabel() {
    const label = document.getElementById('current-bean-label');
    if (!label) return;
    
    // Prioritize current bean profile over setup beans
    if (brewmieData.currentBeanProfile && !brewmieData.beanClearedUntil) {
        const profile = brewmieData.currentBeanProfile;
        const age = Math.floor((Date.now() - new Date(profile.created)) / (24 * 60 * 60 * 1000));
        label.textContent = `${profile.name} (${age} days) - Recipe: Grind ${profile.generatedRecipe.grind}`;
        label.style.fontWeight = '600';
        label.style.color = 'var(--accent-green)';
        return;
    }
    
    // Check if beans are set up
    const hasRoastDate = brewmieData.beans.roastDate;
    const hasRoastLevel = brewmieData.beans.roastLevel;
    
    if (brewmieData.beanClearedUntil && brewmieData.beanClearedUntil > Date.now()) {
        // Beans are temporarily cleared
        const daysLeft = Math.ceil((brewmieData.beanClearedUntil - Date.now()) / (24 * 60 * 60 * 1000));
        label.textContent = `Beans cleared (${daysLeft} days left)`;
        label.style.fontWeight = '400';
        label.style.color = 'var(--text-tertiary)';
    } else if (hasRoastDate || hasRoastLevel) {
        // Show current beans from setup
        const roastAge = brewmieData.beans.roastDate ? 
            Math.floor((Date.now() - new Date(brewmieData.beans.roastDate)) / (24 * 60 * 60 * 1000)) : null;
        
        let beanText = '';
        if (brewmieData.beans.brand) beanText += brewmieData.beans.brand + ' ';
        if (brewmieData.beans.type) beanText += brewmieData.beans.type + ' ';
        if (!beanText) beanText = `${brewmieData.beans.roastLevel || 'Medium'} roast`;
        if (roastAge !== null) beanText += ` (${roastAge} days)`;
        
        label.textContent = beanText.trim();
        label.style.fontWeight = '600';
        label.style.color = 'var(--text-primary)';
    } else {
        label.textContent = 'No beans selected';
        label.style.fontWeight = '400';
        label.style.color = 'var(--text-secondary)';
    }
}

function openNewBeansModal() {
    const modal = document.createElement('div');
    modal.className = 'app-modal-wrapper';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="app-modal" style="max-width: 360px;">
            <div class="modal-header">
                <h3 style="font-size: 16px; margin: 0;">New Bean Setup</h3>
                <button class="modal-close" onclick="this.closest('.app-modal-wrapper').remove()">Ã—</button>
            </div>
            
            <div style="padding: 16px;">
                <!-- Required -->
                <div style="margin-bottom: 12px;">
                    <label class="setup-label">Roast Level *</label>
                    <select id="new-roast-level" class="setup-input">
                        <option value="light">Light</option>
                        <option value="medium" selected>Medium</option>
                        <option value="dark">Dark</option>
                    </select>
                </div>
                
                <!-- Optional fields collapsed by default -->
                <div style="background: var(--cream); border-radius: 6px; padding: 8px; margin-bottom: 12px;">
                    <div style="font-size: 11px; color: var(--text-tertiary); margin-bottom: 8px; cursor: pointer;" onclick="toggleBeanDetails(this)">
                        â–¶ Add details for better recipe (optional)
                    </div>
                    <div id="bean-details" style="display: none;">
                        <div style="margin-bottom: 8px;">
                            <label class="setup-label">Origin/Region</label>
                            <select id="new-origin" class="setup-input">
                                <option value="">Unknown</option>
                                <option value="Africa">Africa (Ethiopia, Kenya)</option>
                                <option value="Central America">Central America</option>
                                <option value="South America">South America</option>
                                <option value="Asia-Pacific">Asia-Pacific</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <label class="setup-label">Process Method</label>
                            <select id="new-process" class="setup-input">
                                <option value="">Unknown</option>
                                <option value="washed">Washed/Wet</option>
                                <option value="natural">Natural/Dry</option>
                                <option value="honey">Honey/Semi-washed</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <label class="setup-label">Growing Altitude</label>
                            <select id="new-altitude" class="setup-input">
                                <option value="">Unknown</option>
                                <option value="high">High (>1500m)</option>
                                <option value="medium">Medium (1000-1500m)</option>
                                <option value="low">Low (<1000m)</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 8px;">
                            <label class="setup-label">Bean Name (optional)</label>
                            <input type="text" id="new-bean-name" class="setup-input" placeholder="e.g. Ethiopia Yirgacheffe">
                        </div>
                    </div>
                </div>
                
                <!-- Recipe Preview -->
                <div id="recipe-preview" style="background: var(--off-white); border: 1px solid var(--accent-green); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px;">Recommended Starting Point:</div>
                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">
                        Calculating...
                    </div>
                </div>
                
                <!-- Actions -->
                <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 8px;">
                    <button onclick="this.closest('.app-modal-wrapper').remove()" style="background: var(--grey-light); color: white; border: none; padding: 10px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="applyNewBeans()" style="background: var(--accent-green); color: white; border: none; padding: 10px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer;">
                        Apply Recipe & Start Brewing
                    </button>
                </div>
                
                <div style="margin-top: 8px; text-align: center;">
                    <a href="#" onclick="event.preventDefault(); switchTab('setup'); this.closest('.app-modal-wrapper').remove();" style="font-size: 11px; color: var(--text-tertiary);">
                        Go to full Setup â†’
                    </a>
                </div>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    // Auto-update preview when fields change
    modal.querySelectorAll('select, input').forEach(field => {
        field.addEventListener('change', () => updateRecipePreview());
    });
    
    // Initial preview
    updateRecipePreview();
}

function toggleBeanDetails(element) {
    const details = document.getElementById('bean-details');
    if (details.style.display === 'none') {
        details.style.display = 'block';
        element.innerHTML = 'â–¼ Add details for better recipe (optional)';
    } else {
        details.style.display = 'none';
        element.innerHTML = 'â–¶ Add details for better recipe (optional)';
    }
}

function updateRecipePreview() {
    const preview = document.getElementById('recipe-preview');
    if (!preview) return;
    
    const beanProfile = {
        roastLevel: document.getElementById('new-roast-level')?.value || 'medium',
        origin: document.getElementById('new-origin')?.value || null,
        process: document.getElementById('new-process')?.value || null,
        altitude: document.getElementById('new-altitude')?.value || null
    };
    
    const recipe = generateRecipe(beanProfile);
    const confidence = Math.round(recipe.confidence * 100);
    
    preview.innerHTML = `
        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 6px;">
            Recommended Starting Point (${confidence}% confidence):
        </div>
        <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">
            Grind: ${recipe.grind} | ${recipe.dose}g â†’ ${recipe.yield}g | ${recipe.time} seconds
        </div>
    `;
}

function applyNewBeans() {
    const beanProfile = createBeanProfile({
        roastLevel: document.getElementById('new-roast-level').value,
        origin: document.getElementById('new-origin')?.value || null,
        process: document.getElementById('new-process')?.value || null,
        altitude: document.getElementById('new-altitude')?.value || null,
        name: document.getElementById('new-bean-name')?.value || null
    });
    
    // Save to brewmieData
    brewmieData.currentBeanProfile = beanProfile;
    brewmieData.beanProfiles.push(beanProfile);
    brewmieData.beanClearedUntil = null;
    
    // Update setup beans
    brewmieData.beans.roastLevel = beanProfile.roastLevel;
    brewmieData.beans.roastDate = new Date().toISOString().split('T')[0];
    
    // Apply the recipe to current settings
    const recipe = beanProfile.generatedRecipe;
    document.getElementById('grind-input').value = recipe.grind;
    document.getElementById('dose-input').value = recipe.dose;
    document.getElementById('volume-target').value = recipe.yield;
    document.getElementById('time-target').value = recipe.time;
    
    brewmieData.currentGrind = recipe.grind;
    
    // Update displays
    loadInputSettings();
    updateTargets();
    updateBeanLabel();
    saveData();
    
    // Close modal
    document.querySelector('.app-modal-wrapper').remove();
    
    // Show success message
    showAlert(`Recipe applied! Start with grind ${recipe.grind} targeting ${recipe.time}s extraction.`, 'success');
}

// Scoring Algorithm
function calculateStrictScore() {
    const volumeTarget = parseInt(document.getElementById('volume-target').value) || 36;
    const timeTarget = parseInt(document.getElementById('time-target').value) || 28;
    const actualVolume = currentShot.actualVolume || 0;
    const actualTime = currentShot.actualTime || 0;
    
    let volumeScore = 100;
    let timeScore = 100;
    
    // Volume scoring
    const volumeDiff = Math.abs(actualVolume - volumeTarget);
    const volumePercent = (volumeDiff / volumeTarget) * 100;
    
    if (volumePercent <= 3) {
        volumeScore = 100;
    } else if (volumePercent <= 10) {
        volumeScore = 90 - (volumePercent - 3) * 2;
    } else if (volumePercent <= 25) {
        volumeScore = 76 - (volumePercent - 10) * 2.4;
    } else {
        volumeScore = Math.max(20, 40 - (volumePercent - 25) * 0.8);
    }
    
    // Time scoring
    const timeDiff = actualTime - timeTarget;
    const timeDiffAbs = Math.abs(timeDiff);
    const timePercent = (timeDiffAbs / timeTarget) * 100;
    
    if (timePercent <= 5) {
        timeScore = 100;
    } else if (timePercent <= 15) {
        timeScore = 90 - (timePercent - 5) * 1.5;
    } else if (timePercent <= 30) {
        timeScore = 75 - (timePercent - 15) * 2;
    } else {
        timeScore = Math.max(25, 45 - (timePercent - 30) * 0.5);
    }
    
    // Weight time slightly more (55/45 split)
    const overallScore = Math.round(timeScore * 0.55 + volumeScore * 0.45);
    currentShot.score = overallScore;
    checkForDiagnostic(overallScore);
    
    const scoreEl = document.getElementById('hero-score');
    scoreEl.textContent = `${overallScore}%`;
    
    // Update score styling
    scoreEl.className = 'score-display';
    if (overallScore >= 95) scoreEl.classList.add('perfect');
    else if (overallScore >= 90) scoreEl.classList.add('excellent');
    else if (overallScore >= 80) scoreEl.classList.add('good');
    else if (overallScore >= 70) scoreEl.classList.add('okay');
    else scoreEl.classList.add('poor');
    
    // Generate feedback message
    generateFeedbackMessage(overallScore, timeDiff, volumeDiff - volumeTarget, timeTarget, volumeTarget);
}

// Generate Feedback Message with Austin Powers Easter Egg
function generateFeedbackMessage(score, timeDiff, volumeDiff, timeTarget, volumeTarget) {
    const feedbackEl = document.getElementById('feedback-message');
    let message = '';
    
    // Austin Powers Easter Egg for extreme taste values
    if (currentTasteValue <= 1.5 || currentTasteValue >= 9.5) {
        message = "Yeah baby! It's a bit nutty!";
        feedbackEl.textContent = message;
        return;
    }
    
    if (score >= 95) {
        const perfects = [
            "Nailed it! Your grinder thanks you.",
            "Barista level: Expert. Cafe level: Jealous.",
            "This is the shot other shots dream about.",
            "Perfect extraction achieved. Take a bow!",
            "Your espresso game is strong today!"
        ];
        message = perfects[Math.floor(Math.random() * perfects.length)];
    } else if (score >= 90) {
        const excellents = [
            "So close to perfection, you can taste it!",
            "Excellent work! Minor tweaks ahead.",
            "Your consistency is impressive!",
            "Almost there - one tiny adjustment away.",
            "This is what we call dialed in!"
        ];
        message = excellents[Math.floor(Math.random() * excellents.length)];
    } else if (score >= 85) {
        const goods = [
            "Good shot! Let's make it great.",
            "Solid foundation - time to fine-tune.",
            "You're in the sweet spot zone.",
            "Nice work - small changes, big difference.",
            "Getting warmer... much warmer!"
        ];
        message = goods[Math.floor(Math.random() * goods.length)];
    } else if (score >= 70) {
        const okays = [
            `${Math.abs(timeDiff) > 5 ? 'Time needs work' : 'Volume needs attention'} - you've got this!`,
            "Room for improvement = room for excellence.",
            "Every shot teaches us something new.",
            "Progress, not perfection. Keep going!",
            "The journey to great coffee continues..."
        ];
        message = okays[Math.floor(Math.random() * okays.length)];
    } else {
        const struggles = [
            "This shot has... personality. Let's refine it!",
            "Your coffee journey just got interesting!",
            "Consider this a learning opportunity.",
            `${Math.abs(timeDiff) > Math.abs(volumeDiff * 2) ? 'Way off on timing' : 'Volume missed the mark'} - but fixable!`,
            "Great espresso takes practice. You're practicing!"
        ];
        message = struggles[Math.floor(Math.random() * struggles.length)];
    }
    
    if (Math.abs(timeDiff) > 10) {
        message += timeDiff > 0 ? " (Running slow)" : " (Running fast)";
    }
    
    feedbackEl.textContent = message;
}

// Recommendation Algorithm with Humidity Tracking
function generateRecommendations() {
    const volumeTarget = parseInt(document.getElementById('volume-target').value) || 36;
    const timeTarget = parseInt(document.getElementById('time-target').value) || 28;
    const actualVolume = currentShot.actualVolume || 0;
    const actualTime = currentShot.actualTime || 0;
    
    const profile = getCurrentMachineProfile();
    const timeDiff = actualTime - timeTarget;
    const volumeDiff = actualVolume - volumeTarget;
    
    const timeError = Math.abs(timeDiff / timeTarget) * 100;
    const volumeError = Math.abs(volumeDiff / volumeTarget) * 100;
    
    let grindChange = 0;
    let confidenceScore = 0.5;
    let changeReason = [];
    
    // Try ML-based recommendation first
    if (mlModel && mlModel.length > 0) {
        const currentConditions = {
            grind: brewmieData.currentGrind,
            dose: parseInt(document.getElementById('dose-input').value) || 18,
            targetVolume: volumeTarget,
            targetTime: timeTarget,
            humidity: currentShot.weather?.humidity || 50,
            beanAge: currentShot.beanAge || 14,
            roastLevel: brewmieData.beans.roastLevel === 'light' ? 1 : 
                        brewmieData.beans.roastLevel === 'dark' ? 3 : 2,
            waterTemp: parseInt(document.getElementById('shot-temp')?.value) || brewmieData.machine.shotTemp || 93,
            tampPressure: brewmieData.tampType === 'automatic' ? brewmieData.autoPressure :
                         brewmieData.tampType === 'manual' ? [10, 15, 20][brewmieData.tampLevel] :
                         null
        };
        
        const similar = findSimilarShots(currentConditions);
        if (similar && similar.length >= 3) {
            // Find successful similar shots
            const successful = similar
                .filter(s => s.shot.score >= 85 || (s.shot.taste >= 4.5 && s.shot.taste <= 5.5))
                .slice(0, 5);
            
            if (successful.length >= 2) {
                // Learn from what actually worked in similar conditions
                let mlGrindSuggestion = 0;
                let mlConfidence = 0;
                
                let communityCount = 0;
                let csvCount = 0;
                
                successful.forEach(s => {
                    const shot = s.shot;
                    
                    // Track source of data
                    if (s.source === 'community') communityCount++;
                    else csvCount++;
                    
                    // How far off was this shot's time?
                    const timeError = (shot.actualTime - shot.timeTarget) / shot.timeTarget;
                    
                    // What grind was used for this successful shot?
                    const grindDiff = shot.grind - currentConditions.grind;
                    
                    // If shot was successful with different grind, suggest moving toward it
                    if (Math.abs(grindDiff) > 0.5) {
                        // Weight community data higher (real users)
                        const weight = s.source === 'community' ? 0.4 : 0.3;
                        mlGrindSuggestion += grindDiff * weight;
                        mlConfidence += s.source === 'community' ? 0.3 : 0.2;
                    }
                    
                    // Also learn from time patterns
                    if (Math.abs(timeDiff - timeError) < 5) {
                        // Similar time error - use similar correction
                        mlGrindSuggestion += timeError > 0 ? 0.5 : -0.5;
                        mlConfidence += s.source === 'community' ? 0.15 : 0.1;
                    }
                });
                
                if (mlConfidence > 0.3) {
                    grindChange = mlGrindSuggestion;
                    confidenceScore = Math.min(0.95, mlConfidence);
                    changeReason.push(`ML: ${communityCount} community + ${csvCount} baseline patterns`);
                    
                    // If user's own data, boost confidence
                    if (successful.some(s => s.isUserData)) {
                        confidenceScore = Math.min(0.98, confidenceScore + 0.1);
                        changeReason.push('Including your successful patterns');
                    }
                }
            }
        }
    }
    
    // PRIMARY ADJUSTMENT: Grind based on extraction time
    if (timeError > 5) {
        Object.values(BASELINE_EXTRACTION_DATA.timingCorrections).forEach(correction => {
            if (Math.abs(timeDiff) >= Math.abs(correction.threshold)) {
                grindChange = correction.grindChange * Math.sign(timeDiff);
                confidenceScore = Math.max(confidenceScore, correction.confidence);
            }
        });
        
        grindChange *= profile.grindCalibration;
        changeReason.push(`Time off by ${Math.round(timeDiff)}s`);
    }
    
    // SECONDARY CONSIDERATION: Volume affects grind too
    // If volume is low despite correct time, grind might be too fine (channeling)
    // If volume is high despite correct time, grind might be too coarse
    if (volumeError > 10 && timeError < 5) {
        if (volumeDiff < -3) {
            // Under-extracted volume with correct time = possible channeling
            grindChange -= 0.5;
            changeReason.push(`Low volume (possible channeling)`);
        } else if (volumeDiff > 3) {
            // Over-extracted volume with correct time = too coarse
            grindChange += 0.5;
            changeReason.push(`High volume (grind too coarse)`);
        }
    }
    
    // Combined time+volume analysis for better recommendations
    if (timeError > 5 && volumeError > 5) {
        if (timeDiff > 0 && volumeDiff < 0) {
            // Slow + low volume = definitely too fine
            grindChange = Math.max(grindChange, 1);
            confidenceScore = 0.95;
        } else if (timeDiff < 0 && volumeDiff > 0) {
            // Fast + high volume = definitely too coarse
            grindChange = Math.min(grindChange, -1);
            confidenceScore = 0.95;
        }
    }
    
    // Environmental factors
    if (currentShot.weather && currentShot.weather.humidity) {
        const humidity = currentShot.weather.humidity;
        if (humidity > 70) {
            grindChange += 0.5;
            changeReason.push(`High humidity (${humidity}%)`);
        } else if (humidity < 30) {
            grindChange -= 0.5;
            changeReason.push(`Low humidity (${humidity}%)`);
        }
    }
    
    // Personal preferences from taste data - use the ACTUAL taste of this shot if available
    const lastShot = brewmieData.shots[0]; // Most recent shot
    if (lastShot && lastShot.taste && lastShot.taste !== 'none') {
        const tasteValue = parseFloat(lastShot.taste);
        if (tasteValue < 4) { // Sour
            grindChange -= 0.5; // Go finer
            changeReason.push(`Last shot sour (${tasteValue})`);
        } else if (tasteValue > 6) { // Bitter
            grindChange += 0.5; // Go coarser
            changeReason.push(`Last shot bitter (${tasteValue})`);
        }
    } else if (brewmieData.shots.length >= 10 && brewmieData.personalWeights.tastelearning) {
        // Fall back to pattern analysis
        const tasteData = brewmieData.personalWeights.tastelearning;
        const avgTaste = Object.entries(tasteData)
            .reduce((sum, [taste, count]) => {
                return sum + (parseFloat(taste) * count);
            }, 0) / Object.values(tasteData).reduce((a, b) => a + b, 0);
        
        if (avgTaste < 4.5) {
            grindChange -= 0.25;
            changeReason.push('Trend: shots tend sour');
        } else if (avgTaste > 5.5) {
            grindChange += 0.25;
            changeReason.push('Trend: shots tend bitter');
        }
    }
    
// Check personal successful patterns
    if (brewmieData.personalWeights.patterns && Object.keys(brewmieData.personalWeights.patterns).length >= 3) {
        const patterns = Object.values(brewmieData.personalWeights.patterns);
        const similarPatterns = patterns.filter(p => 
            Math.abs(p.dose - currentDose) <= 1 &&
            Math.abs(p.conditions.roastLevel - (brewmieData.beans.roastLevel === 'light' ? 1 : 
                                                 brewmieData.beans.roastLevel === 'dark' ? 3 : 2)) <= 1
        );
        
        if (similarPatterns.length > 0) {
            // Find average successful grind for similar conditions
            const avgSuccessGrind = similarPatterns.reduce((sum, p) => sum + p.grind, 0) / similarPatterns.length;
            const suggestedChange = avgSuccessGrind - currentGrind;
            
            if (Math.abs(suggestedChange) > 0.5) {
                grindChange = grindChange * 0.5 + suggestedChange * 0.5; // Blend ML and personal
                confidenceScore = Math.min(0.98, confidenceScore + 0.2);
                changeReason.push(`Your pattern: grind ~${Math.round(avgSuccessGrind)} works best`);
            }
        }
    }

    // First shot of session adjustment
    if (document.getElementById('session-checkbox').checked) {
        grindChange += 0.5;
        changeReason.push('First shot adjustment');
    }
    
    // Apply calculated changes
    grindChange = Math.round(grindChange * 2) / 2; // Round to nearest 0.5
    const currentGrind = brewmieData.currentGrind;
    const newGrind = Math.max(profile.grindRange[0], Math.min(profile.grindRange[1], currentGrind + grindChange));
// If volume is significantly off but time is close, suggest grind adjustment
    if (volumeError > 10 && timeError < 10) {
        // Under-extracted volume = need coarser grind for more flow
        if (volumeDiff < 0) {
            const volumeAdjustment = Math.min(1, Math.abs(volumeDiff) / 10);
            grindChange += volumeAdjustment;
            changeReason.push(`Low volume by ${Math.abs(volumeDiff)}g`);
        }
        // Over-extracted volume = need finer grind for less flow
        else if (volumeDiff > 0) {
            const volumeAdjustment = Math.min(1, Math.abs(volumeDiff) / 10);
            grindChange -= volumeAdjustment;
            changeReason.push(`High volume by ${Math.abs(volumeDiff)}g`);
        }
    }
        
    // IMPORTANT: Keep user's recipe (dose, volume, time) unchanged
    const currentDose = parseInt(document.getElementById('dose-input').value);
    const newDose = currentDose; // NO CHANGE TO DOSE
    const newVolume = volumeTarget; // Target stays the same
    const newTime = timeTarget; // Target stays the same
    
    // Update displays - ensure proper unit conversion
    document.getElementById('grind-adjust').textContent = newGrind;
    if (brewmieData.units === 'imperial') {
        document.getElementById('dose-adjust').textContent = convertToDisplay(newDose, 'weight');
        document.getElementById('volume-adjust').textContent = convertToDisplay(newVolume, 'weight');
    } else {
        document.getElementById('dose-adjust').textContent = `${newDose}g`;
        document.getElementById('volume-adjust').textContent = `${newVolume}g`;
    }
    document.getElementById('time-adjust').textContent = `${newTime}s`;
    
    // Visual feedback: Make ADJUST header green if ANY change recommended
    const adjustHeader = document.getElementById('adjust-header');
    if (adjustHeader) {
        if (newGrind !== currentGrind || 
            (currentShot.recommendations?.tampLevel !== undefined && currentShot.recommendations.tampLevel !== brewmieData.tampLevel) ||
            (currentShot.recommendations?.springPressure !== undefined && currentShot.recommendations.springPressure !== brewmieData.springPressure)) {
            adjustHeader.style.backgroundColor = 'var(--accent-green)';
            adjustHeader.style.color = 'var(--white)';
        } else {
            adjustHeader.style.backgroundColor = '';
            adjustHeader.style.color = '';
        }
    }
    
    // Update tamp advice based on extraction pattern
    updateTampAdvice(timeDiff, volumeDiff, confidenceScore);
    
    // Save recommendations
    // Create base objective recommendation
    let recommendations = { 
        grind: newGrind, 
        dose: newDose,
        volume: newVolume,
        time: newTime,
        confidence: confidenceScore,
        reason: changeReason.length > 0 ? changeReason.join(', ') : 'Target achieved!'
    };
    
    // Apply personal preferences layer on top
    recommendations = applyPersonalPreferences(recommendations, confidenceScore);
    
    // Save final recommendations
    currentShot.recommendations = recommendations;
    
    // If perfect shot (no changes needed)
    if (changeReason.length === 0 || newGrind === currentGrind) {
        document.getElementById('grind-adjust').textContent = currentGrind;
        if (!changeReason.length) {
            currentShot.recommendations.reason = 'Target achieved!';
            currentShot.recommendations.confidence = 1.0;
        }
    }
}

function updateTampAdvice(timeDiff, volumeDiff, confidenceScore) {
    if (brewmieData.tampType === 'manual') {
        let advice = 1;
        
        if (confidenceScore > 0.8) {
            if (timeDiff > 3 && volumeDiff < -2) {
                advice = 0;
            } else if (timeDiff < -3 && volumeDiff > 2) {
                advice = 2;
            } else if (Math.abs(timeDiff) < 1 && Math.abs(volumeDiff) < 1) {
                advice = 1;
            } else if (timeDiff > 1) {
                advice = 0;
            } else if (timeDiff < -1) {
                advice = 2;
            }
        } else if (confidenceScore > 0.6) {
            if (timeDiff > 2) {
                advice = 0;
            } else if (timeDiff < -2) {
                advice = 2;
            }
        }
        
        document.getElementById('tamp-adjust').textContent = TAMP_SYMBOLS[advice];
        
        if (!currentShot.recommendations) {
            currentShot.recommendations = {};
        }
        currentShot.recommendations.tampLevel = advice;
    } else if (brewmieData.tampType === 'spring') {
        let nextSetting = brewmieData.springPressure;
        if (timeDiff > 3 && confidenceScore > 0.7) {
            nextSetting = Math.max(brewmieData.springMin, brewmieData.springPressure - 2);
        } else if (timeDiff < -3 && confidenceScore > 0.7) {
            nextSetting = Math.min(brewmieData.springMax, brewmieData.springPressure + 2);
        }
        document.getElementById('tamp-adjust').textContent = nextSetting;
        
        if (!currentShot.recommendations) {
            currentShot.recommendations = {};
        }
        currentShot.recommendations.springPressure = nextSetting;
    } else if (brewmieData.tampType === 'automatic') {
        document.getElementById('tamp-adjust').textContent = brewmieData.autoPressure;
    }
}

// Apply Adjustments
function applyAdjustments() {
    if (!currentShot.recommendations) return;
    
    document.getElementById('grind-input').value = currentShot.recommendations.grind;
    document.getElementById('dose-input').value = currentShot.recommendations.dose;
    document.getElementById('volume-target').value = currentShot.recommendations.volume;
    document.getElementById('time-target').value = currentShot.recommendations.time;
    
    brewmieData.currentGrind = currentShot.recommendations.grind;
    
    if (brewmieData.tampType === 'manual' && currentShot.recommendations.tampLevel !== undefined) {
        brewmieData.tampLevel = currentShot.recommendations.tampLevel;
        document.getElementById('tamp-display').textContent = TAMP_SYMBOLS[brewmieData.tampLevel];
    } else if (brewmieData.tampType === 'spring' && currentShot.recommendations.springPressure !== undefined) {
        brewmieData.springPressure = currentShot.recommendations.springPressure;
        document.getElementById('spring-input').value = brewmieData.springPressure;
    }
    
    saveData();
    resetBrew();
    loadInputSettings();
    setBrewingPhase('ready-to-brew');
}

function skipAdjustments() {
    // Just reset the phase without applying changes
    setBrewingPhase('ready-to-brew');
}

// Reset Function
function resetBrew() {
    // Clear ACTUAL column
    document.getElementById('grind-brew').textContent = '--';
    document.getElementById('dose-brew').textContent = '--';
    document.getElementById('volume-brew').textContent = '--';
    document.getElementById('time-brew').textContent = '--';
    document.getElementById('tamp-brew').textContent = '--';
    
    // Reset score and hide it
    document.getElementById('hero-score').textContent = '--';
    document.getElementById('hero-score').className = 'score-display';
    document.getElementById('feedback-message').textContent = '';
    document.getElementById('hero-score-section').classList.remove('show');
    
    // Reset ADJUST header back to normal
    const adjustHeader = document.getElementById('adjust-header');
    if (adjustHeader) {
        adjustHeader.style.backgroundColor = '';
        adjustHeader.style.color = '';
    }
    
    // Reset to pre-brew phase
    setBrewingPhase('pre-brew');
    
    updateSessionLabel();
    const weather = currentShot.weather;
    currentShot = {};
    if (weather) currentShot.weather = weather;
    currentBrewVolume = 0;
    currentBrewTime = 0;
}

// Taste Modal Functions
function openTasteModal() {
    document.getElementById('taste-modal').classList.add('show');
    initializeTasteScale();
}

function closeTasteModal() {
    document.getElementById('taste-modal').classList.remove('show');
}

function initializeTasteScale() {
    const handle = document.getElementById('scale-handle');
    const track = document.getElementById('scale-track');
    const value = document.getElementById('taste-value');
    const decimal = document.getElementById('taste-decimal');
    const details = document.getElementById('taste-details');
    
    handle.style.left = '50%';
    currentTasteValue = 5.0;
    value.textContent = 'Perfect Balance';
    decimal.textContent = '5.0';
    details.textContent = 'Optimal extraction with balanced acidity and sweetness';
    
    let isDragging = false;
    
    function updateTaste(percentage) {
        currentTasteValue = Math.round((1 + percentage * 9) * 10) / 10;
        currentTasteValue = Math.max(1.0, Math.min(10.0, currentTasteValue));
        
        decimal.textContent = currentTasteValue.toFixed(1);
        
        let tasteName, tasteDetail;
        
        if (currentTasteValue <= 2.0) {
            tasteName = 'Very Sour';
            tasteDetail = 'Severely under-extracted with harsh, dominating acidity';
        } else if (currentTasteValue <= 3.5) {
            tasteName = 'Sour';
            tasteDetail = 'Under-extracted with bright acidity and thin body';
        } else if (currentTasteValue <= 4.5) {
            tasteName = 'Slightly Sour';
            tasteDetail = 'Mildly under-extracted with noticeable tartness';
        } else if (currentTasteValue <= 5.5) {
            tasteName = 'Perfect Balance';
            tasteDetail = 'Optimal extraction with balanced acidity and sweetness';
        } else if (currentTasteValue <= 6.5) {
            tasteName = 'Slightly Bitter';
            tasteDetail = 'Mildly over-extracted with noticeable bitterness';
        } else if (currentTasteValue <= 8.0) {
            tasteName = 'Bitter';
            tasteDetail = 'Over-extracted with harsh bitterness and astringency';
        } else {
            tasteName = 'Very Bitter';
            tasteDetail = 'Severely over-extracted with overwhelming bitterness';
        }
        
        value.textContent = tasteName;
        details.textContent = tasteDetail;
        
        if (currentTasteValue <= 3.5) {
            handle.style.borderColor = '#CD5C5C';
        } else if (currentTasteValue <= 4.5) {
            handle.style.borderColor = '#FFA500';
        } else if (currentTasteValue <= 5.5) {
            handle.style.borderColor = '#2D5016';
        } else if (currentTasteValue <= 6.5) {
            handle.style.borderColor = '#FFA500';
        } else {
            handle.style.borderColor = '#CD5C5C';
        }
    }
    
    function handleMove(clientX) {
        const trackRect = track.getBoundingClientRect();
        const percentage = Math.max(0, Math.min(1, (clientX - trackRect.left) / trackRect.width));
        
        handle.style.left = `${percentage * 100}%`;
        updateTaste(percentage);
    }
    
    track.addEventListener('click', (e) => {
        handleMove(e.clientX);
    });
    
    handle.addEventListener('mousedown', (e) => {
        isDragging = true;
        e.preventDefault();
    });
    
    document.addEventListener('mousemove', (e) => {
        if (isDragging) {
            handleMove(e.clientX);
        }
    });
    
    document.addEventListener('mouseup', () => {
        isDragging = false;
    });
    
    track.addEventListener('touchstart', (e) => {
        handleMove(e.touches[0].clientX);
    });
    
    handle.addEventListener('touchstart', (e) => {
        isDragging = true;
        e.preventDefault();
    });
    
    document.addEventListener('touchmove', (e) => {
        if (isDragging) {
            handleMove(e.touches[0].clientX);
            e.preventDefault();
        }
    });
    
    document.addEventListener('touchend', () => {
        isDragging = false;
    });
}

function skipTaste() {
    // Check if we're rating a past shot
    if (window.ratingPastShotId) {
        window.ratingPastShotId = null;
        closeTasteModal();
        return;
    }
    
    // Shot already logged, just close modal
    closeTasteModal();
}

function saveTaste() {
    // Check if we're rating a past shot
    if (window.ratingPastShotId) {
        const shotIndex = brewmieData.shots.findIndex(s => s.id === window.ratingPastShotId);
        if (shotIndex !== -1) {
            brewmieData.shots[shotIndex].taste = currentTasteValue;
            
            // Update taste learning
            const tasteKey = currentTasteValue.toString();
            brewmieData.personalWeights.tastelearning[tasteKey] = 
                (brewmieData.personalWeights.tastelearning[tasteKey] || 0) + 1;
            
            saveData();
            updateInsights();
            showAlert('Taste rating saved!', 'success');
        }
        window.ratingPastShotId = null;
        closeTasteModal();
        return;
    }
    
    // Update the current brew shot that was already logged
    if (window.currentBrewShotId) {
        const shotIndex = brewmieData.shots.findIndex(s => s.id === window.currentBrewShotId);
        if (shotIndex !== -1) {
            brewmieData.shots[shotIndex].taste = currentTasteValue;
            
            // Update taste learning
            const tasteKey = currentTasteValue.toString();
            brewmieData.personalWeights.tastelearning[tasteKey] = 
                (brewmieData.personalWeights.tastelearning[tasteKey] || 0) + 1;
            
            // Check for Austin Powers easter egg
            if (currentTasteValue <= 1.5 || currentTasteValue >= 9.5) {
                generateFeedbackMessage(brewmieData.shots[shotIndex].score, 0, 0, 0, 0);
            }
            
            saveData();
            updateInsights();
        }
    }
    
    closeTasteModal();
}

// Diagnostic Assistant
function checkForDiagnostic(score) {
    if (score < 70 && !brewmieData.diagnosticDismissed) {
        setTimeout(() => {
            openDiagnosticModal();
        }, 2000);
    }
}

function openDiagnosticModal() {
    const modal = document.createElement('div');
    modal.className = 'app-modal-wrapper';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="app-modal warning">
            <div style="font-weight: 600; margin-bottom: 12px;">Let's diagnose what happened</div>
            <div style="font-size: 12px; margin-bottom: 12px;">Your shot scored ${currentShot.score}%. Answer a couple questions to get better recommendations:</div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 6px;">How did it taste?</label>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px;">
                    <button class="option-btn" onclick="setDiagnosticTaste('sour', this)">Sour/Sharp</button>
                    <button class="option-btn" onclick="setDiagnosticTaste('bitter', this)">Bitter/Harsh</button>
                    <button class="option-btn" onclick="setDiagnosticTaste('none', this)">Didn't taste</button>
                </div>
            </div>
            
            <div style="margin-bottom: 12px;">
                <label style="font-size: 11px; font-weight: 600; display: block; margin-bottom: 6px;">How did the extraction look?</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px;">
                    <button class="option-btn" onclick="setDiagnosticFlow('fast', this)">Too fast</button>
                    <button class="option-btn" onclick="setDiagnosticFlow('slow', this)">Too slow</button>
                    <button class="option-btn" onclick="setDiagnosticFlow('channeling', this)">Spurting/uneven</button>
                    <button class="option-btn" onclick="setDiagnosticFlow('normal', this)">Looked normal</button>
                </div>
            </div>
            
            <div id="diagnostic-result" style="display: none; background: var(--cream); border-radius: 6px; padding: 10px; margin-bottom: 12px;">
                <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 4px;">Diagnosis:</div>
                <div id="diagnostic-text" style="font-size: 12px; font-weight: 600;"></div>
            </div>
            
            <div style="display: flex; gap: 8px;">
                <button onclick="skipDiagnostic(this)" style="flex: 1; background: var(--grey-light); color: white; border: none; padding: 10px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                    Skip
                </button>
                <button id="apply-diagnostic-btn" onclick="applyDiagnosticFix(this)" style="flex: 2; background: var(--accent-green); color: white; border: none; padding: 10px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; display: none;">
                    Apply Fix
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    window.diagnosticData = { taste: null, flow: null, fix: null };
}

function setDiagnosticTaste(taste, btn) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    window.diagnosticData.taste = taste;
    updateDiagnosticResult();
}

function setDiagnosticFlow(flow, btn) {
    btn.parentElement.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    window.diagnosticData.flow = flow;
    updateDiagnosticResult();
}

function updateDiagnosticResult() {
    if (!window.diagnosticData.taste || !window.diagnosticData.flow) return;
    
    const result = document.getElementById('diagnostic-result');
    const text = document.getElementById('diagnostic-text');
    const applyBtn = document.getElementById('apply-diagnostic-btn');
    
    let diagnosis = '';
    let fix = {};
    let fixDescription = '';
    
    // Diagnostic logic with clear fix descriptions
    if (window.diagnosticData.taste === 'sour' && window.diagnosticData.flow === 'fast') {
        diagnosis = 'Under-extracted: Grind too coarse.';
        fix = { grind: -2 };
        fixDescription = 'Grind: ' + brewmieData.currentGrind + ' â†’ ' + (brewmieData.currentGrind - 2);
    } else if (window.diagnosticData.taste === 'bitter' && window.diagnosticData.flow === 'slow') {
        diagnosis = 'Over-extracted: Grind too fine.';
        fix = { grind: 2 };
        fixDescription = 'Grind: ' + brewmieData.currentGrind + ' â†’ ' + (brewmieData.currentGrind + 2);
    } else if (window.diagnosticData.flow === 'channeling') {
        diagnosis = 'Channeling detected: Uneven extraction.';
        fix = { grind: -1, tamp: 'harder' };
        fixDescription = 'Grind: ' + brewmieData.currentGrind + ' â†’ ' + (brewmieData.currentGrind - 1) + ' + firmer tamp';
    } else if (window.diagnosticData.taste === 'sour') {
        diagnosis = 'Under-extracted: Need more extraction.';
        fix = { grind: -1 };
        fixDescription = 'Grind: ' + brewmieData.currentGrind + ' â†’ ' + (brewmieData.currentGrind - 1);
    } else if (window.diagnosticData.taste === 'bitter') {
        diagnosis = 'Over-extracted: Need less extraction.';
        fix = { grind: 1 };
        fixDescription = 'Grind: ' + brewmieData.currentGrind + ' â†’ ' + (brewmieData.currentGrind + 1);
    } else if (window.diagnosticData.flow === 'fast') {
        diagnosis = 'Running too fast: Need more resistance.';
        fix = { grind: -1.5 };
        fixDescription = 'Grind: ' + brewmieData.currentGrind + ' â†’ ' + Math.round(brewmieData.currentGrind - 1.5);
    } else if (window.diagnosticData.flow === 'slow') {
        diagnosis = 'Running too slow: Need less resistance.';
        fix = { grind: 1.5 };
        fixDescription = 'Grind: ' + brewmieData.currentGrind + ' â†’ ' + Math.round(brewmieData.currentGrind + 1.5);
    } else {
        diagnosis = 'Parameters seem okay. Check beans freshness, water temp, or machine maintenance.';
        fix = null;
    }
    
    text.innerHTML = diagnosis;
    if (fixDescription) {
        text.innerHTML += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid var(--border); color: var(--accent-green); font-weight: 700;">${fixDescription}</div>`;
    }
    
    result.style.display = 'block';
    window.diagnosticData.fix = fix;
    
    if (fix) {
        applyBtn.style.display = 'block';
        applyBtn.textContent = `Apply: ${fixDescription}`;
    }
}

function skipDiagnostic(btn) {
    brewmieData.diagnosticDismissed = Date.now();
    btn.closest('.app-modal-wrapper').remove();
}

function applyDiagnosticFix(btn) {
    if (!window.diagnosticData.fix) return;
    
    const fix = window.diagnosticData.fix;
    if (fix.grind) {
        const currentGrind = parseInt(document.getElementById('grind-input').value);
        const newGrind = Math.round(currentGrind + fix.grind);
        document.getElementById('grind-input').value = newGrind;
        brewmieData.currentGrind = newGrind;
    }
    
    // Store diagnostic data with shot
    if (currentShot && currentShot.id) {
        const shotIndex = brewmieData.shots.findIndex(s => s.id === currentShot.id);
        if (shotIndex !== -1) {
            brewmieData.shots[shotIndex].diagnosticData = window.diagnosticData;
        }
    }
    
    saveData();
    loadInputSettings();
    btn.closest('.app-modal-wrapper').remove();
    
    showAlert('Adjustments applied! Try another shot with these settings.', 'success');
}

// Shot Logging
function logShot() {
    // Preserve the shot ID if it exists (for taste updates)
    const shotId = currentShot.id || Date.now();
    
    const roastDate = document.getElementById('roast-date')?.value || brewmieData.beans.roastDate;
    const beanAge = roastDate ? Math.floor((new Date() - new Date(roastDate)) / (1000 * 60 * 60 * 24)) : 14;
    
    const now = new Date();
    const day = now.toLocaleDateString('en-AU', { weekday: 'short' });
    const time = now.toLocaleTimeString('en-AU', { 
        hour: 'numeric', 
        minute: '2-digit', 
        hour12: true 
    }).toLowerCase();
    const date = now.toLocaleDateString('en-AU', { 
        day: '2-digit', 
        month: 'short', 
        year: '2-digit' 
    });
    
    // Get water temp and humidity as top-level fields
    const waterTempC = parseInt(document.getElementById('shot-temp')?.value) || brewmieData.machine.shotTemp || 93;
    const humidity = currentShot.weather?.humidity || null;
    
    // Calculate numeric tamp pressure
    let tampPressureKg = null;
    if (brewmieData.tampType === 'automatic') {
        tampPressureKg = brewmieData.autoPressure;
    } else if (brewmieData.tampType === 'manual') {
        const tampKgMap = [10, 15, 20];
        tampPressureKg = tampKgMap[brewmieData.tampLevel || 1];
    } else if (brewmieData.tampType === 'spring') {
        // Spring tamper - would need calibration to convert to kg
        tampPressureKg = null; // Keep null until calibration added
    }
    
    const shot = {
        id: shotId,
        source: 'user',
        dose: currentShot.actualDose || parseInt(document.getElementById('dose-input').value) || 18,
        volumeTarget: parseInt(document.getElementById('volume-target').value) || 36,
        actualVolume: currentShot.actualVolume || 0,
        timeTarget: parseInt(document.getElementById('time-target').value) || 28,
        actualTime: currentShot.actualTime || 0,
        grind: currentShot.actualGrind || brewmieData.currentGrind,
        taste: currentShot.taste || 'none',
        score: currentShot.score || 0,
        weather: currentShot.weather,
        isFirstBrew: document.getElementById('session-checkbox').checked,
        fullTimestamp: `${day} ${time}, ${date}`,
        beanAge: beanAge,
        roastLevel: brewmieData.beans.roastLevel === 'light' ? 1 : 
                    brewmieData.beans.roastLevel === 'medium' ? 2 : 3,
        machine: `${brewmieData.machine.brand}_${brewmieData.machine.model}`,
        tampType: brewmieData.tampType,
        tampLevel: brewmieData.tampLevel,
        notes: '',
        algorithmVersion: brewmieData.algorithmVersion,
        recommendationConfidence: currentShot.recommendations?.confidence || 0.5,
        recommendations: currentShot.recommendations || null,
        validationFlags: [...brewmieData.validationFlags],
        waterTempC: waterTempC,
        humidity: humidity,
        tampPressureKg: tampPressureKg
    };
    
    // Mark as not synced yet
    shot.synced = false;
    
    brewmieData.shots.unshift(shot);
    if (brewmieData.shots.length > 100) {
        brewmieData.shots = brewmieData.shots.slice(0, 100);
    }
    
    // Update maintenance shot counts
    brewmieData.maintenance.shotCounts.sinceFilter++;
    brewmieData.maintenance.shotCounts.sinceDescale++;
    brewmieData.maintenance.shotCounts.sinceFlush++;
    
    if (currentShot.taste !== 'none') {
        const tasteKey = currentShot.taste.toString();
        brewmieData.personalWeights.tastelearning[tasteKey] = 
            (brewmieData.personalWeights.tastelearning[tasteKey] || 0) + 1;
    }
    
    if (currentShot.score >= 90) {
        brewmieData.personalWeights.confidenceScore = Math.min(100, brewmieData.personalWeights.confidenceScore + 2);
    } else if (currentShot.score < 70) {
        brewmieData.personalWeights.confidenceScore = Math.max(10, brewmieData.personalWeights.confidenceScore - 1);
    }
    
    brewmieData.lastUsed = Date.now();
    brewmieData.validationFlags = [];
    
    // Update personal learning model
    updatePersonalModel(shot);
    
    // Store the ID in currentShot for potential taste update
    currentShot.id = shotId;
    
    saveData();  // Only ONE saveData call at the end - this triggers syncToCloud
    checkMaintenanceAlerts();
}

// Adaptive learning - update personal model based on outcomes
function updatePersonalModel(shot) {
    if (!shot.taste || shot.taste === 'none') return;
    
    // Build pattern recognition
    const tasteRating = parseFloat(shot.taste);
    const key = `${shot.grind}_${Math.round(shot.actualTime)}_${shot.dose}`;
    
    if (!brewmieData.personalWeights.patterns) {
        brewmieData.personalWeights.patterns = {};
    }
    
    // Store successful patterns
    if (tasteRating >= 4.5 && tasteRating <= 5.5 && shot.score >= 85) {
        brewmieData.personalWeights.patterns[key] = {
            grind: shot.grind,
            time: shot.actualTime,
            dose: shot.dose,
            volume: shot.actualVolume,
            taste: tasteRating,
            score: shot.score,
            conditions: {
                humidity: shot.humidity,
                beanAge: shot.beanAge,
                roastLevel: shot.roastLevel
            }
        };
        
        // Boost confidence when patterns repeat
        if (Object.keys(brewmieData.personalWeights.patterns).length >= 5) {
            brewmieData.personalWeights.confidenceScore = Math.min(100, 
                brewmieData.personalWeights.confidenceScore + 5);
        }
    }
    
    // Adjust humidity weight based on correlation
    if (shot.weather?.humidity) {
        const humidityKey = Math.round(shot.weather.humidity / 10) * 10;
        if (!brewmieData.personalWeights.humidityPatterns) {
            brewmieData.personalWeights.humidityPatterns = {};
        }
        if (!brewmieData.personalWeights.humidityPatterns[humidityKey]) {
            brewmieData.personalWeights.humidityPatterns[humidityKey] = [];
        }
        brewmieData.personalWeights.humidityPatterns[humidityKey].push({
            grind: shot.grind,
            success: shot.score >= 85
        });
    }
    
    saveData();
}

// Shot History Interactivity
function openShotDetail(shotId) {
    const shot = brewmieData.shots.find(s => s.id === shotId);
    if (!shot) return;
    
    currentShotDetailId = shotId;
    
    // Calculate shot number (reverse order)
    const shotNumber = brewmieData.shots.length - brewmieData.shots.findIndex(s => s.id === shotId);
    
    document.getElementById('shot-detail-number').textContent = `Shot #${shotNumber}`;
    
    // Parse and display date/time clearly
    const shotDate = new Date(shot.id);
    const dateStr = shotDate.toLocaleDateString('en-AU', { 
        weekday: 'long', 
        day: 'numeric', 
        month: 'short', 
        year: 'numeric' 
    });
    const timeStr = shotDate.toLocaleTimeString('en-AU', { 
        hour: 'numeric', 
        minute: '2-digit', 
        hour12: true 
    }).toLowerCase();
    
    document.getElementById('shot-detail-date').textContent = dateStr;
    document.getElementById('shot-detail-time').textContent = timeStr;
    
    // Score
    const scoreEl = document.getElementById('detail-score');
    scoreEl.textContent = shot.score + '%';
    scoreEl.style.color = shot.score >= 95 ? 'var(--gold)' : 
                          shot.score >= 90 ? 'var(--accent-green)' : 
                          shot.score >= 85 ? 'var(--text-primary)' : 'var(--poor)';
    
    // Metrics with recommendations inline
    document.getElementById('detail-grind-input').textContent = shot.grind;
    document.getElementById('detail-grind-output').textContent = shot.grind;
    document.getElementById('detail-grind-rec').textContent = 
        shot.recommendations?.grind !== undefined ? shot.recommendations.grind : shot.grind;
    
    if (brewmieData.units === 'imperial') {
        document.getElementById('detail-dose-input').textContent = convertToDisplay(shot.dose, 'weight');
        document.getElementById('detail-dose-output').textContent = convertToDisplay(shot.dose, 'weight');
        document.getElementById('detail-dose-rec').textContent = 
            shot.recommendations?.dose ? convertToDisplay(shot.recommendations.dose, 'weight') : convertToDisplay(shot.dose, 'weight');
        
        document.getElementById('detail-volume-input').textContent = convertToDisplay(shot.volumeTarget, 'weight');
        document.getElementById('detail-volume-output').textContent = convertToDisplay(shot.actualVolume, 'weight');
        document.getElementById('detail-volume-rec').textContent = 
            shot.recommendations?.volume ? convertToDisplay(shot.recommendations.volume, 'weight') : convertToDisplay(shot.volumeTarget, 'weight');
    } else {
        document.getElementById('detail-dose-input').textContent = shot.dose + 'g';
        document.getElementById('detail-dose-output').textContent = shot.dose + 'g';
        document.getElementById('detail-dose-rec').textContent = 
            shot.recommendations?.dose ? shot.recommendations.dose + 'g' : shot.dose + 'g';
        
        document.getElementById('detail-volume-input').textContent = shot.volumeTarget + 'g';
        document.getElementById('detail-volume-output').textContent = shot.actualVolume + 'g';
        document.getElementById('detail-volume-rec').textContent = 
            shot.recommendations?.volume ? shot.recommendations.volume + 'g' : shot.volumeTarget + 'g';
    }
    
    document.getElementById('detail-time-input').textContent = shot.timeTarget + 's';
    document.getElementById('detail-time-output').textContent = shot.actualTime + 's';
    document.getElementById('detail-time-rec').textContent = 
        shot.recommendations?.time ? shot.recommendations.time + 's' : shot.timeTarget + 's';
    
    // Tamp
    if (shot.tampType === 'manual') {
        const tampSymbol = TAMP_SYMBOLS[shot.tampLevel || 1];
        const recTampSymbol = shot.recommendations?.tampLevel !== undefined ? 
            TAMP_SYMBOLS[shot.recommendations.tampLevel] : tampSymbol;
        document.getElementById('detail-tamp').textContent = 
            `${tampSymbol} â†’ ${tampSymbol} â†’ ${recTampSymbol}`;
    } else if (shot.tampType === 'spring') {
        const pressure = brewmieData.springPressure;
        const recPressure = shot.recommendations?.springPressure || pressure;
        document.getElementById('detail-tamp').textContent = 
            `${pressure} â†’ ${pressure} â†’ ${recPressure}`;
    } else {
        const pressure = shot.tampType === 'spring' ? brewmieData.springPressure : brewmieData.autoPressure;
        document.getElementById('detail-tamp').textContent = 
            `${pressure} â†’ ${pressure} â†’ ${pressure}`;
    }
    
    // Conditions
    if (shot.weather) {
        const tempDisplay = convertToDisplay(shot.weather.temp, 'temp');
        document.getElementById('detail-weather').textContent = 
            `${tempDisplay}, ${shot.weather.humidity}% humidity`;
    } else {
        document.getElementById('detail-weather').textContent = 'Not recorded';
    }
    
    document.getElementById('detail-bean-age').textContent = shot.beanAge + ' days';
    
    // Taste with description
    if (shot.taste && shot.taste !== 'none') {
        document.getElementById('detail-taste-section').style.display = 'block';
        document.getElementById('detail-rate-now').style.display = 'none';
        
        const tasteValue = parseFloat(shot.taste);
        let tasteText = shot.taste;  // Default to the raw value
        
        if (!isNaN(tasteValue)) {
            if (tasteValue <= 2.0) tasteText = `${tasteValue} - Very Sour`;
            else if (tasteValue <= 3.5) tasteText = `${tasteValue} - Sour`;
            else if (tasteValue <= 4.5) tasteText = `${tasteValue} - Slightly Sour`;
            else if (tasteValue <= 5.5) tasteText = `${tasteValue} - Perfect Balance`;
            else if (tasteValue <= 6.5) tasteText = `${tasteValue} - Slightly Bitter`;
            else if (tasteValue <= 8.0) tasteText = `${tasteValue} - Bitter`;
            else tasteText = `${tasteValue} - Very Bitter`;
        }
        
        document.getElementById('detail-taste-section').innerHTML = `
            <div class="shot-detail-row">
                <span class="shot-detail-label">Rating:</span>
                <span class="shot-detail-value" id="detail-taste">${tasteText}</span>
            </div>
            <button class="taste-trigger-btn" style="margin-top: 8px; font-size: 11px; padding: 6px 12px;" onclick="ratePastShot()">
                Edit Rating
            </button>
        `;
    } else {
        document.getElementById('detail-taste-section').style.display = 'none';
        document.getElementById('detail-rate-now').style.display = 'block';
    }
    
    // Notes
    document.getElementById('detail-notes').value = shot.notes || '';
    
    document.getElementById('shot-detail-modal').classList.add('show');
}

function closeShotDetail() {
    document.getElementById('shot-detail-modal').classList.remove('show');
    currentShotDetailId = null;
}

function ratePastShot() {
    if (!currentShotDetailId) return;
    
    window.ratingPastShotId = currentShotDetailId;
    closeShotDetail();
    openTasteModal();
}

function editShot() {
    if (!currentShotDetailId) return;
    
    const shotIndex = brewmieData.shots.findIndex(s => s.id === currentShotDetailId);
    if (shotIndex === -1) return;
    
    // Save notes first
    const notes = document.getElementById('detail-notes').value;
    brewmieData.shots[shotIndex].notes = notes;
    
    // Create edit modal for volume and time
    const modal = document.createElement('div');
    modal.className = 'app-modal-wrapper';
    modal.innerHTML = `
        <div class="modal-backdrop"></div>
        <div class="app-modal info">
            <div style="font-weight: 600; margin-bottom: 12px;">Edit Shot Results</div>
            <div class="input-row">
                <label class="input-label" style="text-align: left; min-width: 80px;">Volume (${brewmieData.units === 'imperial' ? 'oz' : 'g'}):</label>
                <input type="number" class="number-input" id="edit-volume" value="${brewmieData.shots[shotIndex].actualVolume}" step="0.1">
            </div>
            <div class="input-row">
                <label class="input-label" style="text-align: left; min-width: 80px;">Time (s):</label>
                <input type="number" class="number-input" id="edit-time" value="${brewmieData.shots[shotIndex].actualTime}" step="0.1">
            </div>
            <div class="modal-buttons" style="margin-top: 16px;">
                <button class="modal-cancel-btn">Cancel</button>
                <button class="modal-confirm-btn">Save Changes</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    
    modal.querySelector('.modal-cancel-btn').onclick = () => modal.remove();
    modal.querySelector('.modal-confirm-btn').onclick = () => {
        brewmieData.shots[shotIndex].actualVolume = parseFloat(document.getElementById('edit-volume').value);
        brewmieData.shots[shotIndex].actualTime = parseFloat(document.getElementById('edit-time').value);
        saveData();
        updateInsights();
        modal.remove();
        closeShotDetail();
        showAlert('Shot updated successfully!', 'success');
    };
}

function deleteShot() {
    if (!currentShotDetailId) return;
    
    showConfirm('Delete this shot permanently?', () => {
        const shotIndex = brewmieData.shots.findIndex(s => s.id === currentShotDetailId);
        if (shotIndex !== -1) {
            brewmieData.shots.splice(shotIndex, 1);
            saveData();
            updateInsights();
            showAlert('Shot deleted', 'info');
        }
        closeShotDetail();
    });
}

// Insights Functions
function updateInsights() {
    const shots = brewmieData.shots;
    
    if (shots.length === 0) {
        document.getElementById('first-shot-avg').textContent = '--';
        document.getElementById('follow-up-avg').textContent = '--';
        document.getElementById('optimal-grind').textContent = '--';
        document.getElementById('total-shots').textContent = '0';
        return;
    }
    
    const firstShots = shots.filter(s => s.isFirstBrew);
    const followUps = shots.filter(s => !s.isFirstBrew);
    
    const firstAvg = firstShots.length > 0 ? 
        Math.round(firstShots.reduce((sum, s) => sum + s.score, 0) / firstShots.length) : 0;
    const followAvg = followUps.length > 0 ? 
        Math.round(followUps.reduce((sum, s) => sum + s.score, 0) / followUps.length) : 0;
    
    const currentDose = parseInt(document.getElementById('dose-input').value) || 18;
    const relevantShots = shots.filter(shot => 
        Math.abs(shot.dose - currentDose) <= 2 && 
        shot.score >= 85 &&
        shot.machine === `${brewmieData.machine.brand}_${brewmieData.machine.model}`
    );
    
    let optimalGrind = '--';
    if (relevantShots.length >= 3) {
        const grindScores = {};
        relevantShots.forEach(shot => {
            if (!grindScores[shot.grind]) grindScores[shot.grind] = [];
            grindScores[shot.grind].push(shot.score);
        });
        
        let bestGrind = '';
        let bestScore = 0;
        for (let grind in grindScores) {
            const avgScore = grindScores[grind].reduce((a, b) => a + b) / grindScores[grind].length;
            if (avgScore > bestScore) {
                bestScore = avgScore;
                bestGrind = grind;
            }
        }
        optimalGrind = bestGrind;
    }
    
    document.getElementById('first-shot-avg').textContent = `${firstAvg}%`;
    document.getElementById('follow-up-avg').textContent = `${followAvg}%`;
    document.getElementById('optimal-grind').textContent = optimalGrind;
    document.getElementById('total-shots').textContent = shots.length;
    
    updateShotHistory();
    updatePersonalBenchmarks();
}

function updateShotHistory() {
    const container = document.getElementById('shot-history');
    
    if (brewmieData.shots.length === 0) {
        container.innerHTML = '<div class="empty-state">No shots logged yet</div>';
        return;
    }
    
    container.innerHTML = '';
    
    brewmieData.shots.forEach(shot => {
        const entry = document.createElement('div');
        entry.className = 'shot-item';
        entry.onclick = () => openShotDetail(shot.id);
        
        const scoreColor = shot.score >= 95 ? '#FFD700' : 
                          shot.score >= 90 ? '#2D5016' : 
                          shot.score >= 85 ? '#6A6A6A' : '#8B0000';
        
        const hasRec = shot.recommendations && shot.recommendations.grind !== shot.grind;
        const confidenceIcon = hasRec ? 'â–¶' : 
                              shot.recommendationConfidence >= 0.9 ? 'â—‰' :
                              shot.recommendationConfidence >= 0.7 ? 'â—Ž' :
                              shot.recommendationConfidence >= 0.5 ? 'â—‹' : 'â—¦';
        
        const volumeDisplay = brewmieData.units === 'imperial' ? 
            `${convertToDisplay(shot.dose, 'weight')} â†’ ${convertToDisplay(shot.actualVolume, 'weight')}` :
            `${shot.dose}g â†’ ${shot.actualVolume || '--'}g`;
        
        const tasteDisplay = shot.taste && shot.taste !== 'none' ? 
            `<div class="shot-item-taste">${shot.taste}</div>` : 
            `<div class="rate-badge">RATE</div>`;
        
        entry.innerHTML = `
            <div class="shot-item-info">
                <div class="shot-item-main">
                    ${volumeDisplay} (${shot.actualTime || '--'}s)
                </div>
                <div class="shot-item-sub">
                    Grind: ${shot.grind} â€¢ ${shot.fullTimestamp} ${confidenceIcon}
                </div>
            </div>
            <div class="shot-item-score" style="color: ${scoreColor};">
                ${shot.score}%
                ${tasteDisplay}
            </div>
        `;
        
        container.appendChild(entry);
    });
}

function updatePersonalBenchmarks() {
    const shots = brewmieData.shots;
    const container = document.getElementById('personal-benchmarks');
    
    if (shots.length < 10) {
        const remaining = 10 - shots.length;
        container.innerHTML = `<div class="empty-state">${remaining} more shots needed for benchmarks</div>`;
        return;
    }
    
    const avgScore = Math.round(shots.reduce((sum, s) => sum + s.score, 0) / shots.length);
    const bestConsecutive = calculateBestStreak(shots);
    const avgConfidence = Math.round(shots.reduce((sum, s) => sum + (s.recommendationConfidence || 0.5), 0) / shots.length * 100);
    
    container.innerHTML = `
        <div class="benchmark-list">
            <div class="benchmark-item">â€¢ Your average: ${avgScore}% accuracy</div>
            <div class="benchmark-item">â€¢ Best streak: ${bestConsecutive} consecutive shots</div>
            <div class="benchmark-item">â€¢ Algorithm confidence: ${avgConfidence}%</div>
        </div>
    `;
}

function calculateBestStreak(shots) {
    let maxStreak = 0;
    let currentStreak = 0;
    
    shots.reverse().forEach(shot => {
        if (shot.score >= 85) {
            currentStreak++;
            maxStreak = Math.max(maxStreak, currentStreak);
        } else {
            currentStreak = 0;
        }
    });
    
    shots.reverse();
    return maxStreak;
}

// Clear Functions
function clearRecentPerformance() {
    showConfirm('Clear all shot history? This cannot be undone.', () => {
        brewmieData.shots = [];
        saveData();
        updateInsights();
        updateShotHistory();
    });
}

function clearPersonalBenchmarks() {
    showConfirm('Reset all personal benchmarks and learning data? This cannot be undone.', () => {
        brewmieData.personalWeights.tastelearning = {};
        brewmieData.personalWeights.confidenceScore = 50;
        saveData();
        updatePersonalBenchmarks();
    });
}

function resetAllData() {
    showConfirm('This will delete all shots, settings, and learning data permanently. Are you sure?', () => {
        showConfirm('This cannot be undone. Continue?', () => {
            localStorage.removeItem('brewmieData');
            location.reload();
        });
    });
}

// Data Management
function saveData() {
    try {
        localStorage.setItem('brewmieData', JSON.stringify(brewmieData));
        
        // Sync to cloud in background (don't wait)
        if (currentUserId) {
            if (isSignedIn) {
                // Full user data sync for signed-in users
                syncUserDataToCloud();
            }
            // Anonymous shot sync for ML
            syncToCloud();
        }
        
    } catch (error) {
        if (error.name === 'QuotaExceededError') {
            brewmieData.shots = brewmieData.shots.slice(0, 30);
            localStorage.setItem('brewmieData', JSON.stringify(brewmieData));
        } else {
            console.error('Save failed:', error);
        }
    }
}

function loadData() {
    try {
        const saved = localStorage.getItem('brewmieData');
        if (saved) {
            const loaded = JSON.parse(saved);
            brewmieData = { ...brewmieData, ...loaded };
            
            // Ensure all new properties exist
            if (!brewmieData.personalWeights.tastelearning) brewmieData.personalWeights.tastelearning = {};
            if (brewmieData.tampLevel === undefined) brewmieData.tampLevel = 1;
            if (brewmieData.springPressure === undefined) brewmieData.springPressure = 16;
            if (brewmieData.springMin === undefined) brewmieData.springMin = 0;
            if (brewmieData.springMax === undefined) brewmieData.springMax = 99;
            if (brewmieData.autoPressure === undefined) brewmieData.autoPressure = 15;
            if (brewmieData.autoMin === undefined) brewmieData.autoMin = 0;
            if (brewmieData.autoMax === undefined) brewmieData.autoMax = 30;
            if (!brewmieData.setupReminderDismissed) brewmieData.setupReminderDismissed = null;
            if (!brewmieData.maintenanceAlertsDismissed) brewmieData.maintenanceAlertsDismissed = {};
            if (!brewmieData.maintenance.shotCounts) {
                brewmieData.maintenance.shotCounts = {
                    sinceFilter: 0,
                    sinceDescale: 0,
                    sinceFlush: 0
                };
            }
            if (!brewmieData.algorithmVersion) brewmieData.algorithmVersion = '3.4';
            if (!brewmieData.validationFlags) brewmieData.validationFlags = [];
        }
    } catch (error) {
        console.error('Load failed:', error);
    }
}

function exportData() {
    try {
        const exportData = {
            ...brewmieData,
            exportDate: new Date().toISOString(),
            version: '3.4'
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(dataBlob);
        link.download = `brewmie-insights-${new Date().toISOString().split('T')[0]}.json`;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        showAlert('Insights exported successfully!', 'success');
    } catch (error) {
        console.error('Export failed:', error);
        showAlert('Export failed. Please try again.', 'error');
    }
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if (!importedData.machine || !importedData.shots) {
                throw new Error('Invalid data format');
            }
            
            brewmieData.shots = [...(importedData.shots || []), ...brewmieData.shots];
            brewmieData.machine = importedData.machine || brewmieData.machine;
            
            const uniqueShots = [];
            const seenIds = new Set();
            brewmieData.shots.forEach(shot => {
                if (!seenIds.has(shot.id)) {
                    seenIds.add(shot.id);
                    uniqueShots.push(shot);
                }
            });
            brewmieData.shots = uniqueShots.slice(0, 100);
            
            saveData();
            updateInsights();
            showAlert('Insights imported successfully!', 'success');
            
        } catch (error) {
            console.error('Import failed:', error);
            showAlert('Import failed: Invalid data format', 'error');
        }
    };
    
    reader.readAsText(file);
    event.target.value = '';
}

// Modal Functions for Footer
function openSupportModal() {
    const modal = document.createElement('div');
    modal.className = 'app-modal-wrapper';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="app-modal info" style="max-width: 360px;">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 700;">Support Lazy Sous â¤ï¸</h3>
            <div style="text-align: center;">
                <p style="font-size: 14px; line-height: 1.6; margin-bottom: 20px;">
                    Love Brewmie? We love you!<br>
                    Chef runs on tips and caffeine. Your support keeps us buzzing.
                </p>
                <a href="https://www.buymeacoffee.com/lazysous" target="_blank" style="
                    background: var(--accent-green);
                    color: var(--white);
                    border: none;
                    padding: 12px 24px;
                    border-radius: 10px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    text-decoration: none;
                    transition: all 0.2s;
                ">
                    â˜• Buy Chef a coffee
                </a>
                <p style="font-size: 12px; color: var(--text-tertiary); margin-top: 20px; font-style: italic;">
                    Thank you ðŸ™
                </p>
            </div>
            <button onclick="this.closest('.app-modal-wrapper').remove()" style="margin-top: 20px; width: 100%; background: var(--grey-light); color: white; border: none; padding: 10px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                Close
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

function openPrivacyModal() {
    const modal = document.createElement('div');
    modal.className = 'app-modal-wrapper';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="this.parentElement.remove()"></div>
        <div class="app-modal info" style="max-width: 400px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 16px; font-size: 18px; font-weight: 700;">Privacy ðŸ¥¸</h3>
            
            <div style="font-size: 13px; line-height: 1.6; color: var(--text-secondary);">
                <p style="font-weight: 600; margin-bottom: 10px;">We share your coffee data (anonymously).</p>
                <p>Your shot parameters, scores, and taste ratings are anonymously shared to improve ML recommendations for everyone. No personal info is attached - just brewing data. Your settings, bean profiles, and detailed history stay on your device.</p>
                
                <p style="font-weight: 600; margin-top: 15px; margin-bottom: 10px;">What's local vs shared.</p>
                <p>Local (your device only): Machine settings, bean profiles, detailed shot history, personal preferences.<br>
                Shared (anonymous): Grind, dose, time, volume, score, taste rating, humidity, temperature.</p>
                
                <p style="font-weight: 600; margin-top: 15px; margin-bottom: 10px;">If you contact us, we'll have your email.</p>
                <p>We'll only use it to reply. No marketing without your say-so.</p>
                
                <p style="font-weight: 600; margin-top: 15px; margin-bottom: 10px;">How our hosting works.</p>
                <p>Supabase hosts our anonymous brewing database. They may log basic technical info to keep the service running. We don't use those logs.</p>
                
                <p style="font-weight: 600; margin-top: 15px; margin-bottom: 10px;">No trackers.</p>
                <p>We don't run ads or cross-site analytics. The app uses local storage so your settings persist.</p>
                
                <p style="font-weight: 600; margin-top: 15px; margin-bottom: 10px;">Security.</p>
                <p>Anonymous brewing data is stored securely in Supabase. Your personal settings never leave your device.</p>
                
                <p style="font-weight: 600; margin-top: 15px; margin-bottom: 10px;">Want to opt out?</p>
                <p>Clear your browser data to remove all local settings. Note: This won't remove anonymous shots already contributed to community learning.</p>
                
                <p style="font-weight: 600; margin-top: 15px; margin-bottom: 10px;">Changes.</p>
                <p>If our offering changes, we'll update this notice and post a new effective date below.</p>
                
                <p style="font-weight: 600; margin-top: 15px; margin-bottom: 10px;">Contact.</p>
                <p>Questions? Write to <a href="mailto:chef@lazysous.app" style="color: var(--accent-green);">chef@lazysous.app</a></p>
                
                <p style="margin-top: 15px; font-size: 11px; font-style: italic;">
                    Effective date: ${new Date().toLocaleDateString('en-AU', { day: 'numeric', month: 'long', year: 'numeric' })}
                </p>
            </div>
            
            <button onclick="this.closest('.app-modal-wrapper').remove()" style="margin-top: 20px; width: 100%; background: var(--grey-light); color: white; border: none; padding: 10px; border-radius: 6px; font-size: 12px; cursor: pointer;">
                Close
            </button>
        </div>
    `;
    document.body.appendChild(modal);
}

// Initialize Application
document.addEventListener('DOMContentLoaded', async () => {
    loadData();
    
    // Initialize Google Auth and cloud sync
    await initializeGoogleAuth();
    
    // Set up machine profile first
    updateMachineProfile();
    
    // Initialize tamper settings
    if (brewmieData.tampType === 'spring') {
        document.getElementById('manual-tamp-control').style.display = 'none';
        document.getElementById('spring-tamp-control').style.display = 'flex';
        document.getElementById('auto-tamp-control').style.display = 'none';
        const springInput = document.getElementById('spring-input');
        if (springInput) {
            springInput.value = brewmieData.springPressure;
            springInput.min = brewmieData.springMin;
            springInput.max = brewmieData.springMax;
        }
        document.getElementById('tamp-adjust').textContent = brewmieData.springPressure;
    } else if (brewmieData.tampType === 'automatic') {
        document.getElementById('manual-tamp-control').style.display = 'none';
        document.getElementById('spring-tamp-control').style.display = 'none';
        document.getElementById('auto-tamp-control').style.display = 'flex';
        document.getElementById('auto-tamp-display').textContent = brewmieData.autoPressure;
        document.getElementById('tamp-adjust').textContent = brewmieData.autoPressure;
    } else {
        document.getElementById('manual-tamp-control').style.display = 'flex';
        document.getElementById('spring-tamp-control').style.display = 'none';
        document.getElementById('auto-tamp-control').style.display = 'none';
        document.getElementById('tamp-display').textContent = TAMP_SYMBOLS[brewmieData.tampLevel];
        document.getElementById('tamp-adjust').textContent = TAMP_SYMBOLS[1];
    }
    
    // Load weather with proper error handling
    await loadWeather();
    
    updateWelcomeMessage();
    loadInputSettings();
    updateTargets();
    updateInsights();
    updateSessionLabel();
    checkSetupReminder();
    checkMaintenanceAlerts();
    updateMaintenanceNotes();
    
    // Initialize roast date if not set
    const roastDateInput = document.getElementById('roast-date');
    if (roastDateInput) {
        if (!brewmieData.beans.roastDate) {
            const twoWeeksAgo = new Date();
            twoWeeksAgo.setDate(twoWeeksAgo.getDate() - 14);
            roastDateInput.value = twoWeeksAgo.toISOString().split('T')[0];
            brewmieData.beans.roastDate = roastDateInput.value;
        } else {
            roastDateInput.value = brewmieData.beans.roastDate;
        }
    }
    updateRoastAge();
    
    // Setup event listeners for all input changes
    const inputIds = ['shot-temp', 'bean-brand', 'bean-type', 'roast-date', 'roast-select', 
                      'filter-date', 'descale-date', 'flush-date', 'basket-size', 'basket-type', 
                      'spring-min', 'spring-max', 'auto-min', 'auto-max'];
    inputIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', (e) => {
                if (id === 'shot-temp') {
                    brewmieData.machine.shotTemp = parseInt(e.target.value) || 93;
                } else if (id === 'bean-brand') {
                    brewmieData.beans.brand = e.target.value;
                } else if (id === 'bean-type') {
                    brewmieData.beans.type = e.target.value;
                } else if (id === 'roast-date') {
                    brewmieData.beans.roastDate = e.target.value;
                    checkSetupReminder();
                } else if (id === 'roast-select') {
                    brewmieData.beans.roastLevel = e.target.value;
                } else if (id === 'basket-size') {
                    brewmieData.machine.basketSize = e.target.value;
                    updateMachineProfile();
                } else if (id === 'basket-type') {
                    brewmieData.machine.basketType = e.target.value;
                } else if (id === 'spring-min') {
                    brewmieData.springMin = parseInt(e.target.value) || 0;
                    const springInput = document.getElementById('spring-input');
                    if (springInput) springInput.min = brewmieData.springMin;
                } else if (id === 'spring-max') {
                    brewmieData.springMax = parseInt(e.target.value) || 99;
                    const springInput = document.getElementById('spring-input');
                    if (springInput) springInput.max = brewmieData.springMax;
                } else if (id === 'auto-min') {
                    brewmieData.autoMin = parseInt(e.target.value) || 0;
                } else if (id === 'auto-max') {
                    brewmieData.autoMax = parseInt(e.target.value) || 30;
                } else if (id.includes('date')) {
                    const type = id.replace('-date', '');
                    brewmieData.maintenance[`last${type.charAt(0).toUpperCase() + type.slice(1)}`] = e.target.value;
                    // Reset shot count
                    brewmieData.maintenance.shotCounts[`since${type.charAt(0).toUpperCase() + type.slice(1)}`] = 0;
                    checkSetupReminder();
                    checkMaintenanceAlerts();
                    updateMaintenanceNotes();
                }
                
                updateTargets();
                saveData();
            });
        }
    });
    
    // Load saved values into setup fields
    if (brewmieData.machine.brand) {
        document.getElementById('machine-brand').value = brewmieData.machine.brand;
        updateMachineModels();
        setTimeout(() => {
            if (brewmieData.machine.model) {
                document.getElementById('machine-model').value = brewmieData.machine.model;
            }
        }, 100);
    }
    
    if (brewmieData.machine.basketSize) {
        document.getElementById('basket-size').value = brewmieData.machine.basketSize;
    }
    
    if (brewmieData.machine.basketType) {
        document.getElementById('basket-type').value = brewmieData.machine.basketType;
    }
    
    if (brewmieData.machine.shotTemp) {
        document.getElementById('shot-temp').value = brewmieData.machine.shotTemp;
    }
    
    if (brewmieData.beans.brand) {
        document.getElementById('bean-brand').value = brewmieData.beans.brand;
    }
    
    if (brewmieData.beans.type) {
        document.getElementById('bean-type').value = brewmieData.beans.type;
    }
    
    if (brewmieData.beans.roastLevel) {
        document.getElementById('roast-select').value = brewmieData.beans.roastLevel;
    }
    
    if (brewmieData.maintenance.lastFilter) {
        document.getElementById('filter-date').value = brewmieData.maintenance.lastFilter;
    }
    
    if (brewmieData.maintenance.lastDescale) {
        document.getElementById('descale-date').value = brewmieData.maintenance.lastDescale;
    }
    
    if (brewmieData.maintenance.lastFlush) {
        document.getElementById('flush-date').value = brewmieData.maintenance.lastFlush;
    }
    
    // Initialize tamp type
    if (brewmieData.tampType) {
        selectTampType(brewmieData.tampType);
    }
    
    // Load spring tamper settings
    if (brewmieData.springMin !== undefined) {
        document.getElementById('spring-min').value = brewmieData.springMin;
        const springInput = document.getElementById('spring-input');
        if (springInput) springInput.min = brewmieData.springMin;
    }
    
    if (brewmieData.springMax !== undefined) {
        document.getElementById('spring-max').value = brewmieData.springMax;
        const springInput = document.getElementById('spring-input');
        if (springInput) springInput.max = brewmieData.springMax;
    }
    
    if (brewmieData.springPressure !== undefined) {
        const springInput = document.getElementById('spring-input');
        if (springInput) springInput.value = brewmieData.springPressure;
    }
    
    // Load automatic tamper settings
    if (brewmieData.autoMin !== undefined) {
        document.getElementById('auto-min').value = brewmieData.autoMin;
    }
    
    if (brewmieData.autoMax !== undefined) {
        document.getElementById('auto-max').value = brewmieData.autoMax;
    }
    
    if (brewmieData.autoPressure !== undefined && brewmieData.tampType === 'automatic') {
        document.getElementById('auto-tamp-display').textContent = brewmieData.autoPressure;
    }
    
    // Initialize units
    if (brewmieData.units) {
        toggleUnits(brewmieData.units);
    }
    
    // Set initial phase
    setBrewingPhase('pre-brew');
    
    // Add click handler for manual weather refresh
    document.getElementById('weather-strip').addEventListener('click', () => {
        loadWeather();
    });
    
    // Regular updates
    setInterval(updateWelcomeMessage, 60000);
    setInterval(loadWeather, 600000);
});
</script>
</body>
</html>
